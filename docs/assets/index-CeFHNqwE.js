(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))s(l);new MutationObserver(l=>{for(const x of l)if(x.type==="childList")for(const y of x.addedNodes)y.tagName==="LINK"&&y.rel==="modulepreload"&&s(y)}).observe(document,{childList:!0,subtree:!0});function r(l){const x={};return l.integrity&&(x.integrity=l.integrity),l.referrerPolicy&&(x.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?x.credentials="include":l.crossOrigin==="anonymous"?x.credentials="omit":x.credentials="same-origin",x}function s(l){if(l.ep)return;l.ep=!0;const x=r(l);fetch(l.href,x)}})();var Nn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ln(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}function Mn(a){if(a.__esModule)return a;var n=a.default;if(typeof n=="function"){var r=function s(){return this instanceof s?Reflect.construct(n,arguments,this.constructor):n.apply(this,arguments)};r.prototype=n.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(a).forEach(function(s){var l=Object.getOwnPropertyDescriptor(a,s);Object.defineProperty(r,s,l.get?l:{enumerable:!0,get:function(){return a[s]}})}),r}function Tn(a){throw new Error('Could not dynamically require "'+a+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var xn={exports:{}};const Kn={},Un=Object.freeze(Object.defineProperty({__proto__:null,default:Kn},Symbol.toStringTag,{value:"Module"})),Pn=Mn(Un);(function(a){(function(n){var r=function(t){var f,o=new Float64Array(16);if(t)for(f=0;f<t.length;f++)o[f]=t[f];return o},s=function(){throw new Error("no PRNG")},l=new Uint8Array(16),x=new Uint8Array(32);x[0]=9;var y=r(),E=r([1]),A=r([56129,1]),U=r([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),w=r([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),M=r([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),_=r([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),V=r([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function ae(t,f,o,e){t[f]=o>>24&255,t[f+1]=o>>16&255,t[f+2]=o>>8&255,t[f+3]=o&255,t[f+4]=e>>24&255,t[f+5]=e>>16&255,t[f+6]=e>>8&255,t[f+7]=e&255}function $(t,f,o,e,c){var d,u=0;for(d=0;d<c;d++)u|=t[f+d]^o[e+d];return(1&u-1>>>8)-1}function ee(t,f,o,e){return $(t,f,o,e,16)}function he(t,f,o,e){return $(t,f,o,e,32)}function se(t,f,o,e){for(var c=e[0]&255|(e[1]&255)<<8|(e[2]&255)<<16|(e[3]&255)<<24,d=o[0]&255|(o[1]&255)<<8|(o[2]&255)<<16|(o[3]&255)<<24,u=o[4]&255|(o[5]&255)<<8|(o[6]&255)<<16|(o[7]&255)<<24,m=o[8]&255|(o[9]&255)<<8|(o[10]&255)<<16|(o[11]&255)<<24,C=o[12]&255|(o[13]&255)<<8|(o[14]&255)<<16|(o[15]&255)<<24,O=e[4]&255|(e[5]&255)<<8|(e[6]&255)<<16|(e[7]&255)<<24,B=f[0]&255|(f[1]&255)<<8|(f[2]&255)<<16|(f[3]&255)<<24,re=f[4]&255|(f[5]&255)<<8|(f[6]&255)<<16|(f[7]&255)<<24,L=f[8]&255|(f[9]&255)<<8|(f[10]&255)<<16|(f[11]&255)<<24,q=f[12]&255|(f[13]&255)<<8|(f[14]&255)<<16|(f[15]&255)<<24,R=e[8]&255|(e[9]&255)<<8|(e[10]&255)<<16|(e[11]&255)<<24,H=o[16]&255|(o[17]&255)<<8|(o[18]&255)<<16|(o[19]&255)<<24,z=o[20]&255|(o[21]&255)<<8|(o[22]&255)<<16|(o[23]&255)<<24,Y=o[24]&255|(o[25]&255)<<8|(o[26]&255)<<16|(o[27]&255)<<24,k=o[28]&255|(o[29]&255)<<8|(o[30]&255)<<16|(o[31]&255)<<24,F=e[12]&255|(e[13]&255)<<8|(e[14]&255)<<16|(e[15]&255)<<24,T=c,j=d,N=u,K=m,P=C,I=O,h=B,p=re,v=L,b=q,g=R,S=H,D=z,J=Y,Z=k,G=F,i,X=0;X<20;X+=2)i=T+D|0,P^=i<<7|i>>>25,i=P+T|0,v^=i<<9|i>>>23,i=v+P|0,D^=i<<13|i>>>19,i=D+v|0,T^=i<<18|i>>>14,i=I+j|0,b^=i<<7|i>>>25,i=b+I|0,J^=i<<9|i>>>23,i=J+b|0,j^=i<<13|i>>>19,i=j+J|0,I^=i<<18|i>>>14,i=g+h|0,Z^=i<<7|i>>>25,i=Z+g|0,N^=i<<9|i>>>23,i=N+Z|0,h^=i<<13|i>>>19,i=h+N|0,g^=i<<18|i>>>14,i=G+S|0,K^=i<<7|i>>>25,i=K+G|0,p^=i<<9|i>>>23,i=p+K|0,S^=i<<13|i>>>19,i=S+p|0,G^=i<<18|i>>>14,i=T+K|0,j^=i<<7|i>>>25,i=j+T|0,N^=i<<9|i>>>23,i=N+j|0,K^=i<<13|i>>>19,i=K+N|0,T^=i<<18|i>>>14,i=I+P|0,h^=i<<7|i>>>25,i=h+I|0,p^=i<<9|i>>>23,i=p+h|0,P^=i<<13|i>>>19,i=P+p|0,I^=i<<18|i>>>14,i=g+b|0,S^=i<<7|i>>>25,i=S+g|0,v^=i<<9|i>>>23,i=v+S|0,b^=i<<13|i>>>19,i=b+v|0,g^=i<<18|i>>>14,i=G+Z|0,D^=i<<7|i>>>25,i=D+G|0,J^=i<<9|i>>>23,i=J+D|0,Z^=i<<13|i>>>19,i=Z+J|0,G^=i<<18|i>>>14;T=T+c|0,j=j+d|0,N=N+u|0,K=K+m|0,P=P+C|0,I=I+O|0,h=h+B|0,p=p+re|0,v=v+L|0,b=b+q|0,g=g+R|0,S=S+H|0,D=D+z|0,J=J+Y|0,Z=Z+k|0,G=G+F|0,t[0]=T>>>0&255,t[1]=T>>>8&255,t[2]=T>>>16&255,t[3]=T>>>24&255,t[4]=j>>>0&255,t[5]=j>>>8&255,t[6]=j>>>16&255,t[7]=j>>>24&255,t[8]=N>>>0&255,t[9]=N>>>8&255,t[10]=N>>>16&255,t[11]=N>>>24&255,t[12]=K>>>0&255,t[13]=K>>>8&255,t[14]=K>>>16&255,t[15]=K>>>24&255,t[16]=P>>>0&255,t[17]=P>>>8&255,t[18]=P>>>16&255,t[19]=P>>>24&255,t[20]=I>>>0&255,t[21]=I>>>8&255,t[22]=I>>>16&255,t[23]=I>>>24&255,t[24]=h>>>0&255,t[25]=h>>>8&255,t[26]=h>>>16&255,t[27]=h>>>24&255,t[28]=p>>>0&255,t[29]=p>>>8&255,t[30]=p>>>16&255,t[31]=p>>>24&255,t[32]=v>>>0&255,t[33]=v>>>8&255,t[34]=v>>>16&255,t[35]=v>>>24&255,t[36]=b>>>0&255,t[37]=b>>>8&255,t[38]=b>>>16&255,t[39]=b>>>24&255,t[40]=g>>>0&255,t[41]=g>>>8&255,t[42]=g>>>16&255,t[43]=g>>>24&255,t[44]=S>>>0&255,t[45]=S>>>8&255,t[46]=S>>>16&255,t[47]=S>>>24&255,t[48]=D>>>0&255,t[49]=D>>>8&255,t[50]=D>>>16&255,t[51]=D>>>24&255,t[52]=J>>>0&255,t[53]=J>>>8&255,t[54]=J>>>16&255,t[55]=J>>>24&255,t[56]=Z>>>0&255,t[57]=Z>>>8&255,t[58]=Z>>>16&255,t[59]=Z>>>24&255,t[60]=G>>>0&255,t[61]=G>>>8&255,t[62]=G>>>16&255,t[63]=G>>>24&255}function ve(t,f,o,e){for(var c=e[0]&255|(e[1]&255)<<8|(e[2]&255)<<16|(e[3]&255)<<24,d=o[0]&255|(o[1]&255)<<8|(o[2]&255)<<16|(o[3]&255)<<24,u=o[4]&255|(o[5]&255)<<8|(o[6]&255)<<16|(o[7]&255)<<24,m=o[8]&255|(o[9]&255)<<8|(o[10]&255)<<16|(o[11]&255)<<24,C=o[12]&255|(o[13]&255)<<8|(o[14]&255)<<16|(o[15]&255)<<24,O=e[4]&255|(e[5]&255)<<8|(e[6]&255)<<16|(e[7]&255)<<24,B=f[0]&255|(f[1]&255)<<8|(f[2]&255)<<16|(f[3]&255)<<24,re=f[4]&255|(f[5]&255)<<8|(f[6]&255)<<16|(f[7]&255)<<24,L=f[8]&255|(f[9]&255)<<8|(f[10]&255)<<16|(f[11]&255)<<24,q=f[12]&255|(f[13]&255)<<8|(f[14]&255)<<16|(f[15]&255)<<24,R=e[8]&255|(e[9]&255)<<8|(e[10]&255)<<16|(e[11]&255)<<24,H=o[16]&255|(o[17]&255)<<8|(o[18]&255)<<16|(o[19]&255)<<24,z=o[20]&255|(o[21]&255)<<8|(o[22]&255)<<16|(o[23]&255)<<24,Y=o[24]&255|(o[25]&255)<<8|(o[26]&255)<<16|(o[27]&255)<<24,k=o[28]&255|(o[29]&255)<<8|(o[30]&255)<<16|(o[31]&255)<<24,F=e[12]&255|(e[13]&255)<<8|(e[14]&255)<<16|(e[15]&255)<<24,T=c,j=d,N=u,K=m,P=C,I=O,h=B,p=re,v=L,b=q,g=R,S=H,D=z,J=Y,Z=k,G=F,i,X=0;X<20;X+=2)i=T+D|0,P^=i<<7|i>>>25,i=P+T|0,v^=i<<9|i>>>23,i=v+P|0,D^=i<<13|i>>>19,i=D+v|0,T^=i<<18|i>>>14,i=I+j|0,b^=i<<7|i>>>25,i=b+I|0,J^=i<<9|i>>>23,i=J+b|0,j^=i<<13|i>>>19,i=j+J|0,I^=i<<18|i>>>14,i=g+h|0,Z^=i<<7|i>>>25,i=Z+g|0,N^=i<<9|i>>>23,i=N+Z|0,h^=i<<13|i>>>19,i=h+N|0,g^=i<<18|i>>>14,i=G+S|0,K^=i<<7|i>>>25,i=K+G|0,p^=i<<9|i>>>23,i=p+K|0,S^=i<<13|i>>>19,i=S+p|0,G^=i<<18|i>>>14,i=T+K|0,j^=i<<7|i>>>25,i=j+T|0,N^=i<<9|i>>>23,i=N+j|0,K^=i<<13|i>>>19,i=K+N|0,T^=i<<18|i>>>14,i=I+P|0,h^=i<<7|i>>>25,i=h+I|0,p^=i<<9|i>>>23,i=p+h|0,P^=i<<13|i>>>19,i=P+p|0,I^=i<<18|i>>>14,i=g+b|0,S^=i<<7|i>>>25,i=S+g|0,v^=i<<9|i>>>23,i=v+S|0,b^=i<<13|i>>>19,i=b+v|0,g^=i<<18|i>>>14,i=G+Z|0,D^=i<<7|i>>>25,i=D+G|0,J^=i<<9|i>>>23,i=J+D|0,Z^=i<<13|i>>>19,i=Z+J|0,G^=i<<18|i>>>14;t[0]=T>>>0&255,t[1]=T>>>8&255,t[2]=T>>>16&255,t[3]=T>>>24&255,t[4]=I>>>0&255,t[5]=I>>>8&255,t[6]=I>>>16&255,t[7]=I>>>24&255,t[8]=g>>>0&255,t[9]=g>>>8&255,t[10]=g>>>16&255,t[11]=g>>>24&255,t[12]=G>>>0&255,t[13]=G>>>8&255,t[14]=G>>>16&255,t[15]=G>>>24&255,t[16]=h>>>0&255,t[17]=h>>>8&255,t[18]=h>>>16&255,t[19]=h>>>24&255,t[20]=p>>>0&255,t[21]=p>>>8&255,t[22]=p>>>16&255,t[23]=p>>>24&255,t[24]=v>>>0&255,t[25]=v>>>8&255,t[26]=v>>>16&255,t[27]=v>>>24&255,t[28]=b>>>0&255,t[29]=b>>>8&255,t[30]=b>>>16&255,t[31]=b>>>24&255}function ge(t,f,o,e){se(t,f,o,e)}function pe(t,f,o,e){ve(t,f,o,e)}var Ne=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function Dt(t,f,o,e,c,d,u){var m=new Uint8Array(16),C=new Uint8Array(64),O,B;for(B=0;B<16;B++)m[B]=0;for(B=0;B<8;B++)m[B]=d[B];for(;c>=64;){for(ge(C,m,u,Ne),B=0;B<64;B++)t[f+B]=o[e+B]^C[B];for(O=1,B=8;B<16;B++)O=O+(m[B]&255)|0,m[B]=O&255,O>>>=8;c-=64,f+=64,e+=64}if(c>0)for(ge(C,m,u,Ne),B=0;B<c;B++)t[f+B]=o[e+B]^C[B];return 0}function $t(t,f,o,e,c){var d=new Uint8Array(16),u=new Uint8Array(64),m,C;for(C=0;C<16;C++)d[C]=0;for(C=0;C<8;C++)d[C]=e[C];for(;o>=64;){for(ge(u,d,c,Ne),C=0;C<64;C++)t[f+C]=u[C];for(m=1,C=8;C<16;C++)m=m+(d[C]&255)|0,d[C]=m&255,m>>>=8;o-=64,f+=64}if(o>0)for(ge(u,d,c,Ne),C=0;C<o;C++)t[f+C]=u[C];return 0}function qt(t,f,o,e,c){var d=new Uint8Array(32);pe(d,e,c,Ne);for(var u=new Uint8Array(8),m=0;m<8;m++)u[m]=e[m+16];return $t(t,f,o,u,d)}function ut(t,f,o,e,c,d,u){var m=new Uint8Array(32);pe(m,d,u,Ne);for(var C=new Uint8Array(8),O=0;O<8;O++)C[O]=d[O+16];return Dt(t,f,o,e,c,C,m)}var ze=function(t){this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.leftover=0,this.fin=0;var f,o,e,c,d,u,m,C;f=t[0]&255|(t[1]&255)<<8,this.r[0]=f&8191,o=t[2]&255|(t[3]&255)<<8,this.r[1]=(f>>>13|o<<3)&8191,e=t[4]&255|(t[5]&255)<<8,this.r[2]=(o>>>10|e<<6)&7939,c=t[6]&255|(t[7]&255)<<8,this.r[3]=(e>>>7|c<<9)&8191,d=t[8]&255|(t[9]&255)<<8,this.r[4]=(c>>>4|d<<12)&255,this.r[5]=d>>>1&8190,u=t[10]&255|(t[11]&255)<<8,this.r[6]=(d>>>14|u<<2)&8191,m=t[12]&255|(t[13]&255)<<8,this.r[7]=(u>>>11|m<<5)&8065,C=t[14]&255|(t[15]&255)<<8,this.r[8]=(m>>>8|C<<8)&8191,this.r[9]=C>>>5&127,this.pad[0]=t[16]&255|(t[17]&255)<<8,this.pad[1]=t[18]&255|(t[19]&255)<<8,this.pad[2]=t[20]&255|(t[21]&255)<<8,this.pad[3]=t[22]&255|(t[23]&255)<<8,this.pad[4]=t[24]&255|(t[25]&255)<<8,this.pad[5]=t[26]&255|(t[27]&255)<<8,this.pad[6]=t[28]&255|(t[29]&255)<<8,this.pad[7]=t[30]&255|(t[31]&255)<<8};ze.prototype.blocks=function(t,f,o){for(var e=this.fin?0:2048,c,d,u,m,C,O,B,re,L,q,R,H,z,Y,k,F,T,j,N,K=this.h[0],P=this.h[1],I=this.h[2],h=this.h[3],p=this.h[4],v=this.h[5],b=this.h[6],g=this.h[7],S=this.h[8],D=this.h[9],J=this.r[0],Z=this.r[1],G=this.r[2],i=this.r[3],X=this.r[4],oe=this.r[5],fe=this.r[6],W=this.r[7],te=this.r[8],ne=this.r[9];o>=16;)c=t[f+0]&255|(t[f+1]&255)<<8,K+=c&8191,d=t[f+2]&255|(t[f+3]&255)<<8,P+=(c>>>13|d<<3)&8191,u=t[f+4]&255|(t[f+5]&255)<<8,I+=(d>>>10|u<<6)&8191,m=t[f+6]&255|(t[f+7]&255)<<8,h+=(u>>>7|m<<9)&8191,C=t[f+8]&255|(t[f+9]&255)<<8,p+=(m>>>4|C<<12)&8191,v+=C>>>1&8191,O=t[f+10]&255|(t[f+11]&255)<<8,b+=(C>>>14|O<<2)&8191,B=t[f+12]&255|(t[f+13]&255)<<8,g+=(O>>>11|B<<5)&8191,re=t[f+14]&255|(t[f+15]&255)<<8,S+=(B>>>8|re<<8)&8191,D+=re>>>5|e,L=0,q=L,q+=K*J,q+=P*(5*ne),q+=I*(5*te),q+=h*(5*W),q+=p*(5*fe),L=q>>>13,q&=8191,q+=v*(5*oe),q+=b*(5*X),q+=g*(5*i),q+=S*(5*G),q+=D*(5*Z),L+=q>>>13,q&=8191,R=L,R+=K*Z,R+=P*J,R+=I*(5*ne),R+=h*(5*te),R+=p*(5*W),L=R>>>13,R&=8191,R+=v*(5*fe),R+=b*(5*oe),R+=g*(5*X),R+=S*(5*i),R+=D*(5*G),L+=R>>>13,R&=8191,H=L,H+=K*G,H+=P*Z,H+=I*J,H+=h*(5*ne),H+=p*(5*te),L=H>>>13,H&=8191,H+=v*(5*W),H+=b*(5*fe),H+=g*(5*oe),H+=S*(5*X),H+=D*(5*i),L+=H>>>13,H&=8191,z=L,z+=K*i,z+=P*G,z+=I*Z,z+=h*J,z+=p*(5*ne),L=z>>>13,z&=8191,z+=v*(5*te),z+=b*(5*W),z+=g*(5*fe),z+=S*(5*oe),z+=D*(5*X),L+=z>>>13,z&=8191,Y=L,Y+=K*X,Y+=P*i,Y+=I*G,Y+=h*Z,Y+=p*J,L=Y>>>13,Y&=8191,Y+=v*(5*ne),Y+=b*(5*te),Y+=g*(5*W),Y+=S*(5*fe),Y+=D*(5*oe),L+=Y>>>13,Y&=8191,k=L,k+=K*oe,k+=P*X,k+=I*i,k+=h*G,k+=p*Z,L=k>>>13,k&=8191,k+=v*J,k+=b*(5*ne),k+=g*(5*te),k+=S*(5*W),k+=D*(5*fe),L+=k>>>13,k&=8191,F=L,F+=K*fe,F+=P*oe,F+=I*X,F+=h*i,F+=p*G,L=F>>>13,F&=8191,F+=v*Z,F+=b*J,F+=g*(5*ne),F+=S*(5*te),F+=D*(5*W),L+=F>>>13,F&=8191,T=L,T+=K*W,T+=P*fe,T+=I*oe,T+=h*X,T+=p*i,L=T>>>13,T&=8191,T+=v*G,T+=b*Z,T+=g*J,T+=S*(5*ne),T+=D*(5*te),L+=T>>>13,T&=8191,j=L,j+=K*te,j+=P*W,j+=I*fe,j+=h*oe,j+=p*X,L=j>>>13,j&=8191,j+=v*i,j+=b*G,j+=g*Z,j+=S*J,j+=D*(5*ne),L+=j>>>13,j&=8191,N=L,N+=K*ne,N+=P*te,N+=I*W,N+=h*fe,N+=p*oe,L=N>>>13,N&=8191,N+=v*X,N+=b*i,N+=g*G,N+=S*Z,N+=D*J,L+=N>>>13,N&=8191,L=(L<<2)+L|0,L=L+q|0,q=L&8191,L=L>>>13,R+=L,K=q,P=R,I=H,h=z,p=Y,v=k,b=F,g=T,S=j,D=N,f+=16,o-=16;this.h[0]=K,this.h[1]=P,this.h[2]=I,this.h[3]=h,this.h[4]=p,this.h[5]=v,this.h[6]=b,this.h[7]=g,this.h[8]=S,this.h[9]=D},ze.prototype.finish=function(t,f){var o=new Uint16Array(10),e,c,d,u;if(this.leftover){for(u=this.leftover,this.buffer[u++]=1;u<16;u++)this.buffer[u]=0;this.fin=1,this.blocks(this.buffer,0,16)}for(e=this.h[1]>>>13,this.h[1]&=8191,u=2;u<10;u++)this.h[u]+=e,e=this.h[u]>>>13,this.h[u]&=8191;for(this.h[0]+=e*5,e=this.h[0]>>>13,this.h[0]&=8191,this.h[1]+=e,e=this.h[1]>>>13,this.h[1]&=8191,this.h[2]+=e,o[0]=this.h[0]+5,e=o[0]>>>13,o[0]&=8191,u=1;u<10;u++)o[u]=this.h[u]+e,e=o[u]>>>13,o[u]&=8191;for(o[9]-=8192,c=(e^1)-1,u=0;u<10;u++)o[u]&=c;for(c=~c,u=0;u<10;u++)this.h[u]=this.h[u]&c|o[u];for(this.h[0]=(this.h[0]|this.h[1]<<13)&65535,this.h[1]=(this.h[1]>>>3|this.h[2]<<10)&65535,this.h[2]=(this.h[2]>>>6|this.h[3]<<7)&65535,this.h[3]=(this.h[3]>>>9|this.h[4]<<4)&65535,this.h[4]=(this.h[4]>>>12|this.h[5]<<1|this.h[6]<<14)&65535,this.h[5]=(this.h[6]>>>2|this.h[7]<<11)&65535,this.h[6]=(this.h[7]>>>5|this.h[8]<<8)&65535,this.h[7]=(this.h[8]>>>8|this.h[9]<<5)&65535,d=this.h[0]+this.pad[0],this.h[0]=d&65535,u=1;u<8;u++)d=(this.h[u]+this.pad[u]|0)+(d>>>16)|0,this.h[u]=d&65535;t[f+0]=this.h[0]>>>0&255,t[f+1]=this.h[0]>>>8&255,t[f+2]=this.h[1]>>>0&255,t[f+3]=this.h[1]>>>8&255,t[f+4]=this.h[2]>>>0&255,t[f+5]=this.h[2]>>>8&255,t[f+6]=this.h[3]>>>0&255,t[f+7]=this.h[3]>>>8&255,t[f+8]=this.h[4]>>>0&255,t[f+9]=this.h[4]>>>8&255,t[f+10]=this.h[5]>>>0&255,t[f+11]=this.h[5]>>>8&255,t[f+12]=this.h[6]>>>0&255,t[f+13]=this.h[6]>>>8&255,t[f+14]=this.h[7]>>>0&255,t[f+15]=this.h[7]>>>8&255},ze.prototype.update=function(t,f,o){var e,c;if(this.leftover){for(c=16-this.leftover,c>o&&(c=o),e=0;e<c;e++)this.buffer[this.leftover+e]=t[f+e];if(o-=c,f+=c,this.leftover+=c,this.leftover<16)return;this.blocks(this.buffer,0,16),this.leftover=0}if(o>=16&&(c=o-o%16,this.blocks(t,f,c),f+=c,o-=c),o){for(e=0;e<o;e++)this.buffer[this.leftover+e]=t[f+e];this.leftover+=o}};function xt(t,f,o,e,c,d){var u=new ze(d);return u.update(o,e,c),u.finish(t,f),0}function Rt(t,f,o,e,c,d){var u=new Uint8Array(16);return xt(u,0,o,e,c,d),ee(t,f,u,0)}function ht(t,f,o,e,c){var d;if(o<32)return-1;for(ut(t,0,f,0,o,e,c),xt(t,16,t,32,o-32,t),d=0;d<16;d++)t[d]=0;return 0}function pt(t,f,o,e,c){var d,u=new Uint8Array(32);if(o<32||(qt(u,0,32,e,c),Rt(f,16,f,32,o-32,u)!==0))return-1;for(ut(t,0,f,0,o,e,c),d=0;d<32;d++)t[d]=0;return 0}function Ie(t,f){var o;for(o=0;o<16;o++)t[o]=f[o]|0}function yt(t){var f,o,e=1;for(f=0;f<16;f++)o=t[f]+e+65535,e=Math.floor(o/65536),t[f]=o-e*65536;t[0]+=e-1+37*(e-1)}function Ke(t,f,o){for(var e,c=~(o-1),d=0;d<16;d++)e=c&(t[d]^f[d]),t[d]^=e,f[d]^=e}function Ue(t,f){var o,e,c,d=r(),u=r();for(o=0;o<16;o++)u[o]=f[o];for(yt(u),yt(u),yt(u),e=0;e<2;e++){for(d[0]=u[0]-65517,o=1;o<15;o++)d[o]=u[o]-65535-(d[o-1]>>16&1),d[o-1]&=65535;d[15]=u[15]-32767-(d[14]>>16&1),c=d[15]>>16&1,d[14]&=65535,Ke(u,d,1-c)}for(o=0;o<16;o++)t[2*o]=u[o]&255,t[2*o+1]=u[o]>>8}function Yt(t,f){var o=new Uint8Array(32),e=new Uint8Array(32);return Ue(o,t),Ue(e,f),he(o,0,e,0)}function Ft(t){var f=new Uint8Array(32);return Ue(f,t),f[0]&1}function bt(t,f){var o;for(o=0;o<16;o++)t[o]=f[2*o]+(f[2*o+1]<<8);t[15]&=32767}function Ae(t,f,o){for(var e=0;e<16;e++)t[e]=f[e]+o[e]}function Ee(t,f,o){for(var e=0;e<16;e++)t[e]=f[e]-o[e]}function Q(t,f,o){var e,c,d=0,u=0,m=0,C=0,O=0,B=0,re=0,L=0,q=0,R=0,H=0,z=0,Y=0,k=0,F=0,T=0,j=0,N=0,K=0,P=0,I=0,h=0,p=0,v=0,b=0,g=0,S=0,D=0,J=0,Z=0,G=0,i=o[0],X=o[1],oe=o[2],fe=o[3],W=o[4],te=o[5],ne=o[6],ue=o[7],ce=o[8],ie=o[9],le=o[10],de=o[11],xe=o[12],ye=o[13],be=o[14],me=o[15];e=f[0],d+=e*i,u+=e*X,m+=e*oe,C+=e*fe,O+=e*W,B+=e*te,re+=e*ne,L+=e*ue,q+=e*ce,R+=e*ie,H+=e*le,z+=e*de,Y+=e*xe,k+=e*ye,F+=e*be,T+=e*me,e=f[1],u+=e*i,m+=e*X,C+=e*oe,O+=e*fe,B+=e*W,re+=e*te,L+=e*ne,q+=e*ue,R+=e*ce,H+=e*ie,z+=e*le,Y+=e*de,k+=e*xe,F+=e*ye,T+=e*be,j+=e*me,e=f[2],m+=e*i,C+=e*X,O+=e*oe,B+=e*fe,re+=e*W,L+=e*te,q+=e*ne,R+=e*ue,H+=e*ce,z+=e*ie,Y+=e*le,k+=e*de,F+=e*xe,T+=e*ye,j+=e*be,N+=e*me,e=f[3],C+=e*i,O+=e*X,B+=e*oe,re+=e*fe,L+=e*W,q+=e*te,R+=e*ne,H+=e*ue,z+=e*ce,Y+=e*ie,k+=e*le,F+=e*de,T+=e*xe,j+=e*ye,N+=e*be,K+=e*me,e=f[4],O+=e*i,B+=e*X,re+=e*oe,L+=e*fe,q+=e*W,R+=e*te,H+=e*ne,z+=e*ue,Y+=e*ce,k+=e*ie,F+=e*le,T+=e*de,j+=e*xe,N+=e*ye,K+=e*be,P+=e*me,e=f[5],B+=e*i,re+=e*X,L+=e*oe,q+=e*fe,R+=e*W,H+=e*te,z+=e*ne,Y+=e*ue,k+=e*ce,F+=e*ie,T+=e*le,j+=e*de,N+=e*xe,K+=e*ye,P+=e*be,I+=e*me,e=f[6],re+=e*i,L+=e*X,q+=e*oe,R+=e*fe,H+=e*W,z+=e*te,Y+=e*ne,k+=e*ue,F+=e*ce,T+=e*ie,j+=e*le,N+=e*de,K+=e*xe,P+=e*ye,I+=e*be,h+=e*me,e=f[7],L+=e*i,q+=e*X,R+=e*oe,H+=e*fe,z+=e*W,Y+=e*te,k+=e*ne,F+=e*ue,T+=e*ce,j+=e*ie,N+=e*le,K+=e*de,P+=e*xe,I+=e*ye,h+=e*be,p+=e*me,e=f[8],q+=e*i,R+=e*X,H+=e*oe,z+=e*fe,Y+=e*W,k+=e*te,F+=e*ne,T+=e*ue,j+=e*ce,N+=e*ie,K+=e*le,P+=e*de,I+=e*xe,h+=e*ye,p+=e*be,v+=e*me,e=f[9],R+=e*i,H+=e*X,z+=e*oe,Y+=e*fe,k+=e*W,F+=e*te,T+=e*ne,j+=e*ue,N+=e*ce,K+=e*ie,P+=e*le,I+=e*de,h+=e*xe,p+=e*ye,v+=e*be,b+=e*me,e=f[10],H+=e*i,z+=e*X,Y+=e*oe,k+=e*fe,F+=e*W,T+=e*te,j+=e*ne,N+=e*ue,K+=e*ce,P+=e*ie,I+=e*le,h+=e*de,p+=e*xe,v+=e*ye,b+=e*be,g+=e*me,e=f[11],z+=e*i,Y+=e*X,k+=e*oe,F+=e*fe,T+=e*W,j+=e*te,N+=e*ne,K+=e*ue,P+=e*ce,I+=e*ie,h+=e*le,p+=e*de,v+=e*xe,b+=e*ye,g+=e*be,S+=e*me,e=f[12],Y+=e*i,k+=e*X,F+=e*oe,T+=e*fe,j+=e*W,N+=e*te,K+=e*ne,P+=e*ue,I+=e*ce,h+=e*ie,p+=e*le,v+=e*de,b+=e*xe,g+=e*ye,S+=e*be,D+=e*me,e=f[13],k+=e*i,F+=e*X,T+=e*oe,j+=e*fe,N+=e*W,K+=e*te,P+=e*ne,I+=e*ue,h+=e*ce,p+=e*ie,v+=e*le,b+=e*de,g+=e*xe,S+=e*ye,D+=e*be,J+=e*me,e=f[14],F+=e*i,T+=e*X,j+=e*oe,N+=e*fe,K+=e*W,P+=e*te,I+=e*ne,h+=e*ue,p+=e*ce,v+=e*ie,b+=e*le,g+=e*de,S+=e*xe,D+=e*ye,J+=e*be,Z+=e*me,e=f[15],T+=e*i,j+=e*X,N+=e*oe,K+=e*fe,P+=e*W,I+=e*te,h+=e*ne,p+=e*ue,v+=e*ce,b+=e*ie,g+=e*le,S+=e*de,D+=e*xe,J+=e*ye,Z+=e*be,G+=e*me,d+=38*j,u+=38*N,m+=38*K,C+=38*P,O+=38*I,B+=38*h,re+=38*p,L+=38*v,q+=38*b,R+=38*g,H+=38*S,z+=38*D,Y+=38*J,k+=38*Z,F+=38*G,c=1,e=d+c+65535,c=Math.floor(e/65536),d=e-c*65536,e=u+c+65535,c=Math.floor(e/65536),u=e-c*65536,e=m+c+65535,c=Math.floor(e/65536),m=e-c*65536,e=C+c+65535,c=Math.floor(e/65536),C=e-c*65536,e=O+c+65535,c=Math.floor(e/65536),O=e-c*65536,e=B+c+65535,c=Math.floor(e/65536),B=e-c*65536,e=re+c+65535,c=Math.floor(e/65536),re=e-c*65536,e=L+c+65535,c=Math.floor(e/65536),L=e-c*65536,e=q+c+65535,c=Math.floor(e/65536),q=e-c*65536,e=R+c+65535,c=Math.floor(e/65536),R=e-c*65536,e=H+c+65535,c=Math.floor(e/65536),H=e-c*65536,e=z+c+65535,c=Math.floor(e/65536),z=e-c*65536,e=Y+c+65535,c=Math.floor(e/65536),Y=e-c*65536,e=k+c+65535,c=Math.floor(e/65536),k=e-c*65536,e=F+c+65535,c=Math.floor(e/65536),F=e-c*65536,e=T+c+65535,c=Math.floor(e/65536),T=e-c*65536,d+=c-1+37*(c-1),c=1,e=d+c+65535,c=Math.floor(e/65536),d=e-c*65536,e=u+c+65535,c=Math.floor(e/65536),u=e-c*65536,e=m+c+65535,c=Math.floor(e/65536),m=e-c*65536,e=C+c+65535,c=Math.floor(e/65536),C=e-c*65536,e=O+c+65535,c=Math.floor(e/65536),O=e-c*65536,e=B+c+65535,c=Math.floor(e/65536),B=e-c*65536,e=re+c+65535,c=Math.floor(e/65536),re=e-c*65536,e=L+c+65535,c=Math.floor(e/65536),L=e-c*65536,e=q+c+65535,c=Math.floor(e/65536),q=e-c*65536,e=R+c+65535,c=Math.floor(e/65536),R=e-c*65536,e=H+c+65535,c=Math.floor(e/65536),H=e-c*65536,e=z+c+65535,c=Math.floor(e/65536),z=e-c*65536,e=Y+c+65535,c=Math.floor(e/65536),Y=e-c*65536,e=k+c+65535,c=Math.floor(e/65536),k=e-c*65536,e=F+c+65535,c=Math.floor(e/65536),F=e-c*65536,e=T+c+65535,c=Math.floor(e/65536),T=e-c*65536,d+=c-1+37*(c-1),t[0]=d,t[1]=u,t[2]=m,t[3]=C,t[4]=O,t[5]=B,t[6]=re,t[7]=L,t[8]=q,t[9]=R,t[10]=H,t[11]=z,t[12]=Y,t[13]=k,t[14]=F,t[15]=T}function Ce(t,f){Q(t,f,f)}function Vt(t,f){var o=r(),e;for(e=0;e<16;e++)o[e]=f[e];for(e=253;e>=0;e--)Ce(o,o),e!==2&&e!==4&&Q(o,o,f);for(e=0;e<16;e++)t[e]=o[e]}function kt(t,f){var o=r(),e;for(e=0;e<16;e++)o[e]=f[e];for(e=250;e>=0;e--)Ce(o,o),e!==1&&Q(o,o,f);for(e=0;e<16;e++)t[e]=o[e]}function He(t,f,o){var e=new Uint8Array(32),c=new Float64Array(80),d,u,m=r(),C=r(),O=r(),B=r(),re=r(),L=r();for(u=0;u<31;u++)e[u]=f[u];for(e[31]=f[31]&127|64,e[0]&=248,bt(c,o),u=0;u<16;u++)C[u]=c[u],B[u]=m[u]=O[u]=0;for(m[0]=B[0]=1,u=254;u>=0;--u)d=e[u>>>3]>>>(u&7)&1,Ke(m,C,d),Ke(O,B,d),Ae(re,m,O),Ee(m,m,O),Ae(O,C,B),Ee(C,C,B),Ce(B,re),Ce(L,m),Q(m,O,m),Q(O,C,re),Ae(re,m,O),Ee(m,m,O),Ce(C,m),Ee(O,B,L),Q(m,O,A),Ae(m,m,B),Q(O,O,m),Q(m,B,L),Q(B,C,c),Ce(C,re),Ke(m,C,d),Ke(O,B,d);for(u=0;u<16;u++)c[u+16]=m[u],c[u+32]=O[u],c[u+48]=C[u],c[u+64]=B[u];var q=c.subarray(32),R=c.subarray(16);return Vt(q,q),Q(R,R,q),Ue(t,R),0}function Je(t,f){return He(t,f,x)}function zt(t,f){return s(f,32),Je(t,f)}function Ge(t,f,o){var e=new Uint8Array(32);return He(e,o,f),pe(t,l,e,Ne)}var Ht=ht,Sn=pt;function Cn(t,f,o,e,c,d){var u=new Uint8Array(32);return Ge(u,c,d),Ht(t,f,o,e,u)}function An(t,f,o,e,c,d){var u=new Uint8Array(32);return Ge(u,c,d),Sn(t,f,o,e,u)}var Jt=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591];function Gt(t,f,o,e){for(var c=new Int32Array(16),d=new Int32Array(16),u,m,C,O,B,re,L,q,R,H,z,Y,k,F,T,j,N,K,P,I,h,p,v,b,g,S,D=t[0],J=t[1],Z=t[2],G=t[3],i=t[4],X=t[5],oe=t[6],fe=t[7],W=f[0],te=f[1],ne=f[2],ue=f[3],ce=f[4],ie=f[5],le=f[6],de=f[7],xe=0;e>=128;){for(P=0;P<16;P++)I=8*P+xe,c[P]=o[I+0]<<24|o[I+1]<<16|o[I+2]<<8|o[I+3],d[P]=o[I+4]<<24|o[I+5]<<16|o[I+6]<<8|o[I+7];for(P=0;P<80;P++)if(u=D,m=J,C=Z,O=G,B=i,re=X,L=oe,q=fe,R=W,H=te,z=ne,Y=ue,k=ce,F=ie,T=le,j=de,h=fe,p=de,v=p&65535,b=p>>>16,g=h&65535,S=h>>>16,h=(i>>>14|ce<<18)^(i>>>18|ce<<14)^(ce>>>9|i<<23),p=(ce>>>14|i<<18)^(ce>>>18|i<<14)^(i>>>9|ce<<23),v+=p&65535,b+=p>>>16,g+=h&65535,S+=h>>>16,h=i&X^~i&oe,p=ce&ie^~ce&le,v+=p&65535,b+=p>>>16,g+=h&65535,S+=h>>>16,h=Jt[P*2],p=Jt[P*2+1],v+=p&65535,b+=p>>>16,g+=h&65535,S+=h>>>16,h=c[P%16],p=d[P%16],v+=p&65535,b+=p>>>16,g+=h&65535,S+=h>>>16,b+=v>>>16,g+=b>>>16,S+=g>>>16,N=g&65535|S<<16,K=v&65535|b<<16,h=N,p=K,v=p&65535,b=p>>>16,g=h&65535,S=h>>>16,h=(D>>>28|W<<4)^(W>>>2|D<<30)^(W>>>7|D<<25),p=(W>>>28|D<<4)^(D>>>2|W<<30)^(D>>>7|W<<25),v+=p&65535,b+=p>>>16,g+=h&65535,S+=h>>>16,h=D&J^D&Z^J&Z,p=W&te^W&ne^te&ne,v+=p&65535,b+=p>>>16,g+=h&65535,S+=h>>>16,b+=v>>>16,g+=b>>>16,S+=g>>>16,q=g&65535|S<<16,j=v&65535|b<<16,h=O,p=Y,v=p&65535,b=p>>>16,g=h&65535,S=h>>>16,h=N,p=K,v+=p&65535,b+=p>>>16,g+=h&65535,S+=h>>>16,b+=v>>>16,g+=b>>>16,S+=g>>>16,O=g&65535|S<<16,Y=v&65535|b<<16,J=u,Z=m,G=C,i=O,X=B,oe=re,fe=L,D=q,te=R,ne=H,ue=z,ce=Y,ie=k,le=F,de=T,W=j,P%16===15)for(I=0;I<16;I++)h=c[I],p=d[I],v=p&65535,b=p>>>16,g=h&65535,S=h>>>16,h=c[(I+9)%16],p=d[(I+9)%16],v+=p&65535,b+=p>>>16,g+=h&65535,S+=h>>>16,N=c[(I+1)%16],K=d[(I+1)%16],h=(N>>>1|K<<31)^(N>>>8|K<<24)^N>>>7,p=(K>>>1|N<<31)^(K>>>8|N<<24)^(K>>>7|N<<25),v+=p&65535,b+=p>>>16,g+=h&65535,S+=h>>>16,N=c[(I+14)%16],K=d[(I+14)%16],h=(N>>>19|K<<13)^(K>>>29|N<<3)^N>>>6,p=(K>>>19|N<<13)^(N>>>29|K<<3)^(K>>>6|N<<26),v+=p&65535,b+=p>>>16,g+=h&65535,S+=h>>>16,b+=v>>>16,g+=b>>>16,S+=g>>>16,c[I]=g&65535|S<<16,d[I]=v&65535|b<<16;h=D,p=W,v=p&65535,b=p>>>16,g=h&65535,S=h>>>16,h=t[0],p=f[0],v+=p&65535,b+=p>>>16,g+=h&65535,S+=h>>>16,b+=v>>>16,g+=b>>>16,S+=g>>>16,t[0]=D=g&65535|S<<16,f[0]=W=v&65535|b<<16,h=J,p=te,v=p&65535,b=p>>>16,g=h&65535,S=h>>>16,h=t[1],p=f[1],v+=p&65535,b+=p>>>16,g+=h&65535,S+=h>>>16,b+=v>>>16,g+=b>>>16,S+=g>>>16,t[1]=J=g&65535|S<<16,f[1]=te=v&65535|b<<16,h=Z,p=ne,v=p&65535,b=p>>>16,g=h&65535,S=h>>>16,h=t[2],p=f[2],v+=p&65535,b+=p>>>16,g+=h&65535,S+=h>>>16,b+=v>>>16,g+=b>>>16,S+=g>>>16,t[2]=Z=g&65535|S<<16,f[2]=ne=v&65535|b<<16,h=G,p=ue,v=p&65535,b=p>>>16,g=h&65535,S=h>>>16,h=t[3],p=f[3],v+=p&65535,b+=p>>>16,g+=h&65535,S+=h>>>16,b+=v>>>16,g+=b>>>16,S+=g>>>16,t[3]=G=g&65535|S<<16,f[3]=ue=v&65535|b<<16,h=i,p=ce,v=p&65535,b=p>>>16,g=h&65535,S=h>>>16,h=t[4],p=f[4],v+=p&65535,b+=p>>>16,g+=h&65535,S+=h>>>16,b+=v>>>16,g+=b>>>16,S+=g>>>16,t[4]=i=g&65535|S<<16,f[4]=ce=v&65535|b<<16,h=X,p=ie,v=p&65535,b=p>>>16,g=h&65535,S=h>>>16,h=t[5],p=f[5],v+=p&65535,b+=p>>>16,g+=h&65535,S+=h>>>16,b+=v>>>16,g+=b>>>16,S+=g>>>16,t[5]=X=g&65535|S<<16,f[5]=ie=v&65535|b<<16,h=oe,p=le,v=p&65535,b=p>>>16,g=h&65535,S=h>>>16,h=t[6],p=f[6],v+=p&65535,b+=p>>>16,g+=h&65535,S+=h>>>16,b+=v>>>16,g+=b>>>16,S+=g>>>16,t[6]=oe=g&65535|S<<16,f[6]=le=v&65535|b<<16,h=fe,p=de,v=p&65535,b=p>>>16,g=h&65535,S=h>>>16,h=t[7],p=f[7],v+=p&65535,b+=p>>>16,g+=h&65535,S+=h>>>16,b+=v>>>16,g+=b>>>16,S+=g>>>16,t[7]=fe=g&65535|S<<16,f[7]=de=v&65535|b<<16,xe+=128,e-=128}return e}function Le(t,f,o){var e=new Int32Array(8),c=new Int32Array(8),d=new Uint8Array(256),u,m=o;for(e[0]=1779033703,e[1]=3144134277,e[2]=1013904242,e[3]=2773480762,e[4]=1359893119,e[5]=2600822924,e[6]=528734635,e[7]=1541459225,c[0]=4089235720,c[1]=2227873595,c[2]=4271175723,c[3]=1595750129,c[4]=2917565137,c[5]=725511199,c[6]=4215389547,c[7]=327033209,Gt(e,c,f,o),o%=128,u=0;u<o;u++)d[u]=f[m-o+u];for(d[o]=128,o=256-128*(o<112?1:0),d[o-9]=0,ae(d,o-8,m/536870912|0,m<<3),Gt(e,c,d,o),u=0;u<8;u++)ae(t,8*u,e[u],c[u]);return 0}function Ze(t,f){var o=r(),e=r(),c=r(),d=r(),u=r(),m=r(),C=r(),O=r(),B=r();Ee(o,t[1],t[0]),Ee(B,f[1],f[0]),Q(o,o,B),Ae(e,t[0],t[1]),Ae(B,f[0],f[1]),Q(e,e,B),Q(c,t[3],f[3]),Q(c,c,w),Q(d,t[2],f[2]),Ae(d,d,d),Ee(u,e,o),Ee(m,d,c),Ae(C,d,c),Ae(O,e,o),Q(t[0],u,m),Q(t[1],O,C),Q(t[2],C,m),Q(t[3],u,O)}function Zt(t,f,o){var e;for(e=0;e<4;e++)Ke(t[e],f[e],o)}function mt(t,f){var o=r(),e=r(),c=r();Vt(c,f[2]),Q(o,f[0],c),Q(e,f[1],c),Ue(t,e),t[31]^=Ft(o)<<7}function gt(t,f,o){var e,c;for(Ie(t[0],y),Ie(t[1],E),Ie(t[2],E),Ie(t[3],y),c=255;c>=0;--c)e=o[c/8|0]>>(c&7)&1,Zt(t,f,e),Ze(f,t),Ze(t,t),Zt(t,f,e)}function We(t,f){var o=[r(),r(),r(),r()];Ie(o[0],M),Ie(o[1],_),Ie(o[2],E),Q(o[3],M,_),gt(t,o,f)}function vt(t,f,o){var e=new Uint8Array(64),c=[r(),r(),r(),r()],d;for(o||s(f,32),Le(e,f,32),e[0]&=248,e[31]&=127,e[31]|=64,We(c,e),mt(t,c),d=0;d<32;d++)f[d+32]=t[d];return 0}var Xe=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function wt(t,f){var o,e,c,d;for(e=63;e>=32;--e){for(o=0,c=e-32,d=e-12;c<d;++c)f[c]+=o-16*f[e]*Xe[c-(e-32)],o=Math.floor((f[c]+128)/256),f[c]-=o*256;f[c]+=o,f[e]=0}for(o=0,c=0;c<32;c++)f[c]+=o-(f[31]>>4)*Xe[c],o=f[c]>>8,f[c]&=255;for(c=0;c<32;c++)f[c]-=o*Xe[c];for(e=0;e<32;e++)f[e+1]+=f[e]>>8,t[e]=f[e]&255}function St(t){var f=new Float64Array(64),o;for(o=0;o<64;o++)f[o]=t[o];for(o=0;o<64;o++)t[o]=0;wt(t,f)}function Wt(t,f,o,e){var c=new Uint8Array(64),d=new Uint8Array(64),u=new Uint8Array(64),m,C,O=new Float64Array(64),B=[r(),r(),r(),r()];Le(c,e,32),c[0]&=248,c[31]&=127,c[31]|=64;var re=o+64;for(m=0;m<o;m++)t[64+m]=f[m];for(m=0;m<32;m++)t[32+m]=c[32+m];for(Le(u,t.subarray(32),o+32),St(u),We(B,u),mt(t,B),m=32;m<64;m++)t[m]=e[m];for(Le(d,t,o+64),St(d),m=0;m<64;m++)O[m]=0;for(m=0;m<32;m++)O[m]=u[m];for(m=0;m<32;m++)for(C=0;C<32;C++)O[m+C]+=d[m]*c[C];return wt(t.subarray(32),O),re}function En(t,f){var o=r(),e=r(),c=r(),d=r(),u=r(),m=r(),C=r();return Ie(t[2],E),bt(t[1],f),Ce(c,t[1]),Q(d,c,U),Ee(c,c,t[2]),Ae(d,t[2],d),Ce(u,d),Ce(m,u),Q(C,m,u),Q(o,C,c),Q(o,o,d),kt(o,o),Q(o,o,c),Q(o,o,d),Q(o,o,d),Q(t[0],o,d),Ce(e,t[0]),Q(e,e,d),Yt(e,c)&&Q(t[0],t[0],V),Ce(e,t[0]),Q(e,e,d),Yt(e,c)?-1:(Ft(t[0])===f[31]>>7&&Ee(t[0],y,t[0]),Q(t[3],t[0],t[1]),0)}function Ct(t,f,o,e){var c,d=new Uint8Array(32),u=new Uint8Array(64),m=[r(),r(),r(),r()],C=[r(),r(),r(),r()];if(o<64||En(C,e))return-1;for(c=0;c<o;c++)t[c]=f[c];for(c=0;c<32;c++)t[c+32]=e[c];if(Le(u,t,o),St(u),gt(m,C,u),We(C,f.subarray(32)),Ze(m,C),mt(d,m),o-=64,he(f,0,d,0)){for(c=0;c<o;c++)t[c]=0;return-1}for(c=0;c<o;c++)t[c]=f[c+64];return o}var At=32,Qe=24,De=32,Pe=16,$e=32,et=32,qe=32,Re=32,Et=32,Xt=Qe,_n=De,In=Pe,Be=64,Me=32,Oe=64,_t=32,It=64;n.lowlevel={crypto_core_hsalsa20:pe,crypto_stream_xor:ut,crypto_stream:qt,crypto_stream_salsa20_xor:Dt,crypto_stream_salsa20:$t,crypto_onetimeauth:xt,crypto_onetimeauth_verify:Rt,crypto_verify_16:ee,crypto_verify_32:he,crypto_secretbox:ht,crypto_secretbox_open:pt,crypto_scalarmult:He,crypto_scalarmult_base:Je,crypto_box_beforenm:Ge,crypto_box_afternm:Ht,crypto_box:Cn,crypto_box_open:An,crypto_box_keypair:zt,crypto_hash:Le,crypto_sign:Wt,crypto_sign_keypair:vt,crypto_sign_open:Ct,crypto_secretbox_KEYBYTES:At,crypto_secretbox_NONCEBYTES:Qe,crypto_secretbox_ZEROBYTES:De,crypto_secretbox_BOXZEROBYTES:Pe,crypto_scalarmult_BYTES:$e,crypto_scalarmult_SCALARBYTES:et,crypto_box_PUBLICKEYBYTES:qe,crypto_box_SECRETKEYBYTES:Re,crypto_box_BEFORENMBYTES:Et,crypto_box_NONCEBYTES:Xt,crypto_box_ZEROBYTES:_n,crypto_box_BOXZEROBYTES:In,crypto_sign_BYTES:Be,crypto_sign_PUBLICKEYBYTES:Me,crypto_sign_SECRETKEYBYTES:Oe,crypto_sign_SEEDBYTES:_t,crypto_hash_BYTES:It,gf:r,D:U,L:Xe,pack25519:Ue,unpack25519:bt,M:Q,A:Ae,S:Ce,Z:Ee,pow2523:kt,add:Ze,set25519:Ie,modL:wt,scalarmult:gt,scalarbase:We};function Qt(t,f){if(t.length!==At)throw new Error("bad key size");if(f.length!==Qe)throw new Error("bad nonce size")}function Bn(t,f){if(t.length!==qe)throw new Error("bad public key size");if(f.length!==Re)throw new Error("bad secret key size")}function we(){for(var t=0;t<arguments.length;t++)if(!(arguments[t]instanceof Uint8Array))throw new TypeError("unexpected type, use Uint8Array")}function en(t){for(var f=0;f<t.length;f++)t[f]=0}n.randomBytes=function(t){var f=new Uint8Array(t);return s(f,t),f},n.secretbox=function(t,f,o){we(t,f,o),Qt(o,f);for(var e=new Uint8Array(De+t.length),c=new Uint8Array(e.length),d=0;d<t.length;d++)e[d+De]=t[d];return ht(c,e,e.length,f,o),c.subarray(Pe)},n.secretbox.open=function(t,f,o){we(t,f,o),Qt(o,f);for(var e=new Uint8Array(Pe+t.length),c=new Uint8Array(e.length),d=0;d<t.length;d++)e[d+Pe]=t[d];return e.length<32||pt(c,e,e.length,f,o)!==0?null:c.subarray(De)},n.secretbox.keyLength=At,n.secretbox.nonceLength=Qe,n.secretbox.overheadLength=Pe,n.scalarMult=function(t,f){if(we(t,f),t.length!==et)throw new Error("bad n size");if(f.length!==$e)throw new Error("bad p size");var o=new Uint8Array($e);return He(o,t,f),o},n.scalarMult.base=function(t){if(we(t),t.length!==et)throw new Error("bad n size");var f=new Uint8Array($e);return Je(f,t),f},n.scalarMult.scalarLength=et,n.scalarMult.groupElementLength=$e,n.box=function(t,f,o,e){var c=n.box.before(o,e);return n.secretbox(t,f,c)},n.box.before=function(t,f){we(t,f),Bn(t,f);var o=new Uint8Array(Et);return Ge(o,t,f),o},n.box.after=n.secretbox,n.box.open=function(t,f,o,e){var c=n.box.before(o,e);return n.secretbox.open(t,f,c)},n.box.open.after=n.secretbox.open,n.box.keyPair=function(){var t=new Uint8Array(qe),f=new Uint8Array(Re);return zt(t,f),{publicKey:t,secretKey:f}},n.box.keyPair.fromSecretKey=function(t){if(we(t),t.length!==Re)throw new Error("bad secret key size");var f=new Uint8Array(qe);return Je(f,t),{publicKey:f,secretKey:new Uint8Array(t)}},n.box.publicKeyLength=qe,n.box.secretKeyLength=Re,n.box.sharedKeyLength=Et,n.box.nonceLength=Xt,n.box.overheadLength=n.secretbox.overheadLength,n.sign=function(t,f){if(we(t,f),f.length!==Oe)throw new Error("bad secret key size");var o=new Uint8Array(Be+t.length);return Wt(o,t,t.length,f),o},n.sign.open=function(t,f){if(we(t,f),f.length!==Me)throw new Error("bad public key size");var o=new Uint8Array(t.length),e=Ct(o,t,t.length,f);if(e<0)return null;for(var c=new Uint8Array(e),d=0;d<c.length;d++)c[d]=o[d];return c},n.sign.detached=function(t,f){for(var o=n.sign(t,f),e=new Uint8Array(Be),c=0;c<e.length;c++)e[c]=o[c];return e},n.sign.detached.verify=function(t,f,o){if(we(t,f,o),f.length!==Be)throw new Error("bad signature size");if(o.length!==Me)throw new Error("bad public key size");var e=new Uint8Array(Be+t.length),c=new Uint8Array(Be+t.length),d;for(d=0;d<Be;d++)e[d]=f[d];for(d=0;d<t.length;d++)e[d+Be]=t[d];return Ct(c,e,e.length,o)>=0},n.sign.keyPair=function(){var t=new Uint8Array(Me),f=new Uint8Array(Oe);return vt(t,f),{publicKey:t,secretKey:f}},n.sign.keyPair.fromSecretKey=function(t){if(we(t),t.length!==Oe)throw new Error("bad secret key size");for(var f=new Uint8Array(Me),o=0;o<f.length;o++)f[o]=t[32+o];return{publicKey:f,secretKey:new Uint8Array(t)}},n.sign.keyPair.fromSeed=function(t){if(we(t),t.length!==_t)throw new Error("bad seed size");for(var f=new Uint8Array(Me),o=new Uint8Array(Oe),e=0;e<32;e++)o[e]=t[e];return vt(f,o,!0),{publicKey:f,secretKey:o}},n.sign.publicKeyLength=Me,n.sign.secretKeyLength=Oe,n.sign.seedLength=_t,n.sign.signatureLength=Be,n.hash=function(t){we(t);var f=new Uint8Array(It);return Le(f,t,t.length),f},n.hash.hashLength=It,n.verify=function(t,f){return we(t,f),t.length===0||f.length===0||t.length!==f.length?!1:$(t,0,f,0,t.length)===0},n.setPRNG=function(t){s=t},function(){var t=typeof self<"u"?self.crypto||self.msCrypto:null;if(t&&t.getRandomValues){var f=65536;n.setPRNG(function(o,e){var c,d=new Uint8Array(e);for(c=0;c<e;c+=f)t.getRandomValues(d.subarray(c,c+Math.min(e-c,f)));for(c=0;c<e;c++)o[c]=d[c];en(d)})}else typeof Tn<"u"&&(t=Pn,t&&t.randomBytes&&n.setPRNG(function(o,e){var c,d=t.randomBytes(e);for(c=0;c<e;c++)o[c]=d[c];en(d)}))}()})(a.exports?a.exports:self.nacl=self.nacl||{})})(xn);var On=xn.exports;const hn=Ln(On);var pn={exports:{}};(function(a){(function(n,r){a.exports?a.exports=r():(n.nacl||(n.nacl={}),n.nacl.util=r())})(Nn,function(){var n={};function r(s){if(!/^(?:[A-Za-z0-9+\/]{2}[A-Za-z0-9+\/]{2})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+\/]{3}=)?$/.test(s))throw new TypeError("invalid encoding")}return n.decodeUTF8=function(s){if(typeof s!="string")throw new TypeError("expected string");var l,x=unescape(encodeURIComponent(s)),y=new Uint8Array(x.length);for(l=0;l<x.length;l++)y[l]=x.charCodeAt(l);return y},n.encodeUTF8=function(s){var l,x=[];for(l=0;l<s.length;l++)x.push(String.fromCharCode(s[l]));return decodeURIComponent(escape(x.join("")))},typeof atob>"u"?typeof Buffer.from<"u"?(n.encodeBase64=function(s){return Buffer.from(s).toString("base64")},n.decodeBase64=function(s){return r(s),new Uint8Array(Array.prototype.slice.call(Buffer.from(s,"base64"),0))}):(n.encodeBase64=function(s){return new Buffer(s).toString("base64")},n.decodeBase64=function(s){return r(s),new Uint8Array(Array.prototype.slice.call(new Buffer(s,"base64"),0))}):(n.encodeBase64=function(s){var l,x=[],y=s.length;for(l=0;l<y;l++)x.push(String.fromCharCode(s[l]));return btoa(x.join(""))},n.decodeBase64=function(s){r(s);var l,x=atob(s),y=new Uint8Array(x.length);for(l=0;l<x.length;l++)y[l]=x.charCodeAt(l);return y}),n})})(pn);var yn=pn.exports;const Nt="meshlang_actors",Ye="meshlang_active_actor",tn="meshlang_keys",tt="meshlang_active_key";function Ve(){const a=localStorage.getItem(Nt);if(a)try{const r=JSON.parse(a);return{actors:r.actors||r.keys||[]}}catch{return{actors:[]}}const n=localStorage.getItem(tn);if(n)try{const s={actors:JSON.parse(n).keys||[]};localStorage.setItem(Nt,JSON.stringify(s)),localStorage.removeItem(tn);const l=localStorage.getItem(tt);return l&&(localStorage.setItem(Ye,l),localStorage.removeItem(tt)),s}catch{return{actors:[]}}return{actors:[]}}function Ut(a){localStorage.setItem(Nt,JSON.stringify(a))}function Pt(){const a=localStorage.getItem(Ye);if(a)return a;const n=localStorage.getItem(tt);return n?(localStorage.setItem(Ye,n),localStorage.removeItem(tt),n):null}function nt(a){localStorage.setItem(Ye,a)}function bn(){return Ve().actors}function Ot(a){return Ve().actors.find(r=>r.id===a)||null}function mn(a,n,r){const s=Ve(),l=s.actors.findIndex(y=>y.id===a),x={id:a,name:n,publicKey:Array.from(r.publicKey),secretKey:Array.from(r.secretKey),createdAt:Date.now()};l>=0?s.actors[l]=x:s.actors.push(x),Ut(s)}function jn(a){const n=Ve();n.actors=n.actors.filter(r=>r.id!==a),Ut(n),Pt()===a&&localStorage.removeItem(Ye)}function Dn(a,n){const r=Ve(),s=r.actors.find(l=>l.id===a);s&&(s.name=n,Ut(r))}function Lt(a){return{publicKey:new Uint8Array(a.publicKey),secretKey:new Uint8Array(a.secretKey)}}function $n(){const{publicKey:a,secretKey:n}=hn.sign.keyPair();return{publicKey:a,secretKey:n}}function jt(a){const n=hn.hash(a);return yn.encodeBase64(n.slice(0,16)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function Fe(a){return{keyPair:a,nodeId:jt(a.publicKey),publicKeyBase64:yn.encodeBase64(a.publicKey)}}function gn(a){const n=$n(),r=jt(n.publicKey),s=a||`Actor ${new Date().toLocaleString()}`;return mn(r,s,n),nt(r),Fe(n)}function qn(a){const n=Ot(a);return n?(nt(a),Fe(Lt(n))):null}function Rn(){const a=bn(),n=Pt();if(n){const r=Ot(n);if(r)return Fe(Lt(r))}return a.length>0?(nt(a[0].id),Fe(Lt(a[0]))):gn("Default Actor")}function Te(){return bn()}function rt(){return Pt()}function Yn(a){try{const n=JSON.parse(atob(a));if(!n.publicKey||!n.secretKey)return null;const r={publicKey:new Uint8Array(n.publicKey),secretKey:new Uint8Array(n.secretKey)},s=jt(r.publicKey),l=n.name||`Imported ${new Date().toLocaleString()}`;return mn(s,l,r),nt(s),Fe(r)}catch{return null}}function Fn(a){const n=Ot(a);if(!n)return null;const r={name:n.name,publicKey:n.publicKey,secretKey:n.secretKey};return btoa(JSON.stringify(r))}class Vn{facts=new Map;byScope=new Map;byKey=new Map;byValue=new Map;listeners=new Set;valueKey(n){return JSON.stringify(n)}factId(n,r){return`${r}:${n[0]}:${this.valueKey(n[1])}`}add(n,r,s){const l=s??r,x=this.factId(n,l);if(this.facts.has(x))return null;const y={id:x,fact:n,scope:l,timestamp:Date.now(),source:r};this.facts.set(x,y),this.byScope.has(l)||this.byScope.set(l,new Set),this.byScope.get(l).add(x),this.byKey.has(n[0])||this.byKey.set(n[0],new Set),this.byKey.get(n[0]).add(x);const E=this.valueKey(n[1]);this.byValue.has(E)||this.byValue.set(E,new Set),this.byValue.get(E).add(x);for(const A of this.listeners)A(y);return y}get(n){return this.facts.get(n)}has(n,r){return this.facts.has(this.factId(n,r))}retract(n,r){const s=this.factId(n,r);if(!this.facts.get(s))return!1;this.facts.delete(s);const x=this.byScope.get(r);x&&(x.delete(s),x.size===0&&this.byScope.delete(r));const y=this.byKey.get(n[0]);y&&(y.delete(s),y.size===0&&this.byKey.delete(n[0]));const E=this.valueKey(n[1]),A=this.byValue.get(E);return A&&(A.delete(s),A.size===0&&this.byValue.delete(E)),!0}all(){return Array.from(this.facts.values())}allIds(){return new Set(this.facts.keys())}findByScope(n){const r=this.byScope.get(n);return r?Array.from(r).map(s=>this.facts.get(s)):[]}findByKey(n){const r=this.byKey.get(n);return r?Array.from(r).map(s=>this.facts.get(s)):[]}findByValue(n){const r=this.byValue.get(this.valueKey(n));return r?Array.from(r).map(s=>this.facts.get(s)):[]}onAdd(n){return this.listeners.add(n),()=>this.listeners.delete(n)}addStored(n){if(this.facts.has(n.id))return!1;this.facts.set(n.id,n);const r=n.fact,s=n.scope;this.byScope.has(s)||this.byScope.set(s,new Set),this.byScope.get(s).add(n.id),this.byKey.has(r[0])||this.byKey.set(r[0],new Set),this.byKey.get(r[0]).add(n.id);const l=this.valueKey(r[1]);this.byValue.has(l)||this.byValue.set(l,new Set),this.byValue.get(l).add(n.id);for(const x of this.listeners)x(n);return!0}}function nn(a){return{id:a.id,k:a.fact[0],v:a.fact[1],sc:a.scope,t:a.timestamp,s:a.source}}function rn(a){if("e"in a&&"a"in a){const r=a;return{id:r.id,fact:[r.a,r.v],scope:r.e,timestamp:r.t,source:r.s}}const n=a;return{id:n.id,fact:[n.k,n.v],scope:n.sc,timestamp:n.t,source:n.s}}function kn(a){return JSON.stringify(a)}function zn(a){return JSON.parse(a)}class on{constructor(n,r={iceServers:[{urls:"stun:stun.l.google.com:19302"}]}){this.isInitiator=n,this.config=r,this.connection=new RTCPeerConnection(this.config),this.connection.oniceconnectionstatechange=()=>{console.log("[Peer] ICE connection state:",this.connection.iceConnectionState),(this.connection.iceConnectionState==="disconnected"||this.connection.iceConnectionState==="failed")&&this.setState("disconnected")},this.connection.onconnectionstatechange=()=>{console.log("[Peer] Connection state:",this.connection.connectionState)},this.connection.onsignalingstatechange=()=>{console.log("[Peer] Signaling state:",this.connection.signalingState)},n?(this.channel=this.connection.createDataChannel("meshlang"),this.setupChannel(this.channel)):this.connection.ondatachannel=s=>{this.channel=s.channel,this.setupChannel(this.channel)}}connection;channel=null;state="connecting";messageHandlers=new Set;stateHandlers=new Set;pendingCandidates=[];remoteDescriptionSet=!1;remoteInfo=null;setupChannel(n){console.log("[Peer] Setting up data channel:",n.label),n.onopen=()=>{console.log("[Peer] Data channel opened"),this.setState("connected")},n.onclose=()=>{console.log("[Peer] Data channel closed"),this.setState("disconnected")},n.onerror=r=>{console.error("[Peer] Data channel error:",r)},n.onmessage=r=>{try{const s=zn(r.data);console.log("[Peer] Received message:",s.type),s.type==="hello"&&(this.remoteInfo={nodeId:s.nodeId,publicKey:s.publicKey});for(const l of this.messageHandlers)l(s)}catch(s){console.error("Failed to decode message:",s)}}}setState(n){this.state=n;for(const r of this.stateHandlers)r(n)}getState(){return this.state}async createOffer(){console.log("[Peer] Creating offer");const n=await this.connection.createOffer();return await this.connection.setLocalDescription(n),console.log("[Peer] Offer created and local description set"),n}async acceptOffer(n){console.log("[Peer] Accepting offer"),await this.connection.setRemoteDescription(n),this.remoteDescriptionSet=!0,await this.flushPendingCandidates();const r=await this.connection.createAnswer();return await this.connection.setLocalDescription(r),console.log("[Peer] Answer created and local description set"),r}async acceptAnswer(n){console.log("[Peer] Accepting answer"),await this.connection.setRemoteDescription(n),this.remoteDescriptionSet=!0,await this.flushPendingCandidates(),console.log("[Peer] Answer accepted, remote description set")}async flushPendingCandidates(){for(const n of this.pendingCandidates)await this.connection.addIceCandidate(n);this.pendingCandidates=[]}async addIceCandidate(n){this.remoteDescriptionSet?await this.connection.addIceCandidate(n):this.pendingCandidates.push(n)}onIceCandidate(n){const r=this.connection.onicecandidate;this.connection.onicecandidate=s=>{s.candidate&&(console.log("[Peer] ICE candidate:",s.candidate.candidate?.substring(0,50)),n(s.candidate)),r&&r.call(this.connection,s)}}onIceGatheringComplete(n){const r=this.connection.onicecandidate;this.connection.onicecandidate=s=>{r&&r.call(this.connection,s),s.candidate||(console.log("[Peer] ICE gathering complete"),n())}}send(n){this.channel&&this.channel.readyState==="open"&&this.channel.send(kn(n))}onMessage(n){return this.messageHandlers.add(n),()=>this.messageHandlers.delete(n)}onStateChange(n){return this.stateHandlers.add(n),()=>this.stateHandlers.delete(n)}close(){this.channel?.close(),this.connection.close(),this.setState("disconnected")}}class Hn{constructor(n,r){this.identity=n,this.store=r,r.onAdd(s=>{const l={type:"fact-add",fact:nn(s)};this.broadcast(l)})}peers=new Map;listeners=new Set;broadcast(n,r){for(const[s,l]of this.peers)s!==r&&l.getState()==="connected"&&l.send(n)}notifyListeners(){for(const n of this.listeners)n()}setupPeer(n){n.onStateChange(r=>{if(console.log("[Mesh] Peer state changed:",r,"remoteInfo:",n.remoteInfo?.nodeId),r==="connected"){console.log("[Mesh] Sending hello to peer"),n.send({type:"hello",nodeId:this.identity.nodeId,publicKey:this.identity.publicKeyBase64});const s=Array.from(this.store.allIds());console.log("[Mesh] Sending sync request with",s.length,"known facts"),n.send({type:"sync-request",haveIds:s}),this.notifyListeners()}r==="disconnected"&&n.remoteInfo&&(console.log("[Mesh] Peer disconnected:",n.remoteInfo.nodeId),this.peers.delete(n.remoteInfo.nodeId),this.notifyListeners())}),n.onMessage(r=>{console.log("[Mesh] Received message:",r.type),this.handleMessage(n,r)})}handleMessage(n,r){switch(r.type){case"hello":n.remoteInfo={nodeId:r.nodeId,publicKey:r.publicKey},this.peers.set(r.nodeId,n),this.notifyListeners();break;case"sync-request":{const s=new Set(r.haveIds),l=this.store.all().filter(x=>!s.has(x.id)).map(nn);n.send({type:"sync-response",facts:l});break}case"sync-response":for(const s of r.facts){const l=rn(s);this.store.addStored(l)}break;case"fact-add":{const s=rn(r.fact);this.store.addStored(s)&&this.broadcast(r,n.remoteInfo?.nodeId);break}}}async createOffer(){console.log("[Mesh] Creating offer");const n=new on(!0),r=[],s=new Promise(y=>{n.onIceCandidate(E=>{r.push(E)}),n.onIceGatheringComplete(()=>y())}),l=await n.createOffer();console.log("[Mesh] Waiting for ICE candidates..."),await s,console.log("[Mesh] Got",r.length,"ICE candidates");const x={type:"offer",nodeId:this.identity.nodeId,publicKey:this.identity.publicKeyBase64,sdp:l,candidates:r.map(y=>y.toJSON())};return this.peers.set("pending-offer",n),this.setupPeer(n),console.log("[Mesh] Offer created, waiting for answer"),btoa(JSON.stringify(x))}async acceptOffer(n){console.log("[Mesh] Accepting offer");const r=JSON.parse(atob(n));console.log("[Mesh] Offer from:",r.nodeId,"with",r.candidates.length,"candidates");const s=new on(!1);s.remoteInfo={nodeId:r.nodeId,publicKey:r.publicKey};const l=[],x=new Promise(A=>{s.onIceCandidate(U=>{l.push(U)}),s.onIceGatheringComplete(()=>A())}),y=await s.acceptOffer(r.sdp);console.log("[Mesh] Adding",r.candidates.length,"remote ICE candidates");for(const A of r.candidates)await s.addIceCandidate(A);console.log("[Mesh] Waiting for local ICE candidates..."),await x,console.log("[Mesh] Got",l.length,"local ICE candidates"),this.peers.set(r.nodeId,s),this.setupPeer(s);const E={type:"answer",nodeId:this.identity.nodeId,publicKey:this.identity.publicKeyBase64,sdp:y,candidates:l.map(A=>A.toJSON())};return console.log("[Mesh] Answer created"),btoa(JSON.stringify(E))}async acceptAnswer(n){console.log("[Mesh] Accepting answer");const r=JSON.parse(atob(n));console.log("[Mesh] Answer from:",r.nodeId,"with",r.candidates.length,"candidates");const s=this.peers.get("pending-offer");if(!s)throw new Error("No pending offer to accept answer for");this.peers.delete("pending-offer"),s.remoteInfo={nodeId:r.nodeId,publicKey:r.publicKey},this.peers.set(r.nodeId,s),await s.acceptAnswer(r.sdp),console.log("[Mesh] Adding",r.candidates.length,"remote ICE candidates");for(const l of r.candidates)await s.addIceCandidate(l);console.log("[Mesh] Connection established")}getPeers(){const n=[];for(const r of this.peers.values())r.remoteInfo&&r.getState()==="connected"&&n.push(r.remoteInfo);return n}getPeerCount(){return this.getPeers().length}onChange(n){return this.listeners.add(n),()=>this.listeners.delete(n)}}class je{constructor(n){this.name=n}static isVar(n){return n instanceof je}}function Bt(a,n,r){if(je.isVar(a)){const s=r.get(a.name);if(s!==void 0)return s===n?r:null;const l=new Map(r);return l.set(a.name,n),l}return a===n?r:null}function Jn(a,n,r,s){let l=r;return s!==void 0&&(l=Bt(s,n.scope,l),!l)||(l=Bt(a[0],n.fact[0],l),!l)?null:(l=Bt(a[1],n.fact[1],l),l)}function Gn(a,n,r){if(n.length===0)return[new Map];let s=[new Map];for(const l of n){const x=[];for(const y of s){let E;const[A,U]=l;r?.scope?E=a.findByScope(r.scope):!je.isVar(A)&&typeof A=="string"?E=a.findByKey(A):E=a.all(),r?.scope&&!je.isVar(A)&&(E=E.filter(w=>w.fact[0]===A));for(const w of E){const M=Jn(l,w,y,r?.scopePattern);M&&x.push(M)}}s=x}return s}function fn(a){return new je(a)}function Zn(a){const n={};for(const[r,s]of a)n[`?${r}`]=s;return n}async function an(a){await navigator.clipboard.writeText(a)}function Wn(a,n,r){a.innerHTML=`
    <div class="exchange">
      <h3>Connect to Peer</h3>
      <div class="exchange-tabs">
        <button class="tab active" data-tab="initiate">Create Invite</button>
        <button class="tab" data-tab="join">Join with Invite</button>
      </div>

      <div class="tab-content" id="initiate-tab">
        <p>1. Click "Generate" to create an invite code</p>
        <button id="generate-offer">Generate Invite</button>
        <textarea id="offer-output" readonly placeholder="Invite code will appear here..."></textarea>
        <button id="copy-offer" disabled>Copy to Clipboard</button>

        <p>2. Share the code with peer, then paste their response:</p>
        <textarea id="answer-input" placeholder="Paste peer's response here..."></textarea>
        <button id="accept-answer" disabled>Connect</button>
      </div>

      <div class="tab-content hidden" id="join-tab">
        <p>1. Paste the invite code from your peer:</p>
        <textarea id="offer-input" placeholder="Paste invite code here..."></textarea>
        <button id="accept-offer">Accept Invite</button>

        <p>2. Copy the response and send it back:</p>
        <textarea id="answer-output" readonly placeholder="Response will appear here..."></textarea>
        <button id="copy-answer" disabled>Copy to Clipboard</button>
      </div>
    </div>
  `;const s=a.querySelectorAll(".tab"),l=a.querySelector("#initiate-tab"),x=a.querySelector("#join-tab");s.forEach($=>{$.addEventListener("click",()=>{s.forEach(he=>he.classList.remove("active")),$.classList.add("active");const ee=$.dataset.tab;l.classList.toggle("hidden",ee!=="initiate"),x.classList.toggle("hidden",ee!=="join")})});const y=a.querySelector("#generate-offer"),E=a.querySelector("#offer-output"),A=a.querySelector("#copy-offer"),U=a.querySelector("#answer-input"),w=a.querySelector("#accept-answer");y.addEventListener("click",async()=>{y.disabled=!0,y.textContent="Generating...";try{const $=await n.createOffer();E.value=$,A.disabled=!1,w.disabled=!1}catch($){E.value=`Error: ${$}`}y.disabled=!1,y.textContent="Generate Invite"}),A.addEventListener("click",async()=>{await an(E.value),A.textContent="Copied!",setTimeout(()=>A.textContent="Copy to Clipboard",2e3)}),w.addEventListener("click",async()=>{const $=U.value.trim();if($)try{await n.acceptAnswer($)}catch(ee){alert(`Failed to connect: ${ee}`)}});const M=a.querySelector("#offer-input"),_=a.querySelector("#accept-offer"),V=a.querySelector("#answer-output"),ae=a.querySelector("#copy-answer");_.addEventListener("click",async()=>{const $=M.value.trim();if($){_.disabled=!0,_.textContent="Processing...";try{const ee=await n.acceptOffer($);V.value=ee,ae.disabled=!1}catch(ee){V.value=`Error: ${ee}`}_.disabled=!1,_.textContent="Accept Invite"}}),ae.addEventListener("click",async()=>{await an(V.value),ae.textContent="Copied!",setTimeout(()=>ae.textContent="Copy to Clipboard",2e3)})}function cn(a,n){const s=a.findByScope(n).find(l=>l.fact[0]==="name");return s?String(s.fact[1]):n.slice(0,8)}function Xn(a,n){const s=a.findByScope(n).find(x=>x.fact[0]==="parents");if(!s)return[];const l=s.fact[1];return Array.isArray(l)?l:typeof l=="string"?[l]:[]}function Qn(a,n){const r=a.findByScope(n),s=[],l=/^(\w+)\((.+)\)$/;for(const x of r){const y=x.fact[0];if(y.match(l)){const A=x.id;let U=y;const w=y.match(/symbol\("([^"]+)"\)/);w&&(U=w[1]),s.push({id:A,key:y,displayName:U})}}return s}function er(a,n){return{currentScope:n,path:[...a.path,n]}}function tr(a){if(a.path.length<=1)return null;const n=a.path.slice(0,-1);return{currentScope:n[n.length-1],path:n}}function nr(a,n){return n<0||n>=a.path.length?a:{currentScope:a.path[n],path:a.path.slice(0,n+1)}}function rr(a,n,r){if(n<=0||n>=a.path.length)return a;const s=[...a.path];return s[n-1]=r,{currentScope:a.currentScope,path:s}}function or(a){return{currentScope:a,path:[a]}}function fr(a){return typeof a=="object"&&a!==null&&"type"in a&&a.type==="var"}function vn(a){return typeof a=="object"&&a!==null&&"type"in a&&a.type==="constructor"}function ar(a){return typeof a=="object"&&a!==null&&"type"in a&&a.type==="scope"}function cr(a){return{type:"var",name:a}}function sn(a,...n){return{type:"constructor",name:a,args:n}}function sr(a){return{type:"scope",id:a}}function wn(a){if(a===null)return"null";if(typeof a=="string")return`"${a}"`;if(typeof a=="number"||typeof a=="boolean")return String(a);if(fr(a))return`?${a.name}`;if(vn(a)){if(a.args.length===0)return a.name;const n=a.args.map(wn).join(", ");return`${a.name}(${n})`}return ar(a)?`@${a.id}`:String(a)}class _e extends Error{constructor(n,r){super(n),this.position=r,this.name="ParseError"}}function ir(a){const n=[];let r=0;for(;r<a.length;){if(/\s/.test(a[r])){r++;continue}if(a[r]==="?"){r++;let s="";for(;r<a.length&&/[\w]/.test(a[r]);)s+=a[r++];if(s.length===0)throw new _e("Expected variable name after ?",r);n.push({type:"variable",name:s});continue}if(a[r]==="@"){r++;let s="";for(;r<a.length&&/[\w\-]/.test(a[r]);)s+=a[r++];if(s.length===0)throw new _e("Expected scope id after @",r);n.push({type:"scope",id:s});continue}if(a[r]==='"'||a[r]==="'"){const s=a[r++];let l="";for(;r<a.length&&a[r]!==s;){if(a[r]==="\\"&&r+1<a.length)switch(r++,a[r]){case"n":l+=`
`;break;case"t":l+="	";break;case"\\":l+="\\";break;default:l+=a[r]}else l+=a[r];r++}if(r>=a.length)throw new _e("Unterminated string",r);r++,n.push({type:"string",value:l});continue}if(/[\d\-]/.test(a[r])){let s="";for(a[r]==="-"&&(s+=a[r++]);r<a.length&&/[\d\.]/.test(a[r]);)s+=a[r++];if(s==="-"||s===".")throw new _e("Invalid number",r);n.push({type:"number",value:parseFloat(s)});continue}if(a[r]==="("){n.push({type:"lparen"}),r++;continue}if(a[r]===")"){n.push({type:"rparen"}),r++;continue}if(a[r]===","){n.push({type:"comma"}),r++;continue}if(/[a-zA-Z_]/.test(a[r])){let s="";for(;r<a.length&&/[\w]/.test(a[r]);)s+=a[r++];s==="true"?n.push({type:"boolean",value:!0}):s==="false"?n.push({type:"boolean",value:!1}):s==="null"?n.push({type:"null"}):n.push({type:"identifier",value:s});continue}throw new _e(`Unexpected character: ${a[r]}`,r)}return n}function lr(a){const n=a.trim();if(n.length===0)return"";const r=ir(n);if(r.length===0)return"";let s=0;function l(){return r[s]}function x(){return r[s++]}function y(){const A=l();if(!A)throw new _e("Unexpected end of input",s);switch(A.type){case"number":return x(),A.value;case"string":return x(),A.value;case"boolean":return x(),A.value;case"null":return x(),null;case"variable":return x(),cr(A.name);case"scope":return x(),sr(A.id);case"identifier":{x();const U=A.value;if(l()?.type==="lparen"){x();const w=[];for(;l()&&l().type!=="rparen";)if(w.push(y()),l()?.type==="comma")x();else if(l()?.type!=="rparen")throw new _e("Expected , or )",s);if(l()?.type!=="rparen")throw new _e("Expected )",s);return x(),sn(U,...w)}return sn(U)}default:throw new _e(`Unexpected token: ${A.type}`,s)}}const E=y();if(s<r.length)throw new _e("Unexpected tokens after expression",s);return E}function dr(a){try{return lr(a)}catch{return null}}function ur(a){const r=a.trim().match(/^([a-zA-Z_]\w*)\s*\((.*)$/);if(!r)return null;const s=r[1],l=r[2];let x=0,y=0,E=!1,A="";for(const _ of l){if(E){_===A&&(E=!1);continue}if(_==='"'||_==="'"){E=!0,A=_;continue}_==="("?y++:_===")"?y--:_===","&&y===0&&x++}const U=l.lastIndexOf(","),M=(U===-1?l:l.slice(U+1)).trim().length>0||l.length===0;return{name:s,argCount:x,inArg:M}}function xr(a,n){const r=a.findByScope(n),s=[];for(const l of r)if(l.fact[0]==="constructor"){const x=l.fact[1];if(typeof x=="object"&&x!==null){const y=x;typeof y.name=="string"&&s.push({name:y.name,params:y.params||[],description:y.description})}else typeof x=="string"&&s.push({name:x,params:[]})}return s}function hr(a,n){const r=a.findByScope(n),s=new Set;for(const l of r)s.add(l.fact[0]);return Array.from(s)}function pr(a,n){const r=a.findByScope(n),s=new Set,l=[];for(const x of r){const y=x.fact[1];if(y!==null){const E=JSON.stringify(y);s.has(E)||(s.add(E),(typeof y=="string"||typeof y=="number"||typeof y=="boolean")&&l.push(y))}}return l}function yr(a,n){const s=a.findByScope(n).find(x=>x.fact[0]==="children");if(!s)return[];const l=s.fact[1];return Array.isArray(l)?l.map(x=>{const E=a.findByScope(x).find(U=>U.fact[0]==="name"),A=E?String(E.fact[1]):x.slice(0,8);return{id:x,name:A}}):[]}function br(a,n,r){const s=[],l=r.toLowerCase(),x=hr(a,n);for(const w of x)w.toLowerCase().includes(l)&&s.push({text:w,display:w,type:"key"});const y=xr(a,n),E=[...gr,...y],A=new Set;for(const w of E)if(!A.has(w.name)&&(A.add(w.name),w.name.toLowerCase().includes(l)))if(w.params.length===0)s.push({text:w.name,display:w.name,description:w.description,type:"constructor"});else{const M=w.params.map(_=>_.name).join(", ");s.push({text:`${w.name}(`,display:`${w.name}(${M})`,description:w.description,type:"constructor",completion:`${w.name}()`})}const U=ur(r);if(U){const w=E.find(M=>M.name===U.name);if(w&&U.argCount<w.params.length){const M=w.params[U.argCount];s.push({text:"",display:`${M.name}: ${M.type}`,description:`Argument ${U.argCount+1} of ${w.name}`,type:"constructor"})}}return s}function mr(a,n,r,s){const l=[],x=r.toLowerCase();if(s){const E=a.findByScope(n),A=new Set;for(const U of E)if(U.fact[0]===s){const w=U.fact[1],M=w===null?"null":typeof w=="string"?w:JSON.stringify(w);!A.has(M)&&M.toLowerCase().includes(x)&&(A.add(M),l.push({text:M,display:M,type:"value"}))}}const y=pr(a,n);for(const E of y){const A=typeof E=="string"?E:String(E);A.toLowerCase().includes(x)&&(l.some(w=>w.display===A)||l.push({text:A,display:A,type:"value"}))}if(r.startsWith("@")||r===""){const E=yr(a,n);for(const A of E){const U=`@${A.id}`;U.toLowerCase().includes(x)&&l.push({text:U,display:`@${A.name}`,description:`Scope: ${A.id.slice(0,8)}`,type:"scope"})}}return"true".includes(x)&&l.push({text:"true",display:"true",type:"value"}),"false".includes(x)&&l.push({text:"false",display:"false",type:"value"}),"null".includes(x)&&l.push({text:"null",display:"null",type:"value"}),l}const gr=[{name:"name",params:[],description:"Name attribute"},{name:"type",params:[],description:"Type attribute"},{name:"value",params:[],description:"Value attribute"},{name:"symbol",params:[{name:"name",type:"string"}],description:"Create a symbol (scope/identifier)"},{name:"eq",params:[{name:"expr",type:"any"}],description:'Equality/binding - use eq(symbol("x")) to create scope'},{name:"lt",params:[{name:"num",type:"number"}],description:"Less than"},{name:"gt",params:[{name:"num",type:"number"}],description:"Greater than"},{name:"ref",params:[{name:"target",type:"any"}],description:"Reference to another scope/symbol"},{name:"list",params:[{name:"items",type:"any"}],description:"List of items"}];function Mt(a){const n=document.createElement("div");n.className="autocomplete-container";const r=document.createElement("input");r.type="text",r.className="autocomplete-input",r.placeholder=a.placeholder,r.autocomplete="off";const s=document.createElement("div");s.className="autocomplete-dropdown hidden",n.appendChild(r),n.appendChild(s);let l=-1,x=[];function y(){const w=r.getBoundingClientRect();s.style.top=`${w.bottom+2}px`,s.style.left=`${w.left}px`,s.style.width=`${w.width}px`}function E(){const w=r.value;if(a.type==="key"?x=br(a.store,a.scope,w):x=mr(a.store,a.scope,w,a.forKey),x=x.slice(0,10),x.length===0||x.length===1&&x[0].text===w){s.classList.add("hidden");return}s.innerHTML="",l=-1,y(),x.forEach((M,_)=>{const V=document.createElement("div");V.className="autocomplete-item",V.dataset.index=String(_);const ae=document.createElement("span");if(ae.className="autocomplete-item-text",ae.textContent=M.display,V.appendChild(ae),M.description){const ee=document.createElement("span");ee.className="autocomplete-item-desc",ee.textContent=M.description,V.appendChild(ee)}const $=document.createElement("span");$.className=`autocomplete-item-type type-${M.type}`,$.textContent=M.type,V.appendChild($),V.onclick=()=>U(_),V.onmouseenter=()=>{l=_,A()},s.appendChild(V)}),s.classList.remove("hidden")}function A(){s.querySelectorAll(".autocomplete-item").forEach((M,_)=>{M.classList.toggle("selected",_===l)})}function U(w){if(w<0||w>=x.length)return;const M=x[w],_=M.completion||M.text;r.value=_,s.classList.add("hidden"),_.endsWith("(")&&(r.value=_+")",r.setSelectionRange(_.length,_.length)),a.onSelect?.(r.value),a.onChange?.(r.value)}return r.oninput=()=>{E(),a.onChange?.(r.value)},r.onfocus=()=>{E()},r.onblur=()=>{setTimeout(()=>{s.classList.add("hidden")},200)},r.onkeydown=w=>{if(s.classList.contains("hidden")){w.key==="ArrowDown"&&(E(),w.preventDefault());return}switch(w.key){case"ArrowDown":w.preventDefault(),l=Math.min(l+1,x.length-1),A();break;case"ArrowUp":w.preventDefault(),l=Math.max(l-1,-1),A();break;case"Enter":l>=0&&(w.preventDefault(),U(l));break;case"Escape":s.classList.add("hidden");break;case"Tab":l>=0?U(l):x.length>0&&U(0);break}},n.getValue=()=>r.value,n.setValue=w=>{r.value=w,a.onChange?.(w)},n.clear=()=>{r.value="",a.onChange?.("")},n.focus=()=>r.focus(),n.getInput=()=>r,n}function ln(a){return a.getValue?.()||""}function dn(a){a.clear?.()}function Tt(a){a.focus?.()}function un(a){return a.getInput?.()||null}function vr(a){return typeof a=="string"?`"${a}"`:a===null?"null":String(a)}function wr(a,n,r){const s=document.createElement("div");s.className="scope-navigator";const l=document.createElement("div");l.className="breadcrumbs",n.path.forEach((y,E)=>{const A=document.createElement("div");A.className="breadcrumb";const U=cn(a,y),w=Xn(a,y),M=E===n.path.length-1;if(E>0&&w.length>1){const V=document.createElement("select");V.className="breadcrumb-dropdown";const ae=n.path[E-1];w.forEach($=>{const ee=document.createElement("option");ee.value=$,ee.textContent=cn(a,$),ee.selected=$===ae,V.appendChild(ee)}),V.onchange=()=>{const $=rr(n,E,V.value);r($)},A.appendChild(V),A.appendChild(document.createTextNode(" / "))}else E>0&&A.appendChild(document.createTextNode(" / "));const _=document.createElement("span");_.className=`breadcrumb-name ${M?"current":"clickable"}`,_.textContent=U,M||(_.onclick=()=>{const V=nr(n,E);r(V)}),A.appendChild(_),l.appendChild(A)}),s.appendChild(l);const x=Qn(a,n.currentScope);if(x.length>0){const y=document.createElement("div");y.className="navigable-facts";const E=document.createElement("span");E.className="navigable-facts-label",E.textContent="Enter: ",y.appendChild(E),x.forEach(A=>{const U=document.createElement("button");U.className="navigable-fact-btn",U.textContent=A.displayName,U.title=A.key,U.onclick=()=>{const w=er(n,A.id);r(w)},y.appendChild(U)}),s.appendChild(y)}if(n.path.length>1){const y=document.createElement("button");y.className="scope-up-btn",y.textContent=" Up",y.onclick=()=>{const E=tr(n);E&&r(E)},s.appendChild(y)}return s}function Kt(a){const n=a.trim();return n==="true"?!0:n==="false"?!1:n==="null"?null:/^-?\d+(\.\d+)?$/.test(n)?parseFloat(n):n.startsWith('"')&&n.endsWith('"')||n.startsWith("'")&&n.endsWith("'")?n.slice(1,-1):n}function Sr(a,n,r){const s=document.createElement("div"),l=a.findByScope(n);if(l.length===0)return s.innerHTML='<p class="empty-state">No facts in this scope. Add some below.</p>',s;const x=document.createElement("ul");x.className="fact-list";for(const y of l){const E=document.createElement("li");E.className="fact-item";const A=document.createElement("span");A.className="key",A.textContent=y.fact[0];const U=document.createTextNode(": "),w=document.createElement("span");w.className="value editable",w.textContent=vr(y.fact[1]),w.title="Click to edit",w.onclick=()=>{const M=document.createElement("input");M.type="text",M.className="fact-edit-input",M.value=typeof y.fact[1]=="string"?y.fact[1]:String(y.fact[1]);const _=()=>{const V=Kt(M.value),ae=y.fact;a.retract(ae,n),a.add([ae[0],V],r,n)};M.onblur=_,M.onkeydown=V=>{V.key==="Enter"?_():V.key==="Escape"&&a.add(y.fact,r,y.scope)},w.replaceWith(M),M.focus(),M.select()},E.appendChild(A),E.appendChild(U),E.appendChild(w),x.appendChild(E)}return s.appendChild(x),s}function Cr(a,n,r){const s=document.createElement("div");s.className="add-fact-form";let l="";const x=Mt({store:a,scope:n,type:"key",placeholder:"key (e.g., name, eq(x))",onChange:M=>{l=M}}),y=Mt({store:a,scope:n,type:"value",placeholder:"value",forKey:l}),E=document.createElement("button");E.id="add-fact-btn",E.textContent="Add";const A=()=>{const M=ln(x).trim(),_=ln(y).trim();if(!M)return;const V=dr(M),ae=V!==null&&vn(V)?wn(V):M;let $=_;_==="true"?$=!0:_==="false"?$=!1:_==="null"?$=null:/^-?\d+(\.\d+)?$/.test(_)&&($=parseFloat(_)),a.add([ae,$],r,n),dn(x),dn(y),Tt(x)};E.onclick=A;const U=un(y);if(U){const M=U.onkeydown;U.onkeydown=_=>{_.key==="Enter"&&!_.defaultPrevented&&y.querySelector(".autocomplete-dropdown")?.classList.contains("hidden")&&(A(),_.preventDefault()),M?.call(U,_)}}const w=un(x);if(w){const M=w.onkeydown;w.onkeydown=_=>{_.key==="Tab"&&!_.shiftKey&&x.querySelector(".autocomplete-dropdown")?.classList.contains("hidden")&&(_.preventDefault(),Tt(y)),M?.call(w,_)}}return s.appendChild(x),s.appendChild(y),s.appendChild(E),s}function Ar(a,n){const r=document.createElement("div");r.className="query-builder";const s=document.createElement("h4");s.textContent="Query",r.appendChild(s);const l=document.createElement("div");l.className="query-pattern";const x={key:{type:"any",value:""},value:{type:"any",value:""}},y=document.createElement("div");y.className="query-results empty",y.textContent="Enter a pattern to query";const E=document.createElement("div");E.className="query-preview";const A=document.createElement("code");A.className="pattern-text",E.appendChild(A);function U(){const _=x.key.type==="any"?"?key":x.key.value||"?key",V=x.value.type==="any"?"?val":x.value.value||"?val";A.textContent=`[${_}, ${V}]`}function w(){try{const _=x.key.type==="any"?fn("key"):Kt(x.key.value),V=x.value.type==="any"?fn("val"):Kt(x.value.value),$=Gn(a,[[_,V]],{scope:n});$.length===0?(y.className="query-results empty",y.textContent="No matches"):(y.className="query-results",y.innerHTML=$.map(ee=>`<div class="result-row">${JSON.stringify(Zn(ee))}</div>`).join(""))}catch(_){y.className="query-results empty",y.textContent=`Error: ${_}`}}function M(_,V,ae){const $=document.createElement("div");$.className="pattern-slot";const ee=document.createElement("label");ee.textContent=V,$.appendChild(ee);const he=document.createElement("div");he.className="slot-options";const se=document.createElement("button");se.className="slot-btn active",se.textContent=`Any (?${_[0]})`,se.dataset.type="any";const ve=document.createElement("button");ve.className="slot-btn",ve.textContent="Specific",ve.dataset.type="specific",he.appendChild(se),he.appendChild(ve),$.appendChild(he);const ge=Mt({store:a,scope:n,type:ae,placeholder:_,onChange:pe=>{x[_].value=pe,U(),w()}});return ge.classList.add("hidden"),$.appendChild(ge),[se,ve].forEach(pe=>{pe.onclick=()=>{se.classList.toggle("active",pe===se),ve.classList.toggle("active",pe===ve),x[_].type=pe.dataset.type,pe.dataset.type==="specific"?(ge.classList.remove("hidden"),Tt(ge)):ge.classList.add("hidden"),U(),w()}}),$}return l.appendChild(M("key","Key","key")),l.appendChild(M("value","Value","value")),r.appendChild(l),r.appendChild(E),r.appendChild(y),U(),w(),r}function Er(a,n,r){const s=n.findByScope(a).find(l=>l.fact[0]==="name");return s?String(s.fact[1]):r}function _r(a,n,r){const s=document.createElement("div");s.className="actor-switcher";const l=n.getActors();s.innerHTML=`
    <div class="actor-switcher-row">
      <select class="actor-select">
        ${l.map(se=>`<option value="${se.id}" ${se.id===a?"selected":""}>${Er(se.id,r,se.name)}</option>`).join("")}
      </select>
      <button class="actor-btn" title="New Actor">+</button>
      <button class="actor-btn" title="Import Actor">Import</button>
      <button class="actor-btn" title="Export Actor">Export</button>
      <button class="actor-btn actor-btn-danger" title="Delete Actor">Delete</button>
    </div>
    <div class="actor-import-row hidden">
      <input type="text" class="actor-import-input" placeholder="Paste actor data..." />
      <button class="actor-import-btn">Import</button>
      <button class="actor-import-cancel">Cancel</button>
    </div>
    <div class="actor-export-row hidden">
      <textarea class="actor-export-output" readonly></textarea>
      <button class="actor-export-copy">Copy</button>
      <button class="actor-export-close">Close</button>
    </div>
  `;const x=s.querySelector(".actor-select"),y=s.querySelectorAll(".actor-btn")[0],E=s.querySelectorAll(".actor-btn")[1],A=s.querySelectorAll(".actor-btn")[2],U=s.querySelectorAll(".actor-btn")[3],w=s.querySelector(".actor-import-row"),M=s.querySelector(".actor-import-input"),_=s.querySelector(".actor-import-btn"),V=s.querySelector(".actor-import-cancel"),ae=s.querySelector(".actor-export-row"),$=s.querySelector(".actor-export-output"),ee=s.querySelector(".actor-export-copy"),he=s.querySelector(".actor-export-close");return x.onchange=()=>{n.onSwitchActor(x.value)},y.onclick=()=>{const se=prompt("Enter a name for the new actor:",`Actor ${new Date().toLocaleString()}`);se!==null&&n.onCreateActor(se||void 0)},E.onclick=()=>{w.classList.remove("hidden"),M.focus()},V.onclick=()=>{w.classList.add("hidden"),M.value=""},_.onclick=()=>{const se=M.value.trim();if(!se)return;n.onImportActor(se)?(w.classList.add("hidden"),M.value=""):alert("Invalid actor data")},A.onclick=()=>{const se=n.onExportActor(a);se&&($.value=se,ae.classList.remove("hidden"))},ee.onclick=async()=>{await navigator.clipboard.writeText($.value),ee.textContent="Copied!",setTimeout(()=>ee.textContent="Copy",2e3)},he.onclick=()=>{ae.classList.add("hidden"),$.value=""},U.onclick=()=>{if(l.length<=1){alert("Cannot delete the last actor");return}confirm("Are you sure you want to delete this actor?")&&n.onDeleteActor(a)},s}function ot(a,n,r){const{identity:s,store:l,mesh:x}=n;let y=n.navigation||or(s.nodeId);function E(U){y=U,A()}function A(){const U=x.getPeerCount(),w=y.currentScope,M=l.findByScope(w);a.innerHTML="";const _=document.createElement("div");_.className="header";const V=document.createElement("div");V.className="header-info",V.innerHTML=`
      <div class="node-id">Node: ${s.nodeId}</div>
      <div class="peer-count ${U>0?"connected":""}">
        ${U} peer${U!==1?"s":""} connected
      </div>
    `,_.appendChild(V),_.appendChild(_r(s.nodeId,r,l)),a.appendChild(_);const ae=document.createElement("div");ae.className="section",ae.innerHTML=`
      <div class="section-header">
        <h2>Scope</h2>
      </div>
    `;const $=document.createElement("div");$.className="section-content",$.appendChild(wr(l,y,E)),ae.appendChild($),a.appendChild(ae);const ee=document.createElement("div");ee.className="section",ee.innerHTML=`
      <div class="section-header">
        <h2>Facts</h2>
        <span>${M.length} in scope</span>
      </div>
    `;const he=document.createElement("div");he.className="section-content",he.appendChild(Sr(l,w,s.nodeId)),he.appendChild(Cr(l,w,s.nodeId)),ee.appendChild(he),a.appendChild(ee);const se=document.createElement("div");se.className="section",se.innerHTML=`
      <div class="section-header">
        <h2>Query</h2>
      </div>
    `;const ve=document.createElement("div");ve.className="section-content",ve.appendChild(Ar(l,w)),se.appendChild(ve),a.appendChild(se);const ge=document.createElement("div");ge.className="section",ge.innerHTML=`
      <div class="section-header">
        <h2>Connect</h2>
      </div>
    `;const pe=document.createElement("div");pe.className="section-content",Wn(pe,x),ge.appendChild(pe),a.appendChild(ge)}A(),l.onAdd(()=>A()),x.onChange(()=>A())}let Se=null;function ft(a){const n=new Vn,r=new Hn(a,n);return{identity:a,store:n,mesh:r}}function ke(a){const n=qn(a);if(!n)return!1;Se=ft(n),dt(n,Se.store),console.log("Switched to Node ID:",n.nodeId);const r=document.getElementById("app");return r&&ot(r,Se,{onSwitchActor:ke,onCreateActor:at,onImportActor:ct,onExportActor:st,onDeleteActor:it,onRenameActor:lt,getActors:Te,getCurrentActorId:rt}),!0}function at(a){const n=gn(a);Se=ft(n),dt(n,Se.store);const r=document.getElementById("app");return r&&ot(r,Se,{onSwitchActor:ke,onCreateActor:at,onImportActor:ct,onExportActor:st,onDeleteActor:it,onRenameActor:lt,getActors:Te,getCurrentActorId:rt}),n}function ct(a){const n=Yn(a);if(!n)return null;Se=ft(n),dt(n,Se.store);const r=document.getElementById("app");return r&&ot(r,Se,{onSwitchActor:ke,onCreateActor:at,onImportActor:ct,onExportActor:st,onDeleteActor:it,onRenameActor:lt,getActors:Te,getCurrentActorId:rt}),n}function st(a){return Fn(a)}function it(a){if(Te().length<=1)return alert("Cannot delete the last actor"),!1;if(jn(a),Se?.identity.nodeId===a){const r=Te();r.length>0&&ke(r[0].id)}return!0}function lt(a,n){Dn(a,n)}function dt(a,n){if(!n.findByScope(a.nodeId).find(s=>s.fact[0]==="name")){const l=Te().find(x=>x.id===a.nodeId)?.name||a.nodeId;n.add(["name",l],a.nodeId,a.nodeId)}}function Ir(){const a=Rn();console.log("Node ID:",a.nodeId),Se=ft(a),dt(a,Se.store),ot(document.getElementById("app"),Se,{onSwitchActor:ke,onCreateActor:at,onImportActor:ct,onExportActor:st,onDeleteActor:it,onRenameActor:lt,getActors:Te,getCurrentActorId:rt})}Ir();
