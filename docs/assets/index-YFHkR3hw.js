(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))f(i);new MutationObserver(i=>{for(const d of i)if(d.type==="childList")for(const x of d.addedNodes)x.tagName==="LINK"&&x.rel==="modulepreload"&&f(x)}).observe(document,{childList:!0,subtree:!0});function r(i){const d={};return i.integrity&&(d.integrity=i.integrity),i.referrerPolicy&&(d.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?d.credentials="include":i.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function f(i){if(i.ep)return;i.ep=!0;const d=r(i);fetch(i.href,d)}})();var Mn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Pn(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}function Tn(a){if(a.__esModule)return a;var t=a.default;if(typeof t=="function"){var r=function f(){return this instanceof f?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(a).forEach(function(f){var i=Object.getOwnPropertyDescriptor(a,f);Object.defineProperty(r,f,i.get?i:{enumerable:!0,get:function(){return a[f]}})}),r}function Un(a){throw new Error('Could not dynamically require "'+a+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var xn={exports:{}};const Kn={},$n=Object.freeze(Object.defineProperty({__proto__:null,default:Kn},Symbol.toStringTag,{value:"Module"})),jn=Tn($n);(function(a){(function(t){var r=function(n){var s,o=new Float64Array(16);if(n)for(s=0;s<n.length;s++)o[s]=n[s];return o},f=function(){throw new Error("no PRNG")},i=new Uint8Array(16),d=new Uint8Array(32);d[0]=9;var x=r(),v=r([1]),S=r([56129,1]),M=r([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),E=r([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),P=r([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),_=r([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),I=r([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function D(n,s,o,e){n[s]=o>>24&255,n[s+1]=o>>16&255,n[s+2]=o>>8&255,n[s+3]=o&255,n[s+4]=e>>24&255,n[s+5]=e>>16&255,n[s+6]=e>>8&255,n[s+7]=e&255}function q(n,s,o,e,c){var u,p=0;for(u=0;u<c;u++)p|=n[s+u]^o[e+u];return(1&p-1>>>8)-1}function W(n,s,o,e){return q(n,s,o,e,16)}function ie(n,s,o,e){return q(n,s,o,e,32)}function fe(n,s,o,e){for(var c=e[0]&255|(e[1]&255)<<8|(e[2]&255)<<16|(e[3]&255)<<24,u=o[0]&255|(o[1]&255)<<8|(o[2]&255)<<16|(o[3]&255)<<24,p=o[4]&255|(o[5]&255)<<8|(o[6]&255)<<16|(o[7]&255)<<24,g=o[8]&255|(o[9]&255)<<8|(o[10]&255)<<16|(o[11]&255)<<24,A=o[12]&255|(o[13]&255)<<8|(o[14]&255)<<16|(o[15]&255)<<24,j=e[4]&255|(e[5]&255)<<8|(e[6]&255)<<16|(e[7]&255)<<24,L=s[0]&255|(s[1]&255)<<8|(s[2]&255)<<16|(s[3]&255)<<24,oe=s[4]&255|(s[5]&255)<<8|(s[6]&255)<<16|(s[7]&255)<<24,T=s[8]&255|(s[9]&255)<<8|(s[10]&255)<<16|(s[11]&255)<<24,Y=s[12]&255|(s[13]&255)<<8|(s[14]&255)<<16|(s[15]&255)<<24,k=e[8]&255|(e[9]&255)<<8|(e[10]&255)<<16|(e[11]&255)<<24,H=o[16]&255|(o[17]&255)<<8|(o[18]&255)<<16|(o[19]&255)<<24,z=o[20]&255|(o[21]&255)<<8|(o[22]&255)<<16|(o[23]&255)<<24,F=o[24]&255|(o[25]&255)<<8|(o[26]&255)<<16|(o[27]&255)<<24,G=o[28]&255|(o[29]&255)<<8|(o[30]&255)<<16|(o[31]&255)<<24,V=e[12]&255|(e[13]&255)<<8|(e[14]&255)<<16|(e[15]&255)<<24,U=c,O=u,B=p,K=g,$=A,N=j,h=L,y=oe,w=T,m=Y,b=k,C=H,R=z,J=F,X=G,Z=V,l,ee=0;ee<20;ee+=2)l=U+R|0,$^=l<<7|l>>>25,l=$+U|0,w^=l<<9|l>>>23,l=w+$|0,R^=l<<13|l>>>19,l=R+w|0,U^=l<<18|l>>>14,l=N+O|0,m^=l<<7|l>>>25,l=m+N|0,J^=l<<9|l>>>23,l=J+m|0,O^=l<<13|l>>>19,l=O+J|0,N^=l<<18|l>>>14,l=b+h|0,X^=l<<7|l>>>25,l=X+b|0,B^=l<<9|l>>>23,l=B+X|0,h^=l<<13|l>>>19,l=h+B|0,b^=l<<18|l>>>14,l=Z+C|0,K^=l<<7|l>>>25,l=K+Z|0,y^=l<<9|l>>>23,l=y+K|0,C^=l<<13|l>>>19,l=C+y|0,Z^=l<<18|l>>>14,l=U+K|0,O^=l<<7|l>>>25,l=O+U|0,B^=l<<9|l>>>23,l=B+O|0,K^=l<<13|l>>>19,l=K+B|0,U^=l<<18|l>>>14,l=N+$|0,h^=l<<7|l>>>25,l=h+N|0,y^=l<<9|l>>>23,l=y+h|0,$^=l<<13|l>>>19,l=$+y|0,N^=l<<18|l>>>14,l=b+m|0,C^=l<<7|l>>>25,l=C+b|0,w^=l<<9|l>>>23,l=w+C|0,m^=l<<13|l>>>19,l=m+w|0,b^=l<<18|l>>>14,l=Z+X|0,R^=l<<7|l>>>25,l=R+Z|0,J^=l<<9|l>>>23,l=J+R|0,X^=l<<13|l>>>19,l=X+J|0,Z^=l<<18|l>>>14;U=U+c|0,O=O+u|0,B=B+p|0,K=K+g|0,$=$+A|0,N=N+j|0,h=h+L|0,y=y+oe|0,w=w+T|0,m=m+Y|0,b=b+k|0,C=C+H|0,R=R+z|0,J=J+F|0,X=X+G|0,Z=Z+V|0,n[0]=U>>>0&255,n[1]=U>>>8&255,n[2]=U>>>16&255,n[3]=U>>>24&255,n[4]=O>>>0&255,n[5]=O>>>8&255,n[6]=O>>>16&255,n[7]=O>>>24&255,n[8]=B>>>0&255,n[9]=B>>>8&255,n[10]=B>>>16&255,n[11]=B>>>24&255,n[12]=K>>>0&255,n[13]=K>>>8&255,n[14]=K>>>16&255,n[15]=K>>>24&255,n[16]=$>>>0&255,n[17]=$>>>8&255,n[18]=$>>>16&255,n[19]=$>>>24&255,n[20]=N>>>0&255,n[21]=N>>>8&255,n[22]=N>>>16&255,n[23]=N>>>24&255,n[24]=h>>>0&255,n[25]=h>>>8&255,n[26]=h>>>16&255,n[27]=h>>>24&255,n[28]=y>>>0&255,n[29]=y>>>8&255,n[30]=y>>>16&255,n[31]=y>>>24&255,n[32]=w>>>0&255,n[33]=w>>>8&255,n[34]=w>>>16&255,n[35]=w>>>24&255,n[36]=m>>>0&255,n[37]=m>>>8&255,n[38]=m>>>16&255,n[39]=m>>>24&255,n[40]=b>>>0&255,n[41]=b>>>8&255,n[42]=b>>>16&255,n[43]=b>>>24&255,n[44]=C>>>0&255,n[45]=C>>>8&255,n[46]=C>>>16&255,n[47]=C>>>24&255,n[48]=R>>>0&255,n[49]=R>>>8&255,n[50]=R>>>16&255,n[51]=R>>>24&255,n[52]=J>>>0&255,n[53]=J>>>8&255,n[54]=J>>>16&255,n[55]=J>>>24&255,n[56]=X>>>0&255,n[57]=X>>>8&255,n[58]=X>>>16&255,n[59]=X>>>24&255,n[60]=Z>>>0&255,n[61]=Z>>>8&255,n[62]=Z>>>16&255,n[63]=Z>>>24&255}function xe(n,s,o,e){for(var c=e[0]&255|(e[1]&255)<<8|(e[2]&255)<<16|(e[3]&255)<<24,u=o[0]&255|(o[1]&255)<<8|(o[2]&255)<<16|(o[3]&255)<<24,p=o[4]&255|(o[5]&255)<<8|(o[6]&255)<<16|(o[7]&255)<<24,g=o[8]&255|(o[9]&255)<<8|(o[10]&255)<<16|(o[11]&255)<<24,A=o[12]&255|(o[13]&255)<<8|(o[14]&255)<<16|(o[15]&255)<<24,j=e[4]&255|(e[5]&255)<<8|(e[6]&255)<<16|(e[7]&255)<<24,L=s[0]&255|(s[1]&255)<<8|(s[2]&255)<<16|(s[3]&255)<<24,oe=s[4]&255|(s[5]&255)<<8|(s[6]&255)<<16|(s[7]&255)<<24,T=s[8]&255|(s[9]&255)<<8|(s[10]&255)<<16|(s[11]&255)<<24,Y=s[12]&255|(s[13]&255)<<8|(s[14]&255)<<16|(s[15]&255)<<24,k=e[8]&255|(e[9]&255)<<8|(e[10]&255)<<16|(e[11]&255)<<24,H=o[16]&255|(o[17]&255)<<8|(o[18]&255)<<16|(o[19]&255)<<24,z=o[20]&255|(o[21]&255)<<8|(o[22]&255)<<16|(o[23]&255)<<24,F=o[24]&255|(o[25]&255)<<8|(o[26]&255)<<16|(o[27]&255)<<24,G=o[28]&255|(o[29]&255)<<8|(o[30]&255)<<16|(o[31]&255)<<24,V=e[12]&255|(e[13]&255)<<8|(e[14]&255)<<16|(e[15]&255)<<24,U=c,O=u,B=p,K=g,$=A,N=j,h=L,y=oe,w=T,m=Y,b=k,C=H,R=z,J=F,X=G,Z=V,l,ee=0;ee<20;ee+=2)l=U+R|0,$^=l<<7|l>>>25,l=$+U|0,w^=l<<9|l>>>23,l=w+$|0,R^=l<<13|l>>>19,l=R+w|0,U^=l<<18|l>>>14,l=N+O|0,m^=l<<7|l>>>25,l=m+N|0,J^=l<<9|l>>>23,l=J+m|0,O^=l<<13|l>>>19,l=O+J|0,N^=l<<18|l>>>14,l=b+h|0,X^=l<<7|l>>>25,l=X+b|0,B^=l<<9|l>>>23,l=B+X|0,h^=l<<13|l>>>19,l=h+B|0,b^=l<<18|l>>>14,l=Z+C|0,K^=l<<7|l>>>25,l=K+Z|0,y^=l<<9|l>>>23,l=y+K|0,C^=l<<13|l>>>19,l=C+y|0,Z^=l<<18|l>>>14,l=U+K|0,O^=l<<7|l>>>25,l=O+U|0,B^=l<<9|l>>>23,l=B+O|0,K^=l<<13|l>>>19,l=K+B|0,U^=l<<18|l>>>14,l=N+$|0,h^=l<<7|l>>>25,l=h+N|0,y^=l<<9|l>>>23,l=y+h|0,$^=l<<13|l>>>19,l=$+y|0,N^=l<<18|l>>>14,l=b+m|0,C^=l<<7|l>>>25,l=C+b|0,w^=l<<9|l>>>23,l=w+C|0,m^=l<<13|l>>>19,l=m+w|0,b^=l<<18|l>>>14,l=Z+X|0,R^=l<<7|l>>>25,l=R+Z|0,J^=l<<9|l>>>23,l=J+R|0,X^=l<<13|l>>>19,l=X+J|0,Z^=l<<18|l>>>14;n[0]=U>>>0&255,n[1]=U>>>8&255,n[2]=U>>>16&255,n[3]=U>>>24&255,n[4]=N>>>0&255,n[5]=N>>>8&255,n[6]=N>>>16&255,n[7]=N>>>24&255,n[8]=b>>>0&255,n[9]=b>>>8&255,n[10]=b>>>16&255,n[11]=b>>>24&255,n[12]=Z>>>0&255,n[13]=Z>>>8&255,n[14]=Z>>>16&255,n[15]=Z>>>24&255,n[16]=h>>>0&255,n[17]=h>>>8&255,n[18]=h>>>16&255,n[19]=h>>>24&255,n[20]=y>>>0&255,n[21]=y>>>8&255,n[22]=y>>>16&255,n[23]=y>>>24&255,n[24]=w>>>0&255,n[25]=w>>>8&255,n[26]=w>>>16&255,n[27]=w>>>24&255,n[28]=m>>>0&255,n[29]=m>>>8&255,n[30]=m>>>16&255,n[31]=m>>>24&255}function ve(n,s,o,e){fe(n,s,o,e)}function be(n,s,o,e){xe(n,s,o,e)}var we=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function Ee(n,s,o,e,c,u,p){var g=new Uint8Array(16),A=new Uint8Array(64),j,L;for(L=0;L<16;L++)g[L]=0;for(L=0;L<8;L++)g[L]=u[L];for(;c>=64;){for(ve(A,g,p,we),L=0;L<64;L++)n[s+L]=o[e+L]^A[L];for(j=1,L=8;L<16;L++)j=j+(g[L]&255)|0,g[L]=j&255,j>>>=8;c-=64,s+=64,e+=64}if(c>0)for(ve(A,g,p,we),L=0;L<c;L++)n[s+L]=o[e+L]^A[L];return 0}function Ne(n,s,o,e,c){var u=new Uint8Array(16),p=new Uint8Array(64),g,A;for(A=0;A<16;A++)u[A]=0;for(A=0;A<8;A++)u[A]=e[A];for(;o>=64;){for(ve(p,u,c,we),A=0;A<64;A++)n[s+A]=p[A];for(g=1,A=8;A<16;A++)g=g+(u[A]&255)|0,u[A]=g&255,g>>>=8;o-=64,s+=64}if(o>0)for(ve(p,u,c,we),A=0;A<o;A++)n[s+A]=p[A];return 0}function kt(n,s,o,e,c){var u=new Uint8Array(32);be(u,e,c,we);for(var p=new Uint8Array(8),g=0;g<8;g++)p[g]=e[g+16];return Ne(n,s,o,p,u)}function mt(n,s,o,e,c,u,p){var g=new Uint8Array(32);be(g,u,p,we);for(var A=new Uint8Array(8),j=0;j<8;j++)A[j]=u[j+16];return Ee(n,s,o,e,c,A,g)}var He=function(n){this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.leftover=0,this.fin=0;var s,o,e,c,u,p,g,A;s=n[0]&255|(n[1]&255)<<8,this.r[0]=s&8191,o=n[2]&255|(n[3]&255)<<8,this.r[1]=(s>>>13|o<<3)&8191,e=n[4]&255|(n[5]&255)<<8,this.r[2]=(o>>>10|e<<6)&7939,c=n[6]&255|(n[7]&255)<<8,this.r[3]=(e>>>7|c<<9)&8191,u=n[8]&255|(n[9]&255)<<8,this.r[4]=(c>>>4|u<<12)&255,this.r[5]=u>>>1&8190,p=n[10]&255|(n[11]&255)<<8,this.r[6]=(u>>>14|p<<2)&8191,g=n[12]&255|(n[13]&255)<<8,this.r[7]=(p>>>11|g<<5)&8065,A=n[14]&255|(n[15]&255)<<8,this.r[8]=(g>>>8|A<<8)&8191,this.r[9]=A>>>5&127,this.pad[0]=n[16]&255|(n[17]&255)<<8,this.pad[1]=n[18]&255|(n[19]&255)<<8,this.pad[2]=n[20]&255|(n[21]&255)<<8,this.pad[3]=n[22]&255|(n[23]&255)<<8,this.pad[4]=n[24]&255|(n[25]&255)<<8,this.pad[5]=n[26]&255|(n[27]&255)<<8,this.pad[6]=n[28]&255|(n[29]&255)<<8,this.pad[7]=n[30]&255|(n[31]&255)<<8};He.prototype.blocks=function(n,s,o){for(var e=this.fin?0:2048,c,u,p,g,A,j,L,oe,T,Y,k,H,z,F,G,V,U,O,B,K=this.h[0],$=this.h[1],N=this.h[2],h=this.h[3],y=this.h[4],w=this.h[5],m=this.h[6],b=this.h[7],C=this.h[8],R=this.h[9],J=this.r[0],X=this.r[1],Z=this.r[2],l=this.r[3],ee=this.r[4],se=this.r[5],ae=this.r[6],Q=this.r[7],ne=this.r[8],re=this.r[9];o>=16;)c=n[s+0]&255|(n[s+1]&255)<<8,K+=c&8191,u=n[s+2]&255|(n[s+3]&255)<<8,$+=(c>>>13|u<<3)&8191,p=n[s+4]&255|(n[s+5]&255)<<8,N+=(u>>>10|p<<6)&8191,g=n[s+6]&255|(n[s+7]&255)<<8,h+=(p>>>7|g<<9)&8191,A=n[s+8]&255|(n[s+9]&255)<<8,y+=(g>>>4|A<<12)&8191,w+=A>>>1&8191,j=n[s+10]&255|(n[s+11]&255)<<8,m+=(A>>>14|j<<2)&8191,L=n[s+12]&255|(n[s+13]&255)<<8,b+=(j>>>11|L<<5)&8191,oe=n[s+14]&255|(n[s+15]&255)<<8,C+=(L>>>8|oe<<8)&8191,R+=oe>>>5|e,T=0,Y=T,Y+=K*J,Y+=$*(5*re),Y+=N*(5*ne),Y+=h*(5*Q),Y+=y*(5*ae),T=Y>>>13,Y&=8191,Y+=w*(5*se),Y+=m*(5*ee),Y+=b*(5*l),Y+=C*(5*Z),Y+=R*(5*X),T+=Y>>>13,Y&=8191,k=T,k+=K*X,k+=$*J,k+=N*(5*re),k+=h*(5*ne),k+=y*(5*Q),T=k>>>13,k&=8191,k+=w*(5*ae),k+=m*(5*se),k+=b*(5*ee),k+=C*(5*l),k+=R*(5*Z),T+=k>>>13,k&=8191,H=T,H+=K*Z,H+=$*X,H+=N*J,H+=h*(5*re),H+=y*(5*ne),T=H>>>13,H&=8191,H+=w*(5*Q),H+=m*(5*ae),H+=b*(5*se),H+=C*(5*ee),H+=R*(5*l),T+=H>>>13,H&=8191,z=T,z+=K*l,z+=$*Z,z+=N*X,z+=h*J,z+=y*(5*re),T=z>>>13,z&=8191,z+=w*(5*ne),z+=m*(5*Q),z+=b*(5*ae),z+=C*(5*se),z+=R*(5*ee),T+=z>>>13,z&=8191,F=T,F+=K*ee,F+=$*l,F+=N*Z,F+=h*X,F+=y*J,T=F>>>13,F&=8191,F+=w*(5*re),F+=m*(5*ne),F+=b*(5*Q),F+=C*(5*ae),F+=R*(5*se),T+=F>>>13,F&=8191,G=T,G+=K*se,G+=$*ee,G+=N*l,G+=h*Z,G+=y*X,T=G>>>13,G&=8191,G+=w*J,G+=m*(5*re),G+=b*(5*ne),G+=C*(5*Q),G+=R*(5*ae),T+=G>>>13,G&=8191,V=T,V+=K*ae,V+=$*se,V+=N*ee,V+=h*l,V+=y*Z,T=V>>>13,V&=8191,V+=w*X,V+=m*J,V+=b*(5*re),V+=C*(5*ne),V+=R*(5*Q),T+=V>>>13,V&=8191,U=T,U+=K*Q,U+=$*ae,U+=N*se,U+=h*ee,U+=y*l,T=U>>>13,U&=8191,U+=w*Z,U+=m*X,U+=b*J,U+=C*(5*re),U+=R*(5*ne),T+=U>>>13,U&=8191,O=T,O+=K*ne,O+=$*Q,O+=N*ae,O+=h*se,O+=y*ee,T=O>>>13,O&=8191,O+=w*l,O+=m*Z,O+=b*X,O+=C*J,O+=R*(5*re),T+=O>>>13,O&=8191,B=T,B+=K*re,B+=$*ne,B+=N*Q,B+=h*ae,B+=y*se,T=B>>>13,B&=8191,B+=w*ee,B+=m*l,B+=b*Z,B+=C*X,B+=R*J,T+=B>>>13,B&=8191,T=(T<<2)+T|0,T=T+Y|0,Y=T&8191,T=T>>>13,k+=T,K=Y,$=k,N=H,h=z,y=F,w=G,m=V,b=U,C=O,R=B,s+=16,o-=16;this.h[0]=K,this.h[1]=$,this.h[2]=N,this.h[3]=h,this.h[4]=y,this.h[5]=w,this.h[6]=m,this.h[7]=b,this.h[8]=C,this.h[9]=R},He.prototype.finish=function(n,s){var o=new Uint16Array(10),e,c,u,p;if(this.leftover){for(p=this.leftover,this.buffer[p++]=1;p<16;p++)this.buffer[p]=0;this.fin=1,this.blocks(this.buffer,0,16)}for(e=this.h[1]>>>13,this.h[1]&=8191,p=2;p<10;p++)this.h[p]+=e,e=this.h[p]>>>13,this.h[p]&=8191;for(this.h[0]+=e*5,e=this.h[0]>>>13,this.h[0]&=8191,this.h[1]+=e,e=this.h[1]>>>13,this.h[1]&=8191,this.h[2]+=e,o[0]=this.h[0]+5,e=o[0]>>>13,o[0]&=8191,p=1;p<10;p++)o[p]=this.h[p]+e,e=o[p]>>>13,o[p]&=8191;for(o[9]-=8192,c=(e^1)-1,p=0;p<10;p++)o[p]&=c;for(c=~c,p=0;p<10;p++)this.h[p]=this.h[p]&c|o[p];for(this.h[0]=(this.h[0]|this.h[1]<<13)&65535,this.h[1]=(this.h[1]>>>3|this.h[2]<<10)&65535,this.h[2]=(this.h[2]>>>6|this.h[3]<<7)&65535,this.h[3]=(this.h[3]>>>9|this.h[4]<<4)&65535,this.h[4]=(this.h[4]>>>12|this.h[5]<<1|this.h[6]<<14)&65535,this.h[5]=(this.h[6]>>>2|this.h[7]<<11)&65535,this.h[6]=(this.h[7]>>>5|this.h[8]<<8)&65535,this.h[7]=(this.h[8]>>>8|this.h[9]<<5)&65535,u=this.h[0]+this.pad[0],this.h[0]=u&65535,p=1;p<8;p++)u=(this.h[p]+this.pad[p]|0)+(u>>>16)|0,this.h[p]=u&65535;n[s+0]=this.h[0]>>>0&255,n[s+1]=this.h[0]>>>8&255,n[s+2]=this.h[1]>>>0&255,n[s+3]=this.h[1]>>>8&255,n[s+4]=this.h[2]>>>0&255,n[s+5]=this.h[2]>>>8&255,n[s+6]=this.h[3]>>>0&255,n[s+7]=this.h[3]>>>8&255,n[s+8]=this.h[4]>>>0&255,n[s+9]=this.h[4]>>>8&255,n[s+10]=this.h[5]>>>0&255,n[s+11]=this.h[5]>>>8&255,n[s+12]=this.h[6]>>>0&255,n[s+13]=this.h[6]>>>8&255,n[s+14]=this.h[7]>>>0&255,n[s+15]=this.h[7]>>>8&255},He.prototype.update=function(n,s,o){var e,c;if(this.leftover){for(c=16-this.leftover,c>o&&(c=o),e=0;e<c;e++)this.buffer[this.leftover+e]=n[s+e];if(o-=c,s+=c,this.leftover+=c,this.leftover<16)return;this.blocks(this.buffer,0,16),this.leftover=0}if(o>=16&&(c=o-o%16,this.blocks(n,s,c),s+=c,o-=c),o){for(e=0;e<o;e++)this.buffer[this.leftover+e]=n[s+e];this.leftover+=o}};function gt(n,s,o,e,c,u){var p=new He(u);return p.update(o,e,c),p.finish(n,s),0}function Ft(n,s,o,e,c,u){var p=new Uint8Array(16);return gt(p,0,o,e,c,u),W(n,s,p,0)}function bt(n,s,o,e,c){var u;if(o<32)return-1;for(mt(n,0,s,0,o,e,c),gt(n,16,n,32,o-32,n),u=0;u<16;u++)n[u]=0;return 0}function vt(n,s,o,e,c){var u,p=new Uint8Array(32);if(o<32||(kt(p,0,32,e,c),Ft(s,16,s,32,o-32,p)!==0))return-1;for(mt(n,0,s,0,o,e,c),u=0;u<32;u++)n[u]=0;return 0}function Be(n,s){var o;for(o=0;o<16;o++)n[o]=s[o]|0}function wt(n){var s,o,e=1;for(s=0;s<16;s++)o=n[s]+e+65535,e=Math.floor(o/65536),n[s]=o-e*65536;n[0]+=e-1+37*(e-1)}function Ke(n,s,o){for(var e,c=~(o-1),u=0;u<16;u++)e=c&(n[u]^s[u]),n[u]^=e,s[u]^=e}function $e(n,s){var o,e,c,u=r(),p=r();for(o=0;o<16;o++)p[o]=s[o];for(wt(p),wt(p),wt(p),e=0;e<2;e++){for(u[0]=p[0]-65517,o=1;o<15;o++)u[o]=p[o]-65535-(u[o-1]>>16&1),u[o-1]&=65535;u[15]=p[15]-32767-(u[14]>>16&1),c=u[15]>>16&1,u[14]&=65535,Ke(p,u,1-c)}for(o=0;o<16;o++)n[2*o]=p[o]&255,n[2*o+1]=p[o]>>8}function Vt(n,s){var o=new Uint8Array(32),e=new Uint8Array(32);return $e(o,n),$e(e,s),ie(o,0,e,0)}function Gt(n){var s=new Uint8Array(32);return $e(s,n),s[0]&1}function St(n,s){var o;for(o=0;o<16;o++)n[o]=s[2*o]+(s[2*o+1]<<8);n[15]&=32767}function Ie(n,s,o){for(var e=0;e<16;e++)n[e]=s[e]+o[e]}function _e(n,s,o){for(var e=0;e<16;e++)n[e]=s[e]-o[e]}function te(n,s,o){var e,c,u=0,p=0,g=0,A=0,j=0,L=0,oe=0,T=0,Y=0,k=0,H=0,z=0,F=0,G=0,V=0,U=0,O=0,B=0,K=0,$=0,N=0,h=0,y=0,w=0,m=0,b=0,C=0,R=0,J=0,X=0,Z=0,l=o[0],ee=o[1],se=o[2],ae=o[3],Q=o[4],ne=o[5],re=o[6],pe=o[7],ce=o[8],le=o[9],de=o[10],ue=o[11],he=o[12],ye=o[13],me=o[14],ge=o[15];e=s[0],u+=e*l,p+=e*ee,g+=e*se,A+=e*ae,j+=e*Q,L+=e*ne,oe+=e*re,T+=e*pe,Y+=e*ce,k+=e*le,H+=e*de,z+=e*ue,F+=e*he,G+=e*ye,V+=e*me,U+=e*ge,e=s[1],p+=e*l,g+=e*ee,A+=e*se,j+=e*ae,L+=e*Q,oe+=e*ne,T+=e*re,Y+=e*pe,k+=e*ce,H+=e*le,z+=e*de,F+=e*ue,G+=e*he,V+=e*ye,U+=e*me,O+=e*ge,e=s[2],g+=e*l,A+=e*ee,j+=e*se,L+=e*ae,oe+=e*Q,T+=e*ne,Y+=e*re,k+=e*pe,H+=e*ce,z+=e*le,F+=e*de,G+=e*ue,V+=e*he,U+=e*ye,O+=e*me,B+=e*ge,e=s[3],A+=e*l,j+=e*ee,L+=e*se,oe+=e*ae,T+=e*Q,Y+=e*ne,k+=e*re,H+=e*pe,z+=e*ce,F+=e*le,G+=e*de,V+=e*ue,U+=e*he,O+=e*ye,B+=e*me,K+=e*ge,e=s[4],j+=e*l,L+=e*ee,oe+=e*se,T+=e*ae,Y+=e*Q,k+=e*ne,H+=e*re,z+=e*pe,F+=e*ce,G+=e*le,V+=e*de,U+=e*ue,O+=e*he,B+=e*ye,K+=e*me,$+=e*ge,e=s[5],L+=e*l,oe+=e*ee,T+=e*se,Y+=e*ae,k+=e*Q,H+=e*ne,z+=e*re,F+=e*pe,G+=e*ce,V+=e*le,U+=e*de,O+=e*ue,B+=e*he,K+=e*ye,$+=e*me,N+=e*ge,e=s[6],oe+=e*l,T+=e*ee,Y+=e*se,k+=e*ae,H+=e*Q,z+=e*ne,F+=e*re,G+=e*pe,V+=e*ce,U+=e*le,O+=e*de,B+=e*ue,K+=e*he,$+=e*ye,N+=e*me,h+=e*ge,e=s[7],T+=e*l,Y+=e*ee,k+=e*se,H+=e*ae,z+=e*Q,F+=e*ne,G+=e*re,V+=e*pe,U+=e*ce,O+=e*le,B+=e*de,K+=e*ue,$+=e*he,N+=e*ye,h+=e*me,y+=e*ge,e=s[8],Y+=e*l,k+=e*ee,H+=e*se,z+=e*ae,F+=e*Q,G+=e*ne,V+=e*re,U+=e*pe,O+=e*ce,B+=e*le,K+=e*de,$+=e*ue,N+=e*he,h+=e*ye,y+=e*me,w+=e*ge,e=s[9],k+=e*l,H+=e*ee,z+=e*se,F+=e*ae,G+=e*Q,V+=e*ne,U+=e*re,O+=e*pe,B+=e*ce,K+=e*le,$+=e*de,N+=e*ue,h+=e*he,y+=e*ye,w+=e*me,m+=e*ge,e=s[10],H+=e*l,z+=e*ee,F+=e*se,G+=e*ae,V+=e*Q,U+=e*ne,O+=e*re,B+=e*pe,K+=e*ce,$+=e*le,N+=e*de,h+=e*ue,y+=e*he,w+=e*ye,m+=e*me,b+=e*ge,e=s[11],z+=e*l,F+=e*ee,G+=e*se,V+=e*ae,U+=e*Q,O+=e*ne,B+=e*re,K+=e*pe,$+=e*ce,N+=e*le,h+=e*de,y+=e*ue,w+=e*he,m+=e*ye,b+=e*me,C+=e*ge,e=s[12],F+=e*l,G+=e*ee,V+=e*se,U+=e*ae,O+=e*Q,B+=e*ne,K+=e*re,$+=e*pe,N+=e*ce,h+=e*le,y+=e*de,w+=e*ue,m+=e*he,b+=e*ye,C+=e*me,R+=e*ge,e=s[13],G+=e*l,V+=e*ee,U+=e*se,O+=e*ae,B+=e*Q,K+=e*ne,$+=e*re,N+=e*pe,h+=e*ce,y+=e*le,w+=e*de,m+=e*ue,b+=e*he,C+=e*ye,R+=e*me,J+=e*ge,e=s[14],V+=e*l,U+=e*ee,O+=e*se,B+=e*ae,K+=e*Q,$+=e*ne,N+=e*re,h+=e*pe,y+=e*ce,w+=e*le,m+=e*de,b+=e*ue,C+=e*he,R+=e*ye,J+=e*me,X+=e*ge,e=s[15],U+=e*l,O+=e*ee,B+=e*se,K+=e*ae,$+=e*Q,N+=e*ne,h+=e*re,y+=e*pe,w+=e*ce,m+=e*le,b+=e*de,C+=e*ue,R+=e*he,J+=e*ye,X+=e*me,Z+=e*ge,u+=38*O,p+=38*B,g+=38*K,A+=38*$,j+=38*N,L+=38*h,oe+=38*y,T+=38*w,Y+=38*m,k+=38*b,H+=38*C,z+=38*R,F+=38*J,G+=38*X,V+=38*Z,c=1,e=u+c+65535,c=Math.floor(e/65536),u=e-c*65536,e=p+c+65535,c=Math.floor(e/65536),p=e-c*65536,e=g+c+65535,c=Math.floor(e/65536),g=e-c*65536,e=A+c+65535,c=Math.floor(e/65536),A=e-c*65536,e=j+c+65535,c=Math.floor(e/65536),j=e-c*65536,e=L+c+65535,c=Math.floor(e/65536),L=e-c*65536,e=oe+c+65535,c=Math.floor(e/65536),oe=e-c*65536,e=T+c+65535,c=Math.floor(e/65536),T=e-c*65536,e=Y+c+65535,c=Math.floor(e/65536),Y=e-c*65536,e=k+c+65535,c=Math.floor(e/65536),k=e-c*65536,e=H+c+65535,c=Math.floor(e/65536),H=e-c*65536,e=z+c+65535,c=Math.floor(e/65536),z=e-c*65536,e=F+c+65535,c=Math.floor(e/65536),F=e-c*65536,e=G+c+65535,c=Math.floor(e/65536),G=e-c*65536,e=V+c+65535,c=Math.floor(e/65536),V=e-c*65536,e=U+c+65535,c=Math.floor(e/65536),U=e-c*65536,u+=c-1+37*(c-1),c=1,e=u+c+65535,c=Math.floor(e/65536),u=e-c*65536,e=p+c+65535,c=Math.floor(e/65536),p=e-c*65536,e=g+c+65535,c=Math.floor(e/65536),g=e-c*65536,e=A+c+65535,c=Math.floor(e/65536),A=e-c*65536,e=j+c+65535,c=Math.floor(e/65536),j=e-c*65536,e=L+c+65535,c=Math.floor(e/65536),L=e-c*65536,e=oe+c+65535,c=Math.floor(e/65536),oe=e-c*65536,e=T+c+65535,c=Math.floor(e/65536),T=e-c*65536,e=Y+c+65535,c=Math.floor(e/65536),Y=e-c*65536,e=k+c+65535,c=Math.floor(e/65536),k=e-c*65536,e=H+c+65535,c=Math.floor(e/65536),H=e-c*65536,e=z+c+65535,c=Math.floor(e/65536),z=e-c*65536,e=F+c+65535,c=Math.floor(e/65536),F=e-c*65536,e=G+c+65535,c=Math.floor(e/65536),G=e-c*65536,e=V+c+65535,c=Math.floor(e/65536),V=e-c*65536,e=U+c+65535,c=Math.floor(e/65536),U=e-c*65536,u+=c-1+37*(c-1),n[0]=u,n[1]=p,n[2]=g,n[3]=A,n[4]=j,n[5]=L,n[6]=oe,n[7]=T,n[8]=Y,n[9]=k,n[10]=H,n[11]=z,n[12]=F,n[13]=G,n[14]=V,n[15]=U}function Ae(n,s){te(n,s,s)}function zt(n,s){var o=r(),e;for(e=0;e<16;e++)o[e]=s[e];for(e=253;e>=0;e--)Ae(o,o),e!==2&&e!==4&&te(o,o,s);for(e=0;e<16;e++)n[e]=o[e]}function Ht(n,s){var o=r(),e;for(e=0;e<16;e++)o[e]=s[e];for(e=250;e>=0;e--)Ae(o,o),e!==1&&te(o,o,s);for(e=0;e<16;e++)n[e]=o[e]}function Je(n,s,o){var e=new Uint8Array(32),c=new Float64Array(80),u,p,g=r(),A=r(),j=r(),L=r(),oe=r(),T=r();for(p=0;p<31;p++)e[p]=s[p];for(e[31]=s[31]&127|64,e[0]&=248,St(c,o),p=0;p<16;p++)A[p]=c[p],L[p]=g[p]=j[p]=0;for(g[0]=L[0]=1,p=254;p>=0;--p)u=e[p>>>3]>>>(p&7)&1,Ke(g,A,u),Ke(j,L,u),Ie(oe,g,j),_e(g,g,j),Ie(j,A,L),_e(A,A,L),Ae(L,oe),Ae(T,g),te(g,j,g),te(j,A,oe),Ie(oe,g,j),_e(g,g,j),Ae(A,g),_e(j,L,T),te(g,j,S),Ie(g,g,L),te(j,j,g),te(g,L,T),te(L,A,c),Ae(A,oe),Ke(g,A,u),Ke(j,L,u);for(p=0;p<16;p++)c[p+16]=g[p],c[p+32]=j[p],c[p+48]=A[p],c[p+64]=L[p];var Y=c.subarray(32),k=c.subarray(16);return zt(Y,Y),te(k,k,Y),$e(n,k),0}function Ze(n,s){return Je(n,s,d)}function Jt(n,s){return f(s,32),Ze(n,s)}function We(n,s,o){var e=new Uint8Array(32);return Je(e,o,s),be(n,i,e,we)}var Zt=bt,En=vt;function An(n,s,o,e,c,u){var p=new Uint8Array(32);return We(p,c,u),Zt(n,s,o,e,p)}function In(n,s,o,e,c,u){var p=new Uint8Array(32);return We(p,c,u),En(n,s,o,e,p)}var Wt=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591];function Xt(n,s,o,e){for(var c=new Int32Array(16),u=new Int32Array(16),p,g,A,j,L,oe,T,Y,k,H,z,F,G,V,U,O,B,K,$,N,h,y,w,m,b,C,R=n[0],J=n[1],X=n[2],Z=n[3],l=n[4],ee=n[5],se=n[6],ae=n[7],Q=s[0],ne=s[1],re=s[2],pe=s[3],ce=s[4],le=s[5],de=s[6],ue=s[7],he=0;e>=128;){for($=0;$<16;$++)N=8*$+he,c[$]=o[N+0]<<24|o[N+1]<<16|o[N+2]<<8|o[N+3],u[$]=o[N+4]<<24|o[N+5]<<16|o[N+6]<<8|o[N+7];for($=0;$<80;$++)if(p=R,g=J,A=X,j=Z,L=l,oe=ee,T=se,Y=ae,k=Q,H=ne,z=re,F=pe,G=ce,V=le,U=de,O=ue,h=ae,y=ue,w=y&65535,m=y>>>16,b=h&65535,C=h>>>16,h=(l>>>14|ce<<18)^(l>>>18|ce<<14)^(ce>>>9|l<<23),y=(ce>>>14|l<<18)^(ce>>>18|l<<14)^(l>>>9|ce<<23),w+=y&65535,m+=y>>>16,b+=h&65535,C+=h>>>16,h=l&ee^~l&se,y=ce&le^~ce&de,w+=y&65535,m+=y>>>16,b+=h&65535,C+=h>>>16,h=Wt[$*2],y=Wt[$*2+1],w+=y&65535,m+=y>>>16,b+=h&65535,C+=h>>>16,h=c[$%16],y=u[$%16],w+=y&65535,m+=y>>>16,b+=h&65535,C+=h>>>16,m+=w>>>16,b+=m>>>16,C+=b>>>16,B=b&65535|C<<16,K=w&65535|m<<16,h=B,y=K,w=y&65535,m=y>>>16,b=h&65535,C=h>>>16,h=(R>>>28|Q<<4)^(Q>>>2|R<<30)^(Q>>>7|R<<25),y=(Q>>>28|R<<4)^(R>>>2|Q<<30)^(R>>>7|Q<<25),w+=y&65535,m+=y>>>16,b+=h&65535,C+=h>>>16,h=R&J^R&X^J&X,y=Q&ne^Q&re^ne&re,w+=y&65535,m+=y>>>16,b+=h&65535,C+=h>>>16,m+=w>>>16,b+=m>>>16,C+=b>>>16,Y=b&65535|C<<16,O=w&65535|m<<16,h=j,y=F,w=y&65535,m=y>>>16,b=h&65535,C=h>>>16,h=B,y=K,w+=y&65535,m+=y>>>16,b+=h&65535,C+=h>>>16,m+=w>>>16,b+=m>>>16,C+=b>>>16,j=b&65535|C<<16,F=w&65535|m<<16,J=p,X=g,Z=A,l=j,ee=L,se=oe,ae=T,R=Y,ne=k,re=H,pe=z,ce=F,le=G,de=V,ue=U,Q=O,$%16===15)for(N=0;N<16;N++)h=c[N],y=u[N],w=y&65535,m=y>>>16,b=h&65535,C=h>>>16,h=c[(N+9)%16],y=u[(N+9)%16],w+=y&65535,m+=y>>>16,b+=h&65535,C+=h>>>16,B=c[(N+1)%16],K=u[(N+1)%16],h=(B>>>1|K<<31)^(B>>>8|K<<24)^B>>>7,y=(K>>>1|B<<31)^(K>>>8|B<<24)^(K>>>7|B<<25),w+=y&65535,m+=y>>>16,b+=h&65535,C+=h>>>16,B=c[(N+14)%16],K=u[(N+14)%16],h=(B>>>19|K<<13)^(K>>>29|B<<3)^B>>>6,y=(K>>>19|B<<13)^(B>>>29|K<<3)^(K>>>6|B<<26),w+=y&65535,m+=y>>>16,b+=h&65535,C+=h>>>16,m+=w>>>16,b+=m>>>16,C+=b>>>16,c[N]=b&65535|C<<16,u[N]=w&65535|m<<16;h=R,y=Q,w=y&65535,m=y>>>16,b=h&65535,C=h>>>16,h=n[0],y=s[0],w+=y&65535,m+=y>>>16,b+=h&65535,C+=h>>>16,m+=w>>>16,b+=m>>>16,C+=b>>>16,n[0]=R=b&65535|C<<16,s[0]=Q=w&65535|m<<16,h=J,y=ne,w=y&65535,m=y>>>16,b=h&65535,C=h>>>16,h=n[1],y=s[1],w+=y&65535,m+=y>>>16,b+=h&65535,C+=h>>>16,m+=w>>>16,b+=m>>>16,C+=b>>>16,n[1]=J=b&65535|C<<16,s[1]=ne=w&65535|m<<16,h=X,y=re,w=y&65535,m=y>>>16,b=h&65535,C=h>>>16,h=n[2],y=s[2],w+=y&65535,m+=y>>>16,b+=h&65535,C+=h>>>16,m+=w>>>16,b+=m>>>16,C+=b>>>16,n[2]=X=b&65535|C<<16,s[2]=re=w&65535|m<<16,h=Z,y=pe,w=y&65535,m=y>>>16,b=h&65535,C=h>>>16,h=n[3],y=s[3],w+=y&65535,m+=y>>>16,b+=h&65535,C+=h>>>16,m+=w>>>16,b+=m>>>16,C+=b>>>16,n[3]=Z=b&65535|C<<16,s[3]=pe=w&65535|m<<16,h=l,y=ce,w=y&65535,m=y>>>16,b=h&65535,C=h>>>16,h=n[4],y=s[4],w+=y&65535,m+=y>>>16,b+=h&65535,C+=h>>>16,m+=w>>>16,b+=m>>>16,C+=b>>>16,n[4]=l=b&65535|C<<16,s[4]=ce=w&65535|m<<16,h=ee,y=le,w=y&65535,m=y>>>16,b=h&65535,C=h>>>16,h=n[5],y=s[5],w+=y&65535,m+=y>>>16,b+=h&65535,C+=h>>>16,m+=w>>>16,b+=m>>>16,C+=b>>>16,n[5]=ee=b&65535|C<<16,s[5]=le=w&65535|m<<16,h=se,y=de,w=y&65535,m=y>>>16,b=h&65535,C=h>>>16,h=n[6],y=s[6],w+=y&65535,m+=y>>>16,b+=h&65535,C+=h>>>16,m+=w>>>16,b+=m>>>16,C+=b>>>16,n[6]=se=b&65535|C<<16,s[6]=de=w&65535|m<<16,h=ae,y=ue,w=y&65535,m=y>>>16,b=h&65535,C=h>>>16,h=n[7],y=s[7],w+=y&65535,m+=y>>>16,b+=h&65535,C+=h>>>16,m+=w>>>16,b+=m>>>16,C+=b>>>16,n[7]=ae=b&65535|C<<16,s[7]=ue=w&65535|m<<16,he+=128,e-=128}return e}function Pe(n,s,o){var e=new Int32Array(8),c=new Int32Array(8),u=new Uint8Array(256),p,g=o;for(e[0]=1779033703,e[1]=3144134277,e[2]=1013904242,e[3]=2773480762,e[4]=1359893119,e[5]=2600822924,e[6]=528734635,e[7]=1541459225,c[0]=4089235720,c[1]=2227873595,c[2]=4271175723,c[3]=1595750129,c[4]=2917565137,c[5]=725511199,c[6]=4215389547,c[7]=327033209,Xt(e,c,s,o),o%=128,p=0;p<o;p++)u[p]=s[g-o+p];for(u[o]=128,o=256-128*(o<112?1:0),u[o-9]=0,D(u,o-8,g/536870912|0,g<<3),Xt(e,c,u,o),p=0;p<8;p++)D(n,8*p,e[p],c[p]);return 0}function Xe(n,s){var o=r(),e=r(),c=r(),u=r(),p=r(),g=r(),A=r(),j=r(),L=r();_e(o,n[1],n[0]),_e(L,s[1],s[0]),te(o,o,L),Ie(e,n[0],n[1]),Ie(L,s[0],s[1]),te(e,e,L),te(c,n[3],s[3]),te(c,c,E),te(u,n[2],s[2]),Ie(u,u,u),_e(p,e,o),_e(g,u,c),Ie(A,u,c),Ie(j,e,o),te(n[0],p,g),te(n[1],j,A),te(n[2],A,g),te(n[3],p,j)}function Qt(n,s,o){var e;for(e=0;e<4;e++)Ke(n[e],s[e],o)}function Ct(n,s){var o=r(),e=r(),c=r();zt(c,s[2]),te(o,s[0],c),te(e,s[1],c),$e(n,e),n[31]^=Gt(o)<<7}function Et(n,s,o){var e,c;for(Be(n[0],x),Be(n[1],v),Be(n[2],v),Be(n[3],x),c=255;c>=0;--c)e=o[c/8|0]>>(c&7)&1,Qt(n,s,e),Xe(s,n),Xe(n,n),Qt(n,s,e)}function Qe(n,s){var o=[r(),r(),r(),r()];Be(o[0],P),Be(o[1],_),Be(o[2],v),te(o[3],P,_),Et(n,o,s)}function At(n,s,o){var e=new Uint8Array(64),c=[r(),r(),r(),r()],u;for(o||f(s,32),Pe(e,s,32),e[0]&=248,e[31]&=127,e[31]|=64,Qe(c,e),Ct(n,c),u=0;u<32;u++)s[u+32]=n[u];return 0}var et=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function It(n,s){var o,e,c,u;for(e=63;e>=32;--e){for(o=0,c=e-32,u=e-12;c<u;++c)s[c]+=o-16*s[e]*et[c-(e-32)],o=Math.floor((s[c]+128)/256),s[c]-=o*256;s[c]+=o,s[e]=0}for(o=0,c=0;c<32;c++)s[c]+=o-(s[31]>>4)*et[c],o=s[c]>>8,s[c]&=255;for(c=0;c<32;c++)s[c]-=o*et[c];for(e=0;e<32;e++)s[e+1]+=s[e]>>8,n[e]=s[e]&255}function _t(n){var s=new Float64Array(64),o;for(o=0;o<64;o++)s[o]=n[o];for(o=0;o<64;o++)n[o]=0;It(n,s)}function en(n,s,o,e){var c=new Uint8Array(64),u=new Uint8Array(64),p=new Uint8Array(64),g,A,j=new Float64Array(64),L=[r(),r(),r(),r()];Pe(c,e,32),c[0]&=248,c[31]&=127,c[31]|=64;var oe=o+64;for(g=0;g<o;g++)n[64+g]=s[g];for(g=0;g<32;g++)n[32+g]=c[32+g];for(Pe(p,n.subarray(32),o+32),_t(p),Qe(L,p),Ct(n,L),g=32;g<64;g++)n[g]=e[g];for(Pe(u,n,o+64),_t(u),g=0;g<64;g++)j[g]=0;for(g=0;g<32;g++)j[g]=p[g];for(g=0;g<32;g++)for(A=0;A<32;A++)j[g+A]+=u[g]*c[A];return It(n.subarray(32),j),oe}function _n(n,s){var o=r(),e=r(),c=r(),u=r(),p=r(),g=r(),A=r();return Be(n[2],v),St(n[1],s),Ae(c,n[1]),te(u,c,M),_e(c,c,n[2]),Ie(u,n[2],u),Ae(p,u),Ae(g,p),te(A,g,p),te(o,A,c),te(o,o,u),Ht(o,o),te(o,o,c),te(o,o,u),te(o,o,u),te(n[0],o,u),Ae(e,n[0]),te(e,e,u),Vt(e,c)&&te(n[0],n[0],I),Ae(e,n[0]),te(e,e,u),Vt(e,c)?-1:(Gt(n[0])===s[31]>>7&&_e(n[0],x,n[0]),te(n[3],n[0],n[1]),0)}function Nt(n,s,o,e){var c,u=new Uint8Array(32),p=new Uint8Array(64),g=[r(),r(),r(),r()],A=[r(),r(),r(),r()];if(o<64||_n(A,e))return-1;for(c=0;c<o;c++)n[c]=s[c];for(c=0;c<32;c++)n[c+32]=e[c];if(Pe(p,n,o),_t(p),Et(g,A,p),Qe(A,s.subarray(32)),Xe(g,A),Ct(u,g),o-=64,ie(s,0,u,0)){for(c=0;c<o;c++)n[c]=0;return-1}for(c=0;c<o;c++)n[c]=s[c+64];return o}var Lt=32,tt=24,Re=32,je=16,De=32,nt=32,Ye=32,ke=32,Bt=32,tn=tt,Nn=Re,Ln=je,Me=64,Te=32,Oe=64,Mt=32,Pt=64;t.lowlevel={crypto_core_hsalsa20:be,crypto_stream_xor:mt,crypto_stream:kt,crypto_stream_salsa20_xor:Ee,crypto_stream_salsa20:Ne,crypto_onetimeauth:gt,crypto_onetimeauth_verify:Ft,crypto_verify_16:W,crypto_verify_32:ie,crypto_secretbox:bt,crypto_secretbox_open:vt,crypto_scalarmult:Je,crypto_scalarmult_base:Ze,crypto_box_beforenm:We,crypto_box_afternm:Zt,crypto_box:An,crypto_box_open:In,crypto_box_keypair:Jt,crypto_hash:Pe,crypto_sign:en,crypto_sign_keypair:At,crypto_sign_open:Nt,crypto_secretbox_KEYBYTES:Lt,crypto_secretbox_NONCEBYTES:tt,crypto_secretbox_ZEROBYTES:Re,crypto_secretbox_BOXZEROBYTES:je,crypto_scalarmult_BYTES:De,crypto_scalarmult_SCALARBYTES:nt,crypto_box_PUBLICKEYBYTES:Ye,crypto_box_SECRETKEYBYTES:ke,crypto_box_BEFORENMBYTES:Bt,crypto_box_NONCEBYTES:tn,crypto_box_ZEROBYTES:Nn,crypto_box_BOXZEROBYTES:Ln,crypto_sign_BYTES:Me,crypto_sign_PUBLICKEYBYTES:Te,crypto_sign_SECRETKEYBYTES:Oe,crypto_sign_SEEDBYTES:Mt,crypto_hash_BYTES:Pt,gf:r,D:M,L:et,pack25519:$e,unpack25519:St,M:te,A:Ie,S:Ae,Z:_e,pow2523:Ht,add:Xe,set25519:Be,modL:It,scalarmult:Et,scalarbase:Qe};function nn(n,s){if(n.length!==Lt)throw new Error("bad key size");if(s.length!==tt)throw new Error("bad nonce size")}function Bn(n,s){if(n.length!==Ye)throw new Error("bad public key size");if(s.length!==ke)throw new Error("bad secret key size")}function Se(){for(var n=0;n<arguments.length;n++)if(!(arguments[n]instanceof Uint8Array))throw new TypeError("unexpected type, use Uint8Array")}function rn(n){for(var s=0;s<n.length;s++)n[s]=0}t.randomBytes=function(n){var s=new Uint8Array(n);return f(s,n),s},t.secretbox=function(n,s,o){Se(n,s,o),nn(o,s);for(var e=new Uint8Array(Re+n.length),c=new Uint8Array(e.length),u=0;u<n.length;u++)e[u+Re]=n[u];return bt(c,e,e.length,s,o),c.subarray(je)},t.secretbox.open=function(n,s,o){Se(n,s,o),nn(o,s);for(var e=new Uint8Array(je+n.length),c=new Uint8Array(e.length),u=0;u<n.length;u++)e[u+je]=n[u];return e.length<32||vt(c,e,e.length,s,o)!==0?null:c.subarray(Re)},t.secretbox.keyLength=Lt,t.secretbox.nonceLength=tt,t.secretbox.overheadLength=je,t.scalarMult=function(n,s){if(Se(n,s),n.length!==nt)throw new Error("bad n size");if(s.length!==De)throw new Error("bad p size");var o=new Uint8Array(De);return Je(o,n,s),o},t.scalarMult.base=function(n){if(Se(n),n.length!==nt)throw new Error("bad n size");var s=new Uint8Array(De);return Ze(s,n),s},t.scalarMult.scalarLength=nt,t.scalarMult.groupElementLength=De,t.box=function(n,s,o,e){var c=t.box.before(o,e);return t.secretbox(n,s,c)},t.box.before=function(n,s){Se(n,s),Bn(n,s);var o=new Uint8Array(Bt);return We(o,n,s),o},t.box.after=t.secretbox,t.box.open=function(n,s,o,e){var c=t.box.before(o,e);return t.secretbox.open(n,s,c)},t.box.open.after=t.secretbox.open,t.box.keyPair=function(){var n=new Uint8Array(Ye),s=new Uint8Array(ke);return Jt(n,s),{publicKey:n,secretKey:s}},t.box.keyPair.fromSecretKey=function(n){if(Se(n),n.length!==ke)throw new Error("bad secret key size");var s=new Uint8Array(Ye);return Ze(s,n),{publicKey:s,secretKey:new Uint8Array(n)}},t.box.publicKeyLength=Ye,t.box.secretKeyLength=ke,t.box.sharedKeyLength=Bt,t.box.nonceLength=tn,t.box.overheadLength=t.secretbox.overheadLength,t.sign=function(n,s){if(Se(n,s),s.length!==Oe)throw new Error("bad secret key size");var o=new Uint8Array(Me+n.length);return en(o,n,n.length,s),o},t.sign.open=function(n,s){if(Se(n,s),s.length!==Te)throw new Error("bad public key size");var o=new Uint8Array(n.length),e=Nt(o,n,n.length,s);if(e<0)return null;for(var c=new Uint8Array(e),u=0;u<c.length;u++)c[u]=o[u];return c},t.sign.detached=function(n,s){for(var o=t.sign(n,s),e=new Uint8Array(Me),c=0;c<e.length;c++)e[c]=o[c];return e},t.sign.detached.verify=function(n,s,o){if(Se(n,s,o),s.length!==Me)throw new Error("bad signature size");if(o.length!==Te)throw new Error("bad public key size");var e=new Uint8Array(Me+n.length),c=new Uint8Array(Me+n.length),u;for(u=0;u<Me;u++)e[u]=s[u];for(u=0;u<n.length;u++)e[u+Me]=n[u];return Nt(c,e,e.length,o)>=0},t.sign.keyPair=function(){var n=new Uint8Array(Te),s=new Uint8Array(Oe);return At(n,s),{publicKey:n,secretKey:s}},t.sign.keyPair.fromSecretKey=function(n){if(Se(n),n.length!==Oe)throw new Error("bad secret key size");for(var s=new Uint8Array(Te),o=0;o<s.length;o++)s[o]=n[32+o];return{publicKey:s,secretKey:new Uint8Array(n)}},t.sign.keyPair.fromSeed=function(n){if(Se(n),n.length!==Mt)throw new Error("bad seed size");for(var s=new Uint8Array(Te),o=new Uint8Array(Oe),e=0;e<32;e++)o[e]=n[e];return At(s,o,!0),{publicKey:s,secretKey:o}},t.sign.publicKeyLength=Te,t.sign.secretKeyLength=Oe,t.sign.seedLength=Mt,t.sign.signatureLength=Me,t.hash=function(n){Se(n);var s=new Uint8Array(Pt);return Pe(s,n,n.length),s},t.hash.hashLength=Pt,t.verify=function(n,s){return Se(n,s),n.length===0||s.length===0||n.length!==s.length?!1:q(n,0,s,0,n.length)===0},t.setPRNG=function(n){f=n},function(){var n=typeof self<"u"?self.crypto||self.msCrypto:null;if(n&&n.getRandomValues){var s=65536;t.setPRNG(function(o,e){var c,u=new Uint8Array(e);for(c=0;c<e;c+=s)n.getRandomValues(u.subarray(c,c+Math.min(e-c,s)));for(c=0;c<e;c++)o[c]=u[c];rn(u)})}else typeof Un<"u"&&(n=jn,n&&n.randomBytes&&t.setPRNG(function(o,e){var c,u=n.randomBytes(e);for(c=0;c<e;c++)o[c]=u[c];rn(u)}))}()})(a.exports?a.exports:self.nacl=self.nacl||{})})(xn);var On=xn.exports;const yn=Pn(On);var mn={exports:{}};(function(a){(function(t,r){a.exports?a.exports=r():(t.nacl||(t.nacl={}),t.nacl.util=r())})(Mn,function(){var t={};function r(f){if(!/^(?:[A-Za-z0-9+\/]{2}[A-Za-z0-9+\/]{2})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+\/]{3}=)?$/.test(f))throw new TypeError("invalid encoding")}return t.decodeUTF8=function(f){if(typeof f!="string")throw new TypeError("expected string");var i,d=unescape(encodeURIComponent(f)),x=new Uint8Array(d.length);for(i=0;i<d.length;i++)x[i]=d.charCodeAt(i);return x},t.encodeUTF8=function(f){var i,d=[];for(i=0;i<f.length;i++)d.push(String.fromCharCode(f[i]));return decodeURIComponent(escape(d.join("")))},typeof atob>"u"?typeof Buffer.from<"u"?(t.encodeBase64=function(f){return Buffer.from(f).toString("base64")},t.decodeBase64=function(f){return r(f),new Uint8Array(Array.prototype.slice.call(Buffer.from(f,"base64"),0))}):(t.encodeBase64=function(f){return new Buffer(f).toString("base64")},t.decodeBase64=function(f){return r(f),new Uint8Array(Array.prototype.slice.call(new Buffer(f,"base64"),0))}):(t.encodeBase64=function(f){var i,d=[],x=f.length;for(i=0;i<x;i++)d.push(String.fromCharCode(f[i]));return btoa(d.join(""))},t.decodeBase64=function(f){r(f);var i,d=atob(f),x=new Uint8Array(d.length);for(i=0;i<d.length;i++)x[i]=d.charCodeAt(i);return x}),t})})(mn);var gn=mn.exports;const Ut="meshlang_actors",Fe="meshlang_active_actor",on="meshlang_keys",rt="meshlang_active_key";function Ge(){const a=localStorage.getItem(Ut);if(a)try{const r=JSON.parse(a);return{actors:r.actors||r.keys||[]}}catch{return{actors:[]}}const t=localStorage.getItem(on);if(t)try{const f={actors:JSON.parse(t).keys||[]};localStorage.setItem(Ut,JSON.stringify(f)),localStorage.removeItem(on);const i=localStorage.getItem(rt);return i&&(localStorage.setItem(Fe,i),localStorage.removeItem(rt)),f}catch{return{actors:[]}}return{actors:[]}}function qt(a){localStorage.setItem(Ut,JSON.stringify(a))}function Rt(){const a=localStorage.getItem(Fe);if(a)return a;const t=localStorage.getItem(rt);return t?(localStorage.setItem(Fe,t),localStorage.removeItem(rt),t):null}function ft(a){localStorage.setItem(Fe,a)}function bn(){return Ge().actors}function Dt(a){return Ge().actors.find(r=>r.id===a)||null}function vn(a,t,r){const f=Ge(),i=f.actors.findIndex(x=>x.id===a),d={id:a,name:t,publicKey:Array.from(r.publicKey),secretKey:Array.from(r.secretKey),createdAt:Date.now()};i>=0?f.actors[i]=d:f.actors.push(d),qt(f)}function qn(a){const t=Ge();t.actors=t.actors.filter(r=>r.id!==a),qt(t),Rt()===a&&localStorage.removeItem(Fe)}function Rn(a,t){const r=Ge(),f=r.actors.find(i=>i.id===a);f&&(f.name=t,qt(r))}function Kt(a){return{publicKey:new Uint8Array(a.publicKey),secretKey:new Uint8Array(a.secretKey)}}function Dn(){const{publicKey:a,secretKey:t}=yn.sign.keyPair();return{publicKey:a,secretKey:t}}function Yt(a){const t=yn.hash(a);return gn.encodeBase64(t.slice(0,16)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function Ve(a){return{keyPair:a,nodeId:Yt(a.publicKey),publicKeyBase64:gn.encodeBase64(a.publicKey)}}function wn(a){const t=Dn(),r=Yt(t.publicKey),f=a||`Actor ${new Date().toLocaleString()}`;return vn(r,f,t),ft(r),Ve(t)}function Yn(a){const t=Dt(a);return t?(ft(a),Ve(Kt(t))):null}function kn(){const a=bn(),t=Rt();if(t){const r=Dt(t);if(r)return Ve(Kt(r))}return a.length>0?(ft(a[0].id),Ve(Kt(a[0]))):wn("Default Actor")}function Ue(){return bn()}function ct(){return Rt()}function Fn(a){try{const t=JSON.parse(atob(a));if(!t.publicKey||!t.secretKey)return null;const r={publicKey:new Uint8Array(t.publicKey),secretKey:new Uint8Array(t.secretKey)},f=Yt(r.publicKey),i=t.name||`Imported ${new Date().toLocaleString()}`;return vn(f,i,r),ft(f),Ve(r)}catch{return null}}function Vn(a){const t=Dt(a);if(!t)return null;const r={name:t.name,publicKey:t.publicKey,secretKey:t.secretKey};return btoa(JSON.stringify(r))}class Gn{facts=new Map;byScope=new Map;byKey=new Map;byValue=new Map;listeners=new Set;valueKey(t){return JSON.stringify(t)}factId(t,r){return`${r}:${t[0]}:${this.valueKey(t[1])}`}add(t,r,f){const i=f??r,d=this.factId(t,i);if(this.facts.has(d))return null;const x={id:d,fact:t,scope:i,timestamp:Date.now(),source:r};this.facts.set(d,x),this.byScope.has(i)||this.byScope.set(i,new Set),this.byScope.get(i).add(d),this.byKey.has(t[0])||this.byKey.set(t[0],new Set),this.byKey.get(t[0]).add(d);const v=this.valueKey(t[1]);this.byValue.has(v)||this.byValue.set(v,new Set),this.byValue.get(v).add(d);for(const S of this.listeners)S(x);return x}get(t){return this.facts.get(t)}has(t,r){return this.facts.has(this.factId(t,r))}retract(t,r){const f=this.factId(t,r);if(!this.facts.get(f))return!1;this.facts.delete(f);const d=this.byScope.get(r);d&&(d.delete(f),d.size===0&&this.byScope.delete(r));const x=this.byKey.get(t[0]);x&&(x.delete(f),x.size===0&&this.byKey.delete(t[0]));const v=this.valueKey(t[1]),S=this.byValue.get(v);return S&&(S.delete(f),S.size===0&&this.byValue.delete(v)),!0}all(){return Array.from(this.facts.values())}allIds(){return new Set(this.facts.keys())}findByScope(t){const r=this.byScope.get(t);return r?Array.from(r).map(f=>this.facts.get(f)):[]}findByKey(t){const r=this.byKey.get(t);return r?Array.from(r).map(f=>this.facts.get(f)):[]}findByValue(t){const r=this.byValue.get(this.valueKey(t));return r?Array.from(r).map(f=>this.facts.get(f)):[]}onAdd(t){return this.listeners.add(t),()=>this.listeners.delete(t)}addStored(t){if(this.facts.has(t.id))return!1;this.facts.set(t.id,t);const r=t.fact,f=t.scope;this.byScope.has(f)||this.byScope.set(f,new Set),this.byScope.get(f).add(t.id),this.byKey.has(r[0])||this.byKey.set(r[0],new Set),this.byKey.get(r[0]).add(t.id);const i=this.valueKey(r[1]);this.byValue.has(i)||this.byValue.set(i,new Set),this.byValue.get(i).add(t.id);for(const d of this.listeners)d(t);return!0}}function ot(a){return{id:a.id,k:a.fact[0],v:a.fact[1],sc:a.scope,t:a.timestamp,s:a.source}}function st(a){if("e"in a&&"a"in a){const r=a;return{id:r.id,fact:[r.a,r.v],scope:r.e,timestamp:r.t,source:r.s}}const t=a;return{id:t.id,fact:[t.k,t.v],scope:t.sc,timestamp:t.t,source:t.s}}function zn(a){return JSON.stringify(a)}function Hn(a){return JSON.parse(a)}class sn{constructor(t,r={iceServers:[{urls:"stun:stun.l.google.com:19302"}]}){this.isInitiator=t,this.config=r,this.connection=new RTCPeerConnection(this.config),this.connection.oniceconnectionstatechange=()=>{console.log("[Peer] ICE connection state:",this.connection.iceConnectionState),(this.connection.iceConnectionState==="disconnected"||this.connection.iceConnectionState==="failed")&&this.setState("disconnected")},this.connection.onconnectionstatechange=()=>{console.log("[Peer] Connection state:",this.connection.connectionState)},this.connection.onsignalingstatechange=()=>{console.log("[Peer] Signaling state:",this.connection.signalingState)},t?(this.channel=this.connection.createDataChannel("meshlang"),this.setupChannel(this.channel)):this.connection.ondatachannel=f=>{this.channel=f.channel,this.setupChannel(this.channel)}}connection;channel=null;state="connecting";messageHandlers=new Set;stateHandlers=new Set;pendingCandidates=[];remoteDescriptionSet=!1;remoteInfo=null;setupChannel(t){console.log("[Peer] Setting up data channel:",t.label),t.onopen=()=>{console.log("[Peer] Data channel opened"),this.setState("connected")},t.onclose=()=>{console.log("[Peer] Data channel closed"),this.setState("disconnected")},t.onerror=r=>{console.error("[Peer] Data channel error:",r)},t.onmessage=r=>{try{const f=Hn(r.data);console.log("[Peer] Received message:",f.type),f.type==="hello"&&(this.remoteInfo={nodeId:f.nodeId,publicKey:f.publicKey});for(const i of this.messageHandlers)i(f)}catch(f){console.error("Failed to decode message:",f)}}}setState(t){this.state=t;for(const r of this.stateHandlers)r(t)}getState(){return this.state}async createOffer(){console.log("[Peer] Creating offer");const t=await this.connection.createOffer();return await this.connection.setLocalDescription(t),console.log("[Peer] Offer created and local description set"),t}async acceptOffer(t){console.log("[Peer] Accepting offer"),await this.connection.setRemoteDescription(t),this.remoteDescriptionSet=!0,await this.flushPendingCandidates();const r=await this.connection.createAnswer();return await this.connection.setLocalDescription(r),console.log("[Peer] Answer created and local description set"),r}async acceptAnswer(t){console.log("[Peer] Accepting answer"),await this.connection.setRemoteDescription(t),this.remoteDescriptionSet=!0,await this.flushPendingCandidates(),console.log("[Peer] Answer accepted, remote description set")}async flushPendingCandidates(){for(const t of this.pendingCandidates)await this.connection.addIceCandidate(t);this.pendingCandidates=[]}async addIceCandidate(t){this.remoteDescriptionSet?await this.connection.addIceCandidate(t):this.pendingCandidates.push(t)}onIceCandidate(t){const r=this.connection.onicecandidate;this.connection.onicecandidate=f=>{f.candidate&&(console.log("[Peer] ICE candidate:",f.candidate.candidate?.substring(0,50)),t(f.candidate)),r&&r.call(this.connection,f)}}onIceGatheringComplete(t){const r=this.connection.onicecandidate;this.connection.onicecandidate=f=>{r&&r.call(this.connection,f),f.candidate||(console.log("[Peer] ICE gathering complete"),t())}}send(t){this.channel&&this.channel.readyState==="open"&&this.channel.send(zn(t))}onMessage(t){return this.messageHandlers.add(t),()=>this.messageHandlers.delete(t)}onStateChange(t){return this.stateHandlers.add(t),()=>this.stateHandlers.delete(t)}close(){this.channel?.close(),this.connection.close(),this.setState("disconnected")}}class Jn{constructor(t,r,f){this.nodeId=t,this.store=r,this.sendToNode=f}groups=new Map;proposals=new Map;pendingInvites=new Map;listeners=new Set;createGroup(t,r,f="unanimous"){const i={id:t,name:r,members:[this.nodeId],consensus:f};return this.groups.set(t,i),this.notifyListeners(),i}invitePeer(t,r){const f=this.groups.get(t);return!f||f.members.includes(r)?!1:(this.sendToNode(r,{type:"group-invite",groupId:f.id,groupName:f.name,from:this.nodeId,members:f.members}),!0)}handleInvite(t){this.pendingInvites.set(t.groupId,{groupId:t.groupId,groupName:t.groupName,from:t.from,members:t.members,timestamp:Date.now()}),this.notifyListeners()}respondToInvite(t,r){const f=this.pendingInvites.get(t);if(f){if(this.pendingInvites.delete(t),r){const i={id:t,name:f.groupName,members:[...f.members,this.nodeId],consensus:"unanimous"};this.groups.set(t,i);for(const d of f.members)this.sendToNode(d,{type:"group-sync-request",groupId:t,haveIds:[]})}for(const i of f.members)this.sendToNode(i,{type:"group-invite-response",groupId:t,accepted:r,from:this.nodeId});this.notifyListeners()}}handleInviteResponse(t){if(!t.accepted)return;const r=this.groups.get(t.groupId);r&&(r.members.includes(t.from)||(r.members.push(t.from),this.notifyListeners()))}proposeFact(t,r){const f=this.groups.get(t);if(!f)return null;const i=`proposal_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,d={id:i,groupId:t,fact:r,from:this.nodeId,votes:new Map([[this.nodeId,!0]]),timestamp:Date.now()};this.proposals.set(i,d);const x=ot(r);for(const v of f.members)v!==this.nodeId&&this.sendToNode(v,{type:"group-proposal",groupId:t,proposalId:i,fact:x,from:this.nodeId});return this.checkProposalConsensus(i),i}handleProposal(t){if(!this.groups.get(t.groupId))return;const f=st(t.fact),i={id:t.proposalId,groupId:t.groupId,fact:f,from:t.from,votes:new Map([[t.from,!0]]),timestamp:Date.now()};this.proposals.set(t.proposalId,i),this.notifyListeners()}vote(t,r){const f=this.proposals.get(t);if(!f)return;f.votes.set(this.nodeId,r);const i=this.groups.get(f.groupId);if(i)for(const d of i.members)d!==this.nodeId&&this.sendToNode(d,{type:"group-vote",groupId:f.groupId,proposalId:t,vote:r,from:this.nodeId});this.checkProposalConsensus(t)}handleVote(t){const r=this.proposals.get(t.proposalId);r&&(r.votes.set(t.from,t.vote),this.checkProposalConsensus(t.proposalId),this.notifyListeners())}checkProposalConsensus(t){const r=this.proposals.get(t);if(!r)return;const f=this.groups.get(r.groupId);if(!f)return;const i=f.members.length,d=Array.from(r.votes.values()),x=d.filter(E=>E).length,v=d.filter(E=>!E).length;let S=!1,M=!1;f.consensus==="unanimous"?(S=x===i,M=v>0):f.consensus==="majority"?(S=x>i/2,M=v>i/2):typeof f.consensus=="object"&&"threshold"in f.consensus&&(S=x>=f.consensus.threshold,M=v>i-f.consensus.threshold),S?(this.store.addStored(r.fact),this.proposals.delete(t),this.notifyListeners()):M&&(this.proposals.delete(t),this.notifyListeners())}handleSyncRequest(t){const r=this.groups.get(t.groupId);if(!r)return;const f=`${t.groupId}:root`,i=new Set(t.haveIds),d=this.store.findByScope(f).filter(x=>!i.has(x.id)).map(ot);for(const x of r.members)this.sendToNode(x,{type:"group-sync-response",groupId:t.groupId,facts:d})}handleSyncResponse(t){for(const r of t.facts){const f=st(r);this.store.addStored(f)}this.notifyListeners()}getGroups(){return Array.from(this.groups.values())}getPendingInvites(){return Array.from(this.pendingInvites.values())}getProposals(t){const r=Array.from(this.proposals.values());return t?r.filter(f=>f.groupId===t):r}getGroup(t){return this.groups.get(t)}isInGroup(t){return this.groups.has(t)}getGroupRootScope(t){return`${t}:root`}onChange(t){return this.listeners.add(t),()=>this.listeners.delete(t)}notifyListeners(){for(const t of this.listeners)t()}}class Zn{constructor(t,r){this.identity=t,this.store=r,this.groups=new Jn(t.nodeId,r,(f,i)=>this.sendToNode(f,i)),r.onAdd(f=>{const i={type:"fact-add",fact:ot(f)};this.broadcast(i)})}peers=new Map;listeners=new Set;groups;sendToNode(t,r){const f=this.peers.get(t);f&&f.getState()==="connected"&&f.send(r)}broadcast(t,r){for(const[f,i]of this.peers)f!==r&&i.getState()==="connected"&&i.send(t)}notifyListeners(){for(const t of this.listeners)t()}setupPeer(t){t.onStateChange(r=>{if(console.log("[Mesh] Peer state changed:",r,"remoteInfo:",t.remoteInfo?.nodeId),r==="connected"){console.log("[Mesh] Sending hello to peer"),t.send({type:"hello",nodeId:this.identity.nodeId,publicKey:this.identity.publicKeyBase64});const f=Array.from(this.store.allIds());console.log("[Mesh] Sending sync request with",f.length,"known facts"),t.send({type:"sync-request",haveIds:f}),this.notifyListeners()}r==="disconnected"&&t.remoteInfo&&(console.log("[Mesh] Peer disconnected:",t.remoteInfo.nodeId),this.peers.delete(t.remoteInfo.nodeId),this.notifyListeners())}),t.onMessage(r=>{console.log("[Mesh] Received message:",r.type),this.handleMessage(t,r)})}handleMessage(t,r){switch(r.type){case"hello":t.remoteInfo={nodeId:r.nodeId,publicKey:r.publicKey},this.peers.set(r.nodeId,t),this.notifyListeners();break;case"sync-request":{const f=new Set(r.haveIds),i=this.store.all().filter(d=>!f.has(d.id)).map(ot);t.send({type:"sync-response",facts:i});break}case"sync-response":for(const f of r.facts){const i=st(f);this.store.addStored(i)}break;case"fact-add":{const f=st(r.fact);this.store.addStored(f)&&this.broadcast(r,t.remoteInfo?.nodeId);break}case"peer-announce":break;case"group-invite":this.groups.handleInvite(r),this.notifyListeners();break;case"group-invite-response":this.groups.handleInviteResponse(r),this.notifyListeners();break;case"group-proposal":this.groups.handleProposal(r),this.notifyListeners();break;case"group-vote":this.groups.handleVote(r),this.notifyListeners();break;case"group-sync-request":this.groups.handleSyncRequest(r);break;case"group-sync-response":this.groups.handleSyncResponse(r),this.notifyListeners();break}}async createOffer(){console.log("[Mesh] Creating offer");const t=new sn(!0),r=[],f=new Promise(x=>{t.onIceCandidate(v=>{r.push(v)}),t.onIceGatheringComplete(()=>x())}),i=await t.createOffer();console.log("[Mesh] Waiting for ICE candidates..."),await f,console.log("[Mesh] Got",r.length,"ICE candidates");const d={type:"offer",nodeId:this.identity.nodeId,publicKey:this.identity.publicKeyBase64,sdp:i,candidates:r.map(x=>x.toJSON())};return this.peers.set("pending-offer",t),this.setupPeer(t),console.log("[Mesh] Offer created, waiting for answer"),btoa(JSON.stringify(d))}async acceptOffer(t){console.log("[Mesh] Accepting offer");const r=JSON.parse(atob(t));console.log("[Mesh] Offer from:",r.nodeId,"with",r.candidates.length,"candidates");const f=new sn(!1);f.remoteInfo={nodeId:r.nodeId,publicKey:r.publicKey};const i=[],d=new Promise(S=>{f.onIceCandidate(M=>{i.push(M)}),f.onIceGatheringComplete(()=>S())}),x=await f.acceptOffer(r.sdp);console.log("[Mesh] Adding",r.candidates.length,"remote ICE candidates");for(const S of r.candidates)await f.addIceCandidate(S);console.log("[Mesh] Waiting for local ICE candidates..."),await d,console.log("[Mesh] Got",i.length,"local ICE candidates"),this.peers.set(r.nodeId,f),this.setupPeer(f);const v={type:"answer",nodeId:this.identity.nodeId,publicKey:this.identity.publicKeyBase64,sdp:x,candidates:i.map(S=>S.toJSON())};return console.log("[Mesh] Answer created"),btoa(JSON.stringify(v))}async acceptAnswer(t){console.log("[Mesh] Accepting answer");const r=JSON.parse(atob(t));console.log("[Mesh] Answer from:",r.nodeId,"with",r.candidates.length,"candidates");const f=this.peers.get("pending-offer");if(!f)throw new Error("No pending offer to accept answer for");this.peers.delete("pending-offer"),f.remoteInfo={nodeId:r.nodeId,publicKey:r.publicKey},this.peers.set(r.nodeId,f),await f.acceptAnswer(r.sdp),console.log("[Mesh] Adding",r.candidates.length,"remote ICE candidates");for(const i of r.candidates)await f.addIceCandidate(i);console.log("[Mesh] Connection established")}getPeers(){const t=[];for(const r of this.peers.values())r.remoteInfo&&r.getState()==="connected"&&t.push(r.remoteInfo);return t}getPeerCount(){return this.getPeers().length}onChange(t){return this.listeners.add(t),()=>this.listeners.delete(t)}}class qe{constructor(t){this.name=t}static isVar(t){return t instanceof qe}}function Tt(a,t,r){if(qe.isVar(a)){const f=r.get(a.name);if(f!==void 0)return f===t?r:null;const i=new Map(r);return i.set(a.name,t),i}return a===t?r:null}function Wn(a,t,r,f){let i=r;return f!==void 0&&(i=Tt(f,t.scope,i),!i)||(i=Tt(a[0],t.fact[0],i),!i)?null:(i=Tt(a[1],t.fact[1],i),i)}function Xn(a,t,r){if(t.length===0)return[new Map];let f=[new Map];for(const i of t){const d=[];for(const x of f){let v;const[S,M]=i;r?.scope?v=a.findByScope(r.scope):!qe.isVar(S)&&typeof S=="string"?v=a.findByKey(S):v=a.all(),r?.scope&&!qe.isVar(S)&&(v=v.filter(E=>E.fact[0]===S));for(const E of v){const P=Wn(i,E,x,r?.scopePattern);P&&d.push(P)}}f=d}return f}function an(a){return new qe(a)}function Qn(a){const t={};for(const[r,f]of a)t[`?${r}`]=f;return t}async function fn(a){await navigator.clipboard.writeText(a)}function er(a,t,r){a.innerHTML=`
    <div class="exchange">
      <h3>Connect to Peer</h3>
      <div class="exchange-tabs">
        <button class="tab active" data-tab="initiate">Create Invite</button>
        <button class="tab" data-tab="join">Join with Invite</button>
      </div>

      <div class="tab-content" id="initiate-tab">
        <p>1. Click "Generate" to create an invite code</p>
        <button id="generate-offer">Generate Invite</button>
        <textarea id="offer-output" readonly placeholder="Invite code will appear here..."></textarea>
        <button id="copy-offer" disabled>Copy to Clipboard</button>

        <p>2. Share the code with peer, then paste their response:</p>
        <textarea id="answer-input" placeholder="Paste peer's response here..."></textarea>
        <button id="accept-answer" disabled>Connect</button>
      </div>

      <div class="tab-content hidden" id="join-tab">
        <p>1. Paste the invite code from your peer:</p>
        <textarea id="offer-input" placeholder="Paste invite code here..."></textarea>
        <button id="accept-offer">Accept Invite</button>

        <p>2. Copy the response and send it back:</p>
        <textarea id="answer-output" readonly placeholder="Response will appear here..."></textarea>
        <button id="copy-answer" disabled>Copy to Clipboard</button>
      </div>
    </div>
  `;const f=a.querySelectorAll(".tab"),i=a.querySelector("#initiate-tab"),d=a.querySelector("#join-tab");f.forEach(q=>{q.addEventListener("click",()=>{f.forEach(ie=>ie.classList.remove("active")),q.classList.add("active");const W=q.dataset.tab;i.classList.toggle("hidden",W!=="initiate"),d.classList.toggle("hidden",W!=="join")})});const x=a.querySelector("#generate-offer"),v=a.querySelector("#offer-output"),S=a.querySelector("#copy-offer"),M=a.querySelector("#answer-input"),E=a.querySelector("#accept-answer");x.addEventListener("click",async()=>{x.disabled=!0,x.textContent="Generating...";try{const q=await t.createOffer();v.value=q,S.disabled=!1,E.disabled=!1}catch(q){v.value=`Error: ${q}`}x.disabled=!1,x.textContent="Generate Invite"}),S.addEventListener("click",async()=>{await fn(v.value),S.textContent="Copied!",setTimeout(()=>S.textContent="Copy to Clipboard",2e3)}),E.addEventListener("click",async()=>{const q=M.value.trim();if(q)try{await t.acceptAnswer(q)}catch(W){alert(`Failed to connect: ${W}`)}});const P=a.querySelector("#offer-input"),_=a.querySelector("#accept-offer"),I=a.querySelector("#answer-output"),D=a.querySelector("#copy-answer");_.addEventListener("click",async()=>{const q=P.value.trim();if(q){_.disabled=!0,_.textContent="Processing...";try{const W=await t.acceptOffer(q);I.value=W,D.disabled=!1}catch(W){I.value=`Error: ${W}`}_.disabled=!1,_.textContent="Accept Invite"}}),D.addEventListener("click",async()=>{await fn(I.value),D.textContent="Copied!",setTimeout(()=>D.textContent="Copy to Clipboard",2e3)})}function cn(a,t){const f=a.findByScope(t).find(i=>i.fact[0]==="name");return f?String(f.fact[1]):t.slice(0,8)}function tr(a,t){const f=a.findByScope(t).find(d=>d.fact[0]==="parents");if(!f)return[];const i=f.fact[1];return Array.isArray(i)?i:typeof i=="string"?[i]:[]}function nr(a,t){const r=a.findByScope(t),f=[],i=/^(\w+)\((.+)\)$/;for(const d of r){const x=d.fact[0];if(x.match(i)){const S=d.id;let M=x;const E=x.match(/symbol\("([^"]+)"\)/);E&&(M=E[1]),f.push({id:S,key:x,displayName:M})}}return f}function rr(a,t){return{currentScope:t,path:[...a.path,t]}}function or(a){if(a.path.length<=1)return null;const t=a.path.slice(0,-1);return{currentScope:t[t.length-1],path:t}}function sr(a,t){return t<0||t>=a.path.length?a:{currentScope:a.path[t],path:a.path.slice(0,t+1)}}function ar(a,t,r){if(t<=0||t>=a.path.length)return a;const f=[...a.path];return f[t-1]=r,{currentScope:a.currentScope,path:f}}function fr(a){return{currentScope:a,path:[a]}}function cr(a){return typeof a=="object"&&a!==null&&"type"in a&&a.type==="var"}function Sn(a){return typeof a=="object"&&a!==null&&"type"in a&&a.type==="constructor"}function ir(a){return typeof a=="object"&&a!==null&&"type"in a&&a.type==="scope"}function lr(a){return{type:"var",name:a}}function ln(a,...t){return{type:"constructor",name:a,args:t}}function dr(a){return{type:"scope",id:a}}function Cn(a){if(a===null)return"null";if(typeof a=="string")return`"${a}"`;if(typeof a=="number"||typeof a=="boolean")return String(a);if(cr(a))return`?${a.name}`;if(Sn(a)){if(a.args.length===0)return a.name;const t=a.args.map(Cn).join(", ");return`${a.name}(${t})`}return ir(a)?`@${a.id}`:String(a)}class Le extends Error{constructor(t,r){super(t),this.position=r,this.name="ParseError"}}function ur(a){const t=[];let r=0;for(;r<a.length;){if(/\s/.test(a[r])){r++;continue}if(a[r]==="?"){r++;let f="";for(;r<a.length&&/[\w]/.test(a[r]);)f+=a[r++];if(f.length===0)throw new Le("Expected variable name after ?",r);t.push({type:"variable",name:f});continue}if(a[r]==="@"){r++;let f="";for(;r<a.length&&/[\w\-]/.test(a[r]);)f+=a[r++];if(f.length===0)throw new Le("Expected scope id after @",r);t.push({type:"scope",id:f});continue}if(a[r]==='"'||a[r]==="'"){const f=a[r++];let i="";for(;r<a.length&&a[r]!==f;){if(a[r]==="\\"&&r+1<a.length)switch(r++,a[r]){case"n":i+=`
`;break;case"t":i+="	";break;case"\\":i+="\\";break;default:i+=a[r]}else i+=a[r];r++}if(r>=a.length)throw new Le("Unterminated string",r);r++,t.push({type:"string",value:i});continue}if(/[\d\-]/.test(a[r])){let f="";for(a[r]==="-"&&(f+=a[r++]);r<a.length&&/[\d\.]/.test(a[r]);)f+=a[r++];if(f==="-"||f===".")throw new Le("Invalid number",r);t.push({type:"number",value:parseFloat(f)});continue}if(a[r]==="("){t.push({type:"lparen"}),r++;continue}if(a[r]===")"){t.push({type:"rparen"}),r++;continue}if(a[r]===","){t.push({type:"comma"}),r++;continue}if(/[a-zA-Z_]/.test(a[r])){let f="";for(;r<a.length&&/[\w]/.test(a[r]);)f+=a[r++];f==="true"?t.push({type:"boolean",value:!0}):f==="false"?t.push({type:"boolean",value:!1}):f==="null"?t.push({type:"null"}):t.push({type:"identifier",value:f});continue}throw new Le(`Unexpected character: ${a[r]}`,r)}return t}function pr(a){const t=a.trim();if(t.length===0)return"";const r=ur(t);if(r.length===0)return"";let f=0;function i(){return r[f]}function d(){return r[f++]}function x(){const S=i();if(!S)throw new Le("Unexpected end of input",f);switch(S.type){case"number":return d(),S.value;case"string":return d(),S.value;case"boolean":return d(),S.value;case"null":return d(),null;case"variable":return d(),lr(S.name);case"scope":return d(),dr(S.id);case"identifier":{d();const M=S.value;if(i()?.type==="lparen"){d();const E=[];for(;i()&&i().type!=="rparen";)if(E.push(x()),i()?.type==="comma")d();else if(i()?.type!=="rparen")throw new Le("Expected , or )",f);if(i()?.type!=="rparen")throw new Le("Expected )",f);return d(),ln(M,...E)}return ln(M)}default:throw new Le(`Unexpected token: ${S.type}`,f)}}const v=x();if(f<r.length)throw new Le("Unexpected tokens after expression",f);return v}function hr(a){try{return pr(a)}catch{return null}}function xr(a){const r=a.trim().match(/^([a-zA-Z_]\w*)\s*\((.*)$/);if(!r)return null;const f=r[1],i=r[2];let d=0,x=0,v=!1,S="";for(const _ of i){if(v){_===S&&(v=!1);continue}if(_==='"'||_==="'"){v=!0,S=_;continue}_==="("?x++:_===")"?x--:_===","&&x===0&&d++}const M=i.lastIndexOf(","),P=(M===-1?i:i.slice(M+1)).trim().length>0||i.length===0;return{name:f,argCount:d,inArg:P}}function dn(a,t){const r=a.findByScope(t),f=[];for(const i of r)if(i.fact[0]==="constructor"){const d=i.fact[1];if(typeof d=="object"&&d!==null){const x=d;typeof x.name=="string"&&f.push({name:x.name,params:x.params||[],description:x.description})}else typeof d=="string"&&f.push({name:d,params:[]})}return f}function yr(a,t){const r=a.findByScope(t),f=new Set;for(const i of r)f.add(i.fact[0]);return Array.from(f)}function mr(a,t){const r=a.findByScope(t),f=new Set,i=[];for(const d of r){const x=d.fact[1];if(x!==null){const v=JSON.stringify(x);f.has(v)||(f.add(v),(typeof x=="string"||typeof x=="number"||typeof x=="boolean")&&i.push(x))}}return i}function gr(a,t){const f=a.findByScope(t).find(d=>d.fact[0]==="children");if(!f)return[];const i=f.fact[1];return Array.isArray(i)?i.map(d=>{const v=a.findByScope(d).find(M=>M.fact[0]==="name"),S=v?String(v.fact[1]):d.slice(0,8);return{id:d,name:S}}):[]}function br(a){return at.find(t=>t.name===a)}function vr(a){const t=a.match(/^(\w+)\(/);if(t)return t[1];if(at.find(f=>f.name===a&&f.params.length===0))return a}function wr(a,t,r,f){const i=[],d=r.toLowerCase();let x;if(f){const E=br(f);E&&(x=E.allowedChildren)}const v=x!==void 0&&x.length===0,S=yr(a,t);for(const E of S)E.toLowerCase().includes(d)&&i.push({text:E,display:E,type:"key"});if(!v){const E=dn(a,t),P=[...at,...E],_=new Set;for(const I of P)if(!_.has(I.name)&&(_.add(I.name),!(x!==void 0&&!x.includes(I.name))&&I.name.toLowerCase().includes(d)))if(I.params.length===0)i.push({text:I.name,display:I.name,description:I.description,type:"constructor"});else{const D=I.params.map(q=>q.name).join(", ");i.push({text:`${I.name}(`,display:`${I.name}(${D})`,description:I.description,type:"constructor",completion:`${I.name}()`})}}const M=xr(r);if(M){const P=[...at,...dn(a,t)].find(_=>_.name===M.name);if(P&&M.argCount<P.params.length){const _=P.params[M.argCount];i.push({text:"",display:`${_.name}: ${_.type}`,description:`Argument ${M.argCount+1} of ${P.name}`,type:"constructor"})}}return i}function Sr(a,t,r,f){const i=[],d=r.toLowerCase();if(f){const v=a.findByScope(t),S=new Set;for(const M of v)if(M.fact[0]===f){const E=M.fact[1],P=E===null?"null":typeof E=="string"?E:JSON.stringify(E);!S.has(P)&&P.toLowerCase().includes(d)&&(S.add(P),i.push({text:P,display:P,type:"value"}))}}const x=mr(a,t);for(const v of x){const S=typeof v=="string"?v:String(v);S.toLowerCase().includes(d)&&(i.some(E=>E.display===S)||i.push({text:S,display:S,type:"value"}))}if(r.startsWith("@")||r===""){const v=gr(a,t);for(const S of v){const M=`@${S.id}`;M.toLowerCase().includes(d)&&i.push({text:M,display:`@${S.name}`,description:`Scope: ${S.id.slice(0,8)}`,type:"scope"})}}return"true".includes(d)&&i.push({text:"true",display:"true",type:"value"}),"false".includes(d)&&i.push({text:"false",display:"false",type:"value"}),"null".includes(d)&&i.push({text:"null",display:"null",type:"value"}),i}const at=[{name:"name",params:[],description:"Name attribute",allowedChildren:["string"]},{name:"type",params:[],description:"Type attribute",allowedChildren:["symbol"]},{name:"value",params:[],description:"Value attribute"},{name:"symbol",params:[{name:"name",type:"string"}],description:"Create a symbol",allowedChildren:[]},{name:"eq",params:[{name:"expr",type:"any"}],description:"Equality/binding scope"},{name:"lt",params:[{name:"num",type:"number"}],description:"Less than",allowedChildren:[]},{name:"gt",params:[{name:"num",type:"number"}],description:"Greater than",allowedChildren:[]},{name:"ref",params:[{name:"target",type:"any"}],description:"Reference to scope",allowedChildren:[]},{name:"list",params:[{name:"items",type:"any"}],description:"List of items",allowedChildren:["item","next"]},{name:"peer",params:[{name:"id",type:"string"}],description:"Peer connection",allowedChildren:[]},{name:"group",params:[{name:"name",type:"string"}],description:"Group with synced scope",allowedChildren:["peer","consensus","root"]},{name:"consensus",params:[],description:"Consensus rule (default: unanimous)",allowedChildren:["unanimous","majority","threshold"]},{name:"unanimous",params:[],description:"Require all peers to agree",allowedChildren:[]},{name:"majority",params:[],description:"Require majority to agree",allowedChildren:[]},{name:"threshold",params:[{name:"n",type:"number"}],description:"Require n peers to agree",allowedChildren:[]},{name:"root",params:[],description:"Group root scope (synced data)",allowedChildren:void 0},{name:"string",params:[],description:"String value",allowedChildren:["data","next"],requiredChildren:["data"]},{name:"data",params:[{name:"char",type:"number"}],description:"Character code",allowedChildren:[]},{name:"next",params:[{name:"rest",type:"scope"}],description:"Rest of string/list",allowedChildren:[]},{name:"item",params:[{name:"value",type:"any"}],description:"List item",allowedChildren:[]}];function $t(a){const t=document.createElement("div");t.className="autocomplete-container";const r=document.createElement("input");r.type="text",r.className="autocomplete-input",r.placeholder=a.placeholder,r.autocomplete="off";const f=document.createElement("div");f.className="autocomplete-dropdown hidden",t.appendChild(r),t.appendChild(f);let i=-1,d=[];function x(){const E=r.getBoundingClientRect();f.style.top=`${E.bottom+2}px`,f.style.left=`${E.left}px`,f.style.width=`${E.width}px`}function v(){const E=r.value;if(a.type==="key"?d=wr(a.store,a.scope,E,a.parentConstructor):d=Sr(a.store,a.scope,E,a.forKey),d=d.slice(0,10),d.length===0||d.length===1&&d[0].text===E){f.classList.add("hidden");return}f.innerHTML="",i=-1,x(),d.forEach((P,_)=>{const I=document.createElement("div");I.className="autocomplete-item",I.dataset.index=String(_);const D=document.createElement("span");if(D.className="autocomplete-item-text",D.textContent=P.display,I.appendChild(D),P.description){const W=document.createElement("span");W.className="autocomplete-item-desc",W.textContent=P.description,I.appendChild(W)}const q=document.createElement("span");q.className=`autocomplete-item-type type-${P.type}`,q.textContent=P.type,I.appendChild(q),I.onclick=()=>M(_),I.onmouseenter=()=>{i=_,S()},f.appendChild(I)}),f.classList.remove("hidden")}function S(){f.querySelectorAll(".autocomplete-item").forEach((P,_)=>{P.classList.toggle("selected",_===i)})}function M(E){if(E<0||E>=d.length)return;const P=d[E],_=P.completion||P.text;r.value=_,f.classList.add("hidden"),_.endsWith("(")&&(r.value=_+")",r.setSelectionRange(_.length,_.length)),a.onSelect?.(r.value),a.onChange?.(r.value)}return r.oninput=()=>{v(),a.onChange?.(r.value)},r.onfocus=()=>{v()},r.onblur=()=>{setTimeout(()=>{f.classList.add("hidden")},200)},r.onkeydown=E=>{if(f.classList.contains("hidden")){E.key==="ArrowDown"&&(v(),E.preventDefault());return}switch(E.key){case"ArrowDown":E.preventDefault(),i=Math.min(i+1,d.length-1),S();break;case"ArrowUp":E.preventDefault(),i=Math.max(i-1,-1),S();break;case"Enter":i>=0&&(E.preventDefault(),M(i));break;case"Escape":f.classList.add("hidden");break;case"Tab":i>=0?M(i):d.length>0&&M(0);break}},t.getValue=()=>r.value,t.setValue=E=>{r.value=E,a.onChange?.(E)},t.clear=()=>{r.value="",a.onChange?.("")},t.focus=()=>r.focus(),t.getInput=()=>r,t}function un(a){return a.getValue?.()||""}function pn(a){a.clear?.()}function jt(a){a.focus?.()}function hn(a){return a.getInput?.()||null}function Cr(a,t){if(t.path.length<2)return;const r=t.path[t.path.length-2],f=t.currentScope,i=a.findByScope(r);for(const d of i)if(d.id===f)return vr(d.fact[0])}function Er(a,t){if(t.path.length<2)return{isPeer:!1};const r=t.path[t.path.length-2],f=t.currentScope,i=a.findByScope(r);for(const d of i)if(d.id===f){const v=d.fact[0].match(/^peer\("([^"]+)"\)$/);if(v)return{isPeer:!0,peerId:v[1]}}return{isPeer:!1}}function Ar(a,t){if(t.path.length<2)return{isGroup:!1};const r=t.path[t.path.length-2],f=t.currentScope,i=a.findByScope(r);for(const d of i)if(d.id===f){const v=d.fact[0].match(/^group\("([^"]+)"\)$/);if(v)return{isGroup:!0,groupId:f,groupName:v[1]}}return{isGroup:!1}}function Ir(a){return typeof a=="string"?`"${a}"`:a===null?"null":String(a)}function _r(a,t,r){const f=document.createElement("div");f.className="scope-navigator";const i=document.createElement("div");i.className="breadcrumbs",t.path.forEach((x,v)=>{const S=document.createElement("div");S.className="breadcrumb";const M=cn(a,x),E=tr(a,x),P=v===t.path.length-1;if(v>0&&E.length>1){const I=document.createElement("select");I.className="breadcrumb-dropdown";const D=t.path[v-1];E.forEach(q=>{const W=document.createElement("option");W.value=q,W.textContent=cn(a,q),W.selected=q===D,I.appendChild(W)}),I.onchange=()=>{const q=ar(t,v,I.value);r(q)},S.appendChild(I),S.appendChild(document.createTextNode(" / "))}else v>0&&S.appendChild(document.createTextNode(" / "));const _=document.createElement("span");_.className=`breadcrumb-name ${P?"current":"clickable"}`,_.textContent=M,P||(_.onclick=()=>{const I=sr(t,v);r(I)}),S.appendChild(_),i.appendChild(S)}),f.appendChild(i);const d=nr(a,t.currentScope);if(d.length>0){const x=document.createElement("div");x.className="navigable-facts";const v=document.createElement("span");v.className="navigable-facts-label",v.textContent="Enter: ",x.appendChild(v),d.forEach(S=>{const M=document.createElement("button");M.className="navigable-fact-btn",M.textContent=S.displayName,M.title=S.key,M.onclick=()=>{const E=rr(t,S.id);r(E)},x.appendChild(M)}),f.appendChild(x)}if(t.path.length>1){const x=document.createElement("button");x.className="scope-up-btn",x.textContent=" Up",x.onclick=()=>{const v=or(t);v&&r(v)},f.appendChild(x)}return f}function Nr(a,t,r,f){const i=document.createElement("div");i.className="group-management";const d=a.groups,x=d.getGroup(t);if(!d.isInGroup(t)){const D=d.getPendingInvites().find(q=>q.groupId===t);return D?(i.innerHTML=`
        <div class="group-invite">
          <p>You've been invited to group "${D.groupName}" by ${D.from.slice(0,8)}...</p>
          <p>Members: ${D.members.map(q=>q.slice(0,8)).join(", ")}</p>
          <div class="group-invite-actions">
            <button class="accept-invite">Accept</button>
            <button class="reject-invite">Reject</button>
          </div>
        </div>
      `,i.querySelector(".accept-invite").addEventListener("click",()=>{d.respondToInvite(t,!0)}),i.querySelector(".reject-invite").addEventListener("click",()=>{d.respondToInvite(t,!1)})):(i.innerHTML=`
        <div class="group-create">
          <p>Create group "${r}"</p>
          <button class="create-group-btn">Create Group</button>
        </div>
      `,i.querySelector(".create-group-btn").addEventListener("click",()=>{d.createGroup(t,r)})),i}const S=x.members,M=a.getPeers(),E=d.getProposals(t);i.innerHTML=`
    <div class="group-info">
      <h4>Group: ${r}</h4>
      <p class="group-members">Members: ${S.map(I=>I.slice(0,8)+(I===f?" (you)":"")).join(", ")}</p>
      <p class="group-consensus">Consensus: ${typeof x.consensus=="string"?x.consensus:`threshold(${x.consensus.threshold})`}</p>
    </div>
    <div class="group-invite-peers">
      <h5>Invite Peer</h5>
      <select class="peer-select">
        <option value="">Select a connected peer...</option>
        ${M.filter(I=>!S.includes(I.nodeId)).map(I=>`<option value="${I.nodeId}">${I.nodeId.slice(0,8)}...</option>`).join("")}
      </select>
      <button class="invite-peer-btn" disabled>Invite</button>
    </div>
    ${E.length>0?`
    <div class="group-proposals">
      <h5>Pending Proposals (${E.length})</h5>
      <div class="proposals-list"></div>
    </div>
    `:""}
  `;const P=i.querySelector(".peer-select"),_=i.querySelector(".invite-peer-btn");if(P.onchange=()=>{_.disabled=!P.value},_.onclick=()=>{P.value&&(d.invitePeer(t,P.value),P.value="",_.disabled=!0)},E.length>0){const I=i.querySelector(".proposals-list");for(const D of E){const q=D.votes.has(f),W=D.votes.get(f),ie=document.createElement("div");ie.className="proposal-item",ie.innerHTML=`
        <div class="proposal-fact">[${D.fact.fact[0]}, ${JSON.stringify(D.fact.fact[1])}]</div>
        <div class="proposal-from">From: ${D.from.slice(0,8)}...</div>
        <div class="proposal-votes">Votes: ${Array.from(D.votes.entries()).map(([fe,xe])=>`${fe.slice(0,8)}:${xe?"Y":"N"}`).join(", ")}</div>
        ${q?`<div class="voted">You voted: ${W?"Yes":"No"}</div>`:`
        <div class="proposal-actions">
          <button class="vote-yes">Approve</button>
          <button class="vote-no">Reject</button>
        </div>
        `}
      `,q||(ie.querySelector(".vote-yes").addEventListener("click",()=>{d.vote(D.id,!0)}),ie.querySelector(".vote-no").addEventListener("click",()=>{d.vote(D.id,!1)})),I.appendChild(ie)}}return i}function Ot(a){const t=a.trim();return t==="true"?!0:t==="false"?!1:t==="null"?null:/^-?\d+(\.\d+)?$/.test(t)?parseFloat(t):t.startsWith('"')&&t.endsWith('"')||t.startsWith("'")&&t.endsWith("'")?t.slice(1,-1):t}function Lr(a,t,r){const f=document.createElement("div"),i=a.findByScope(t);if(i.length===0)return f.innerHTML='<p class="empty-state">No facts in this scope. Add some below.</p>',f;const d=document.createElement("ul");d.className="fact-list";for(const x of i){const v=document.createElement("li");v.className="fact-item";const S=document.createElement("span");S.className="key",S.textContent=x.fact[0];const M=document.createTextNode(": "),E=document.createElement("span");E.className="value editable",E.textContent=Ir(x.fact[1]),E.title="Click to edit",E.onclick=()=>{const P=document.createElement("input");P.type="text",P.className="fact-edit-input",P.value=typeof x.fact[1]=="string"?x.fact[1]:String(x.fact[1]);const _=()=>{const I=Ot(P.value),D=x.fact;a.retract(D,t),a.add([D[0],I],r,t)};P.onblur=_,P.onkeydown=I=>{I.key==="Enter"?_():I.key==="Escape"&&a.add(x.fact,r,x.scope)},E.replaceWith(P),P.focus(),P.select()},v.appendChild(S),v.appendChild(M),v.appendChild(E),d.appendChild(v)}return f.appendChild(d),f}function Br(a,t,r,f){const i=document.createElement("div");i.className="add-fact-form";let d="";const x=$t({store:a,scope:t,type:"key",placeholder:"key (e.g., name, eq(x))",parentConstructor:f,onChange:_=>{d=_}}),v=$t({store:a,scope:t,type:"value",placeholder:"value",forKey:d}),S=document.createElement("button");S.id="add-fact-btn",S.textContent="Add";const M=()=>{const _=un(x).trim(),I=un(v).trim();if(!_)return;const D=hr(_),q=D!==null&&Sn(D)?Cn(D):_;let W=I;I==="true"?W=!0:I==="false"?W=!1:I==="null"?W=null:/^-?\d+(\.\d+)?$/.test(I)&&(W=parseFloat(I)),a.add([q,W],r,t),pn(x),pn(v),jt(x)};S.onclick=M;const E=hn(v);if(E){const _=E.onkeydown;E.onkeydown=I=>{I.key==="Enter"&&!I.defaultPrevented&&v.querySelector(".autocomplete-dropdown")?.classList.contains("hidden")&&(M(),I.preventDefault()),_?.call(E,I)}}const P=hn(x);if(P){const _=P.onkeydown;P.onkeydown=I=>{I.key==="Tab"&&!I.shiftKey&&x.querySelector(".autocomplete-dropdown")?.classList.contains("hidden")&&(I.preventDefault(),jt(v)),_?.call(P,I)}}return i.appendChild(x),i.appendChild(v),i.appendChild(S),i}function Mr(a,t){const r=document.createElement("div");r.className="query-builder";const f=document.createElement("h4");f.textContent="Query",r.appendChild(f);const i=document.createElement("div");i.className="query-pattern";const d={key:{type:"any",value:""},value:{type:"any",value:""}},x=document.createElement("div");x.className="query-results empty",x.textContent="Enter a pattern to query";const v=document.createElement("div");v.className="query-preview";const S=document.createElement("code");S.className="pattern-text",v.appendChild(S);function M(){const _=d.key.type==="any"?"?key":d.key.value||"?key",I=d.value.type==="any"?"?val":d.value.value||"?val";S.textContent=`[${_}, ${I}]`}function E(){try{const _=d.key.type==="any"?an("key"):Ot(d.key.value),I=d.value.type==="any"?an("val"):Ot(d.value.value),q=Xn(a,[[_,I]],{scope:t});q.length===0?(x.className="query-results empty",x.textContent="No matches"):(x.className="query-results",x.innerHTML=q.map(W=>`<div class="result-row">${JSON.stringify(Qn(W))}</div>`).join(""))}catch(_){x.className="query-results empty",x.textContent=`Error: ${_}`}}function P(_,I,D){const q=document.createElement("div");q.className="pattern-slot";const W=document.createElement("label");W.textContent=I,q.appendChild(W);const ie=document.createElement("div");ie.className="slot-options";const fe=document.createElement("button");fe.className="slot-btn active",fe.textContent=`Any (?${_[0]})`,fe.dataset.type="any";const xe=document.createElement("button");xe.className="slot-btn",xe.textContent="Specific",xe.dataset.type="specific",ie.appendChild(fe),ie.appendChild(xe),q.appendChild(ie);const ve=$t({store:a,scope:t,type:D,placeholder:_,onChange:be=>{d[_].value=be,M(),E()}});return ve.classList.add("hidden"),q.appendChild(ve),[fe,xe].forEach(be=>{be.onclick=()=>{fe.classList.toggle("active",be===fe),xe.classList.toggle("active",be===xe),d[_].type=be.dataset.type,be.dataset.type==="specific"?(ve.classList.remove("hidden"),jt(ve)):ve.classList.add("hidden"),M(),E()}}),q}return i.appendChild(P("key","Key","key")),i.appendChild(P("value","Value","value")),r.appendChild(i),r.appendChild(v),r.appendChild(x),M(),E(),r}function Pr(a,t,r){const f=t.findByScope(a).find(i=>i.fact[0]==="name");return f?String(f.fact[1]):r}function Tr(a,t,r){const f=document.createElement("div");f.className="actor-switcher";const i=t.getActors();f.innerHTML=`
    <div class="actor-switcher-row">
      <select class="actor-select">
        ${i.map(fe=>`<option value="${fe.id}" ${fe.id===a?"selected":""}>${Pr(fe.id,r,fe.name)}</option>`).join("")}
      </select>
      <button class="actor-btn" title="New Actor">+</button>
      <button class="actor-btn" title="Import Actor">Import</button>
      <button class="actor-btn" title="Export Actor">Export</button>
      <button class="actor-btn actor-btn-danger" title="Delete Actor">Delete</button>
    </div>
    <div class="actor-import-row hidden">
      <input type="text" class="actor-import-input" placeholder="Paste actor data..." />
      <button class="actor-import-btn">Import</button>
      <button class="actor-import-cancel">Cancel</button>
    </div>
    <div class="actor-export-row hidden">
      <textarea class="actor-export-output" readonly></textarea>
      <button class="actor-export-copy">Copy</button>
      <button class="actor-export-close">Close</button>
    </div>
  `;const d=f.querySelector(".actor-select"),x=f.querySelectorAll(".actor-btn")[0],v=f.querySelectorAll(".actor-btn")[1],S=f.querySelectorAll(".actor-btn")[2],M=f.querySelectorAll(".actor-btn")[3],E=f.querySelector(".actor-import-row"),P=f.querySelector(".actor-import-input"),_=f.querySelector(".actor-import-btn"),I=f.querySelector(".actor-import-cancel"),D=f.querySelector(".actor-export-row"),q=f.querySelector(".actor-export-output"),W=f.querySelector(".actor-export-copy"),ie=f.querySelector(".actor-export-close");return d.onchange=()=>{t.onSwitchActor(d.value)},x.onclick=()=>{const fe=prompt("Enter a name for the new actor:",`Actor ${new Date().toLocaleString()}`);fe!==null&&t.onCreateActor(fe||void 0)},v.onclick=()=>{E.classList.remove("hidden"),P.focus()},I.onclick=()=>{E.classList.add("hidden"),P.value=""},_.onclick=()=>{const fe=P.value.trim();if(!fe)return;t.onImportActor(fe)?(E.classList.add("hidden"),P.value=""):alert("Invalid actor data")},S.onclick=()=>{const fe=t.onExportActor(a);fe&&(q.value=fe,D.classList.remove("hidden"))},W.onclick=async()=>{await navigator.clipboard.writeText(q.value),W.textContent="Copied!",setTimeout(()=>W.textContent="Copy",2e3)},ie.onclick=()=>{D.classList.add("hidden"),q.value=""},M.onclick=()=>{if(i.length<=1){alert("Cannot delete the last actor");return}confirm("Are you sure you want to delete this actor?")&&t.onDeleteActor(a)},f}function it(a,t,r){const{identity:f,store:i,mesh:d}=t;let x=t.navigation||fr(f.nodeId);function v(M){x=M,S()}function S(){const M=d.getPeerCount(),E=x.currentScope,P=i.findByScope(E);a.innerHTML="";const _=document.createElement("div");_.className="header";const I=document.createElement("div");I.className="header-info",I.innerHTML=`
      <div class="node-id">Node: ${f.nodeId}</div>
      <div class="peer-count ${M>0?"connected":""}">
        ${M} peer${M!==1?"s":""} connected
      </div>
    `,_.appendChild(I),_.appendChild(Tr(f.nodeId,r,i)),a.appendChild(_);const D=document.createElement("div");D.className="section",D.innerHTML=`
      <div class="section-header">
        <h2>Scope</h2>
      </div>
    `;const q=document.createElement("div");q.className="section-content",q.appendChild(_r(i,x,v)),D.appendChild(q),a.appendChild(D);const W=Cr(i,x),ie=document.createElement("div");ie.className="section",ie.innerHTML=`
      <div class="section-header">
        <h2>Facts</h2>
        <span>${P.length} in scope${W?` (${W} context)`:""}</span>
      </div>
    `;const fe=document.createElement("div");fe.className="section-content",fe.appendChild(Lr(i,E,f.nodeId)),fe.appendChild(Br(i,E,f.nodeId,W)),ie.appendChild(fe),a.appendChild(ie);const xe=document.createElement("div");xe.className="section",xe.innerHTML=`
      <div class="section-header">
        <h2>Query</h2>
      </div>
    `;const ve=document.createElement("div");ve.className="section-content",ve.appendChild(Mr(i,E)),xe.appendChild(ve),a.appendChild(xe);const be=Er(i,x);if(be.isPeer){const Ee=document.createElement("div");Ee.className="section",Ee.innerHTML=`
        <div class="section-header">
          <h2>Peer Connection</h2>
          <span>peer(${be.peerId?.slice(0,8)}...)</span>
        </div>
      `;const Ne=document.createElement("div");Ne.className="section-content",er(Ne,d),Ee.appendChild(Ne),a.appendChild(Ee)}const we=Ar(i,x);if(we.isGroup&&we.groupId&&we.groupName){const Ee=document.createElement("div");Ee.className="section",Ee.innerHTML=`
        <div class="section-header">
          <h2>Group</h2>
          <span>group("${we.groupName}")</span>
        </div>
      `;const Ne=document.createElement("div");Ne.className="section-content",Ne.appendChild(Nr(d,we.groupId,we.groupName,f.nodeId)),Ee.appendChild(Ne),a.appendChild(Ee)}}S(),i.onAdd(()=>S()),d.onChange(()=>S()),d.groups.onChange(()=>S())}let Ce=null;function lt(a){const t=new Gn,r=new Zn(a,t);return{identity:a,store:t,mesh:r}}function ze(a){const t=Yn(a);if(!t)return!1;Ce=lt(t),yt(t,Ce.store),console.log("Switched to Node ID:",t.nodeId);const r=document.getElementById("app");return r&&it(r,Ce,{onSwitchActor:ze,onCreateActor:dt,onImportActor:ut,onExportActor:pt,onDeleteActor:ht,onRenameActor:xt,getActors:Ue,getCurrentActorId:ct}),!0}function dt(a){const t=wn(a);Ce=lt(t),yt(t,Ce.store);const r=document.getElementById("app");return r&&it(r,Ce,{onSwitchActor:ze,onCreateActor:dt,onImportActor:ut,onExportActor:pt,onDeleteActor:ht,onRenameActor:xt,getActors:Ue,getCurrentActorId:ct}),t}function ut(a){const t=Fn(a);if(!t)return null;Ce=lt(t),yt(t,Ce.store);const r=document.getElementById("app");return r&&it(r,Ce,{onSwitchActor:ze,onCreateActor:dt,onImportActor:ut,onExportActor:pt,onDeleteActor:ht,onRenameActor:xt,getActors:Ue,getCurrentActorId:ct}),t}function pt(a){return Vn(a)}function ht(a){if(Ue().length<=1)return alert("Cannot delete the last actor"),!1;if(qn(a),Ce?.identity.nodeId===a){const r=Ue();r.length>0&&ze(r[0].id)}return!0}function xt(a,t){Rn(a,t)}function yt(a,t){if(!t.findByScope(a.nodeId).find(f=>f.fact[0]==="name")){const i=Ue().find(d=>d.id===a.nodeId)?.name||a.nodeId;t.add(["name",i],a.nodeId,a.nodeId)}}function Ur(){const a=kn();console.log("Node ID:",a.nodeId),Ce=lt(a),yt(a,Ce.store),it(document.getElementById("app"),Ce,{onSwitchActor:ze,onCreateActor:dt,onImportActor:ut,onExportActor:pt,onDeleteActor:ht,onRenameActor:xt,getActors:Ue,getCurrentActorId:ct})}Ur();
