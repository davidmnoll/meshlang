(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))s(l);new MutationObserver(l=>{for(const h of l)if(h.type==="childList")for(const y of h.addedNodes)y.tagName==="LINK"&&y.rel==="modulepreload"&&s(y)}).observe(document,{childList:!0,subtree:!0});function r(l){const h={};return l.integrity&&(h.integrity=l.integrity),l.referrerPolicy&&(h.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?h.credentials="include":l.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function s(l){if(l.ep)return;l.ep=!0;const h=r(l);fetch(l.href,h)}})();var Mn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Pn(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}function Tn(a){if(a.__esModule)return a;var n=a.default;if(typeof n=="function"){var r=function s(){return this instanceof s?Reflect.construct(n,arguments,this.constructor):n.apply(this,arguments)};r.prototype=n.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(a).forEach(function(s){var l=Object.getOwnPropertyDescriptor(a,s);Object.defineProperty(r,s,l.get?l:{enumerable:!0,get:function(){return a[s]}})}),r}function Kn(a){throw new Error('Could not dynamically require "'+a+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var xn={exports:{}};const Un={},On=Object.freeze(Object.defineProperty({__proto__:null,default:Un},Symbol.toStringTag,{value:"Module"})),jn=Tn(On);(function(a){(function(n){var r=function(t){var f,o=new Float64Array(16);if(t)for(f=0;f<t.length;f++)o[f]=t[f];return o},s=function(){throw new Error("no PRNG")},l=new Uint8Array(16),h=new Uint8Array(32);h[0]=9;var y=r(),S=r([1]),C=r([56129,1]),U=r([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),E=r([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),O=r([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),I=r([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),N=r([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function ee(t,f,o,e){t[f]=o>>24&255,t[f+1]=o>>16&255,t[f+2]=o>>8&255,t[f+3]=o&255,t[f+4]=e>>24&255,t[f+5]=e>>16&255,t[f+6]=e>>8&255,t[f+7]=e&255}function R(t,f,o,e,c){var d,u=0;for(d=0;d<c;d++)u|=t[f+d]^o[e+d];return(1&u-1>>>8)-1}function X(t,f,o,e){return R(t,f,o,e,16)}function pe(t,f,o,e){return R(t,f,o,e,32)}function se(t,f,o,e){for(var c=e[0]&255|(e[1]&255)<<8|(e[2]&255)<<16|(e[3]&255)<<24,d=o[0]&255|(o[1]&255)<<8|(o[2]&255)<<16|(o[3]&255)<<24,u=o[4]&255|(o[5]&255)<<8|(o[6]&255)<<16|(o[7]&255)<<24,b=o[8]&255|(o[9]&255)<<8|(o[10]&255)<<16|(o[11]&255)<<24,A=o[12]&255|(o[13]&255)<<8|(o[14]&255)<<16|(o[15]&255)<<24,j=e[4]&255|(e[5]&255)<<8|(e[6]&255)<<16|(e[7]&255)<<24,B=f[0]&255|(f[1]&255)<<8|(f[2]&255)<<16|(f[3]&255)<<24,oe=f[4]&255|(f[5]&255)<<8|(f[6]&255)<<16|(f[7]&255)<<24,M=f[8]&255|(f[9]&255)<<8|(f[10]&255)<<16|(f[11]&255)<<24,q=f[12]&255|(f[13]&255)<<8|(f[14]&255)<<16|(f[15]&255)<<24,Y=e[8]&255|(e[9]&255)<<8|(e[10]&255)<<16|(e[11]&255)<<24,G=o[16]&255|(o[17]&255)<<8|(o[18]&255)<<16|(o[19]&255)<<24,z=o[20]&255|(o[21]&255)<<8|(o[22]&255)<<16|(o[23]&255)<<24,F=o[24]&255|(o[25]&255)<<8|(o[26]&255)<<16|(o[27]&255)<<24,k=o[28]&255|(o[29]&255)<<8|(o[30]&255)<<16|(o[31]&255)<<24,V=e[12]&255|(e[13]&255)<<8|(e[14]&255)<<16|(e[15]&255)<<24,P=c,$=d,L=u,T=b,K=A,_=j,p=B,x=oe,v=M,m=q,g=Y,w=G,D=z,H=F,Z=k,J=V,i,Q=0;Q<20;Q+=2)i=P+D|0,K^=i<<7|i>>>25,i=K+P|0,v^=i<<9|i>>>23,i=v+K|0,D^=i<<13|i>>>19,i=D+v|0,P^=i<<18|i>>>14,i=_+$|0,m^=i<<7|i>>>25,i=m+_|0,H^=i<<9|i>>>23,i=H+m|0,$^=i<<13|i>>>19,i=$+H|0,_^=i<<18|i>>>14,i=g+p|0,Z^=i<<7|i>>>25,i=Z+g|0,L^=i<<9|i>>>23,i=L+Z|0,p^=i<<13|i>>>19,i=p+L|0,g^=i<<18|i>>>14,i=J+w|0,T^=i<<7|i>>>25,i=T+J|0,x^=i<<9|i>>>23,i=x+T|0,w^=i<<13|i>>>19,i=w+x|0,J^=i<<18|i>>>14,i=P+T|0,$^=i<<7|i>>>25,i=$+P|0,L^=i<<9|i>>>23,i=L+$|0,T^=i<<13|i>>>19,i=T+L|0,P^=i<<18|i>>>14,i=_+K|0,p^=i<<7|i>>>25,i=p+_|0,x^=i<<9|i>>>23,i=x+p|0,K^=i<<13|i>>>19,i=K+x|0,_^=i<<18|i>>>14,i=g+m|0,w^=i<<7|i>>>25,i=w+g|0,v^=i<<9|i>>>23,i=v+w|0,m^=i<<13|i>>>19,i=m+v|0,g^=i<<18|i>>>14,i=J+Z|0,D^=i<<7|i>>>25,i=D+J|0,H^=i<<9|i>>>23,i=H+D|0,Z^=i<<13|i>>>19,i=Z+H|0,J^=i<<18|i>>>14;P=P+c|0,$=$+d|0,L=L+u|0,T=T+b|0,K=K+A|0,_=_+j|0,p=p+B|0,x=x+oe|0,v=v+M|0,m=m+q|0,g=g+Y|0,w=w+G|0,D=D+z|0,H=H+F|0,Z=Z+k|0,J=J+V|0,t[0]=P>>>0&255,t[1]=P>>>8&255,t[2]=P>>>16&255,t[3]=P>>>24&255,t[4]=$>>>0&255,t[5]=$>>>8&255,t[6]=$>>>16&255,t[7]=$>>>24&255,t[8]=L>>>0&255,t[9]=L>>>8&255,t[10]=L>>>16&255,t[11]=L>>>24&255,t[12]=T>>>0&255,t[13]=T>>>8&255,t[14]=T>>>16&255,t[15]=T>>>24&255,t[16]=K>>>0&255,t[17]=K>>>8&255,t[18]=K>>>16&255,t[19]=K>>>24&255,t[20]=_>>>0&255,t[21]=_>>>8&255,t[22]=_>>>16&255,t[23]=_>>>24&255,t[24]=p>>>0&255,t[25]=p>>>8&255,t[26]=p>>>16&255,t[27]=p>>>24&255,t[28]=x>>>0&255,t[29]=x>>>8&255,t[30]=x>>>16&255,t[31]=x>>>24&255,t[32]=v>>>0&255,t[33]=v>>>8&255,t[34]=v>>>16&255,t[35]=v>>>24&255,t[36]=m>>>0&255,t[37]=m>>>8&255,t[38]=m>>>16&255,t[39]=m>>>24&255,t[40]=g>>>0&255,t[41]=g>>>8&255,t[42]=g>>>16&255,t[43]=g>>>24&255,t[44]=w>>>0&255,t[45]=w>>>8&255,t[46]=w>>>16&255,t[47]=w>>>24&255,t[48]=D>>>0&255,t[49]=D>>>8&255,t[50]=D>>>16&255,t[51]=D>>>24&255,t[52]=H>>>0&255,t[53]=H>>>8&255,t[54]=H>>>16&255,t[55]=H>>>24&255,t[56]=Z>>>0&255,t[57]=Z>>>8&255,t[58]=Z>>>16&255,t[59]=Z>>>24&255,t[60]=J>>>0&255,t[61]=J>>>8&255,t[62]=J>>>16&255,t[63]=J>>>24&255}function be(t,f,o,e){for(var c=e[0]&255|(e[1]&255)<<8|(e[2]&255)<<16|(e[3]&255)<<24,d=o[0]&255|(o[1]&255)<<8|(o[2]&255)<<16|(o[3]&255)<<24,u=o[4]&255|(o[5]&255)<<8|(o[6]&255)<<16|(o[7]&255)<<24,b=o[8]&255|(o[9]&255)<<8|(o[10]&255)<<16|(o[11]&255)<<24,A=o[12]&255|(o[13]&255)<<8|(o[14]&255)<<16|(o[15]&255)<<24,j=e[4]&255|(e[5]&255)<<8|(e[6]&255)<<16|(e[7]&255)<<24,B=f[0]&255|(f[1]&255)<<8|(f[2]&255)<<16|(f[3]&255)<<24,oe=f[4]&255|(f[5]&255)<<8|(f[6]&255)<<16|(f[7]&255)<<24,M=f[8]&255|(f[9]&255)<<8|(f[10]&255)<<16|(f[11]&255)<<24,q=f[12]&255|(f[13]&255)<<8|(f[14]&255)<<16|(f[15]&255)<<24,Y=e[8]&255|(e[9]&255)<<8|(e[10]&255)<<16|(e[11]&255)<<24,G=o[16]&255|(o[17]&255)<<8|(o[18]&255)<<16|(o[19]&255)<<24,z=o[20]&255|(o[21]&255)<<8|(o[22]&255)<<16|(o[23]&255)<<24,F=o[24]&255|(o[25]&255)<<8|(o[26]&255)<<16|(o[27]&255)<<24,k=o[28]&255|(o[29]&255)<<8|(o[30]&255)<<16|(o[31]&255)<<24,V=e[12]&255|(e[13]&255)<<8|(e[14]&255)<<16|(e[15]&255)<<24,P=c,$=d,L=u,T=b,K=A,_=j,p=B,x=oe,v=M,m=q,g=Y,w=G,D=z,H=F,Z=k,J=V,i,Q=0;Q<20;Q+=2)i=P+D|0,K^=i<<7|i>>>25,i=K+P|0,v^=i<<9|i>>>23,i=v+K|0,D^=i<<13|i>>>19,i=D+v|0,P^=i<<18|i>>>14,i=_+$|0,m^=i<<7|i>>>25,i=m+_|0,H^=i<<9|i>>>23,i=H+m|0,$^=i<<13|i>>>19,i=$+H|0,_^=i<<18|i>>>14,i=g+p|0,Z^=i<<7|i>>>25,i=Z+g|0,L^=i<<9|i>>>23,i=L+Z|0,p^=i<<13|i>>>19,i=p+L|0,g^=i<<18|i>>>14,i=J+w|0,T^=i<<7|i>>>25,i=T+J|0,x^=i<<9|i>>>23,i=x+T|0,w^=i<<13|i>>>19,i=w+x|0,J^=i<<18|i>>>14,i=P+T|0,$^=i<<7|i>>>25,i=$+P|0,L^=i<<9|i>>>23,i=L+$|0,T^=i<<13|i>>>19,i=T+L|0,P^=i<<18|i>>>14,i=_+K|0,p^=i<<7|i>>>25,i=p+_|0,x^=i<<9|i>>>23,i=x+p|0,K^=i<<13|i>>>19,i=K+x|0,_^=i<<18|i>>>14,i=g+m|0,w^=i<<7|i>>>25,i=w+g|0,v^=i<<9|i>>>23,i=v+w|0,m^=i<<13|i>>>19,i=m+v|0,g^=i<<18|i>>>14,i=J+Z|0,D^=i<<7|i>>>25,i=D+J|0,H^=i<<9|i>>>23,i=H+D|0,Z^=i<<13|i>>>19,i=Z+H|0,J^=i<<18|i>>>14;t[0]=P>>>0&255,t[1]=P>>>8&255,t[2]=P>>>16&255,t[3]=P>>>24&255,t[4]=_>>>0&255,t[5]=_>>>8&255,t[6]=_>>>16&255,t[7]=_>>>24&255,t[8]=g>>>0&255,t[9]=g>>>8&255,t[10]=g>>>16&255,t[11]=g>>>24&255,t[12]=J>>>0&255,t[13]=J>>>8&255,t[14]=J>>>16&255,t[15]=J>>>24&255,t[16]=p>>>0&255,t[17]=p>>>8&255,t[18]=p>>>16&255,t[19]=p>>>24&255,t[20]=x>>>0&255,t[21]=x>>>8&255,t[22]=x>>>16&255,t[23]=x>>>24&255,t[24]=v>>>0&255,t[25]=v>>>8&255,t[26]=v>>>16&255,t[27]=v>>>24&255,t[28]=m>>>0&255,t[29]=m>>>8&255,t[30]=m>>>16&255,t[31]=m>>>24&255}function ve(t,f,o,e){se(t,f,o,e)}function ge(t,f,o,e){be(t,f,o,e)}var Ce=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function Te(t,f,o,e,c,d,u){var b=new Uint8Array(16),A=new Uint8Array(64),j,B;for(B=0;B<16;B++)b[B]=0;for(B=0;B<8;B++)b[B]=d[B];for(;c>=64;){for(ve(A,b,u,Ce),B=0;B<64;B++)t[f+B]=o[e+B]^A[B];for(j=1,B=8;B<16;B++)j=j+(b[B]&255)|0,b[B]=j&255,j>>>=8;c-=64,f+=64,e+=64}if(c>0)for(ve(A,b,u,Ce),B=0;B<c;B++)t[f+B]=o[e+B]^A[B];return 0}function Rt(t,f,o,e,c){var d=new Uint8Array(16),u=new Uint8Array(64),b,A;for(A=0;A<16;A++)d[A]=0;for(A=0;A<8;A++)d[A]=e[A];for(;o>=64;){for(ve(u,d,c,Ce),A=0;A<64;A++)t[f+A]=u[A];for(b=1,A=8;A<16;A++)b=b+(d[A]&255)|0,d[A]=b&255,b>>>=8;o-=64,f+=64}if(o>0)for(ve(u,d,c,Ce),A=0;A<o;A++)t[f+A]=u[A];return 0}function qt(t,f,o,e,c){var d=new Uint8Array(32);ge(d,e,c,Ce);for(var u=new Uint8Array(8),b=0;b<8;b++)u[b]=e[b+16];return Rt(t,f,o,u,d)}function pt(t,f,o,e,c,d,u){var b=new Uint8Array(32);ge(b,d,u,Ce);for(var A=new Uint8Array(8),j=0;j<8;j++)A[j]=d[j+16];return Te(t,f,o,e,c,A,b)}var Ge=function(t){this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.leftover=0,this.fin=0;var f,o,e,c,d,u,b,A;f=t[0]&255|(t[1]&255)<<8,this.r[0]=f&8191,o=t[2]&255|(t[3]&255)<<8,this.r[1]=(f>>>13|o<<3)&8191,e=t[4]&255|(t[5]&255)<<8,this.r[2]=(o>>>10|e<<6)&7939,c=t[6]&255|(t[7]&255)<<8,this.r[3]=(e>>>7|c<<9)&8191,d=t[8]&255|(t[9]&255)<<8,this.r[4]=(c>>>4|d<<12)&255,this.r[5]=d>>>1&8190,u=t[10]&255|(t[11]&255)<<8,this.r[6]=(d>>>14|u<<2)&8191,b=t[12]&255|(t[13]&255)<<8,this.r[7]=(u>>>11|b<<5)&8065,A=t[14]&255|(t[15]&255)<<8,this.r[8]=(b>>>8|A<<8)&8191,this.r[9]=A>>>5&127,this.pad[0]=t[16]&255|(t[17]&255)<<8,this.pad[1]=t[18]&255|(t[19]&255)<<8,this.pad[2]=t[20]&255|(t[21]&255)<<8,this.pad[3]=t[22]&255|(t[23]&255)<<8,this.pad[4]=t[24]&255|(t[25]&255)<<8,this.pad[5]=t[26]&255|(t[27]&255)<<8,this.pad[6]=t[28]&255|(t[29]&255)<<8,this.pad[7]=t[30]&255|(t[31]&255)<<8};Ge.prototype.blocks=function(t,f,o){for(var e=this.fin?0:2048,c,d,u,b,A,j,B,oe,M,q,Y,G,z,F,k,V,P,$,L,T=this.h[0],K=this.h[1],_=this.h[2],p=this.h[3],x=this.h[4],v=this.h[5],m=this.h[6],g=this.h[7],w=this.h[8],D=this.h[9],H=this.r[0],Z=this.r[1],J=this.r[2],i=this.r[3],Q=this.r[4],fe=this.r[5],ae=this.r[6],W=this.r[7],ne=this.r[8],re=this.r[9];o>=16;)c=t[f+0]&255|(t[f+1]&255)<<8,T+=c&8191,d=t[f+2]&255|(t[f+3]&255)<<8,K+=(c>>>13|d<<3)&8191,u=t[f+4]&255|(t[f+5]&255)<<8,_+=(d>>>10|u<<6)&8191,b=t[f+6]&255|(t[f+7]&255)<<8,p+=(u>>>7|b<<9)&8191,A=t[f+8]&255|(t[f+9]&255)<<8,x+=(b>>>4|A<<12)&8191,v+=A>>>1&8191,j=t[f+10]&255|(t[f+11]&255)<<8,m+=(A>>>14|j<<2)&8191,B=t[f+12]&255|(t[f+13]&255)<<8,g+=(j>>>11|B<<5)&8191,oe=t[f+14]&255|(t[f+15]&255)<<8,w+=(B>>>8|oe<<8)&8191,D+=oe>>>5|e,M=0,q=M,q+=T*H,q+=K*(5*re),q+=_*(5*ne),q+=p*(5*W),q+=x*(5*ae),M=q>>>13,q&=8191,q+=v*(5*fe),q+=m*(5*Q),q+=g*(5*i),q+=w*(5*J),q+=D*(5*Z),M+=q>>>13,q&=8191,Y=M,Y+=T*Z,Y+=K*H,Y+=_*(5*re),Y+=p*(5*ne),Y+=x*(5*W),M=Y>>>13,Y&=8191,Y+=v*(5*ae),Y+=m*(5*fe),Y+=g*(5*Q),Y+=w*(5*i),Y+=D*(5*J),M+=Y>>>13,Y&=8191,G=M,G+=T*J,G+=K*Z,G+=_*H,G+=p*(5*re),G+=x*(5*ne),M=G>>>13,G&=8191,G+=v*(5*W),G+=m*(5*ae),G+=g*(5*fe),G+=w*(5*Q),G+=D*(5*i),M+=G>>>13,G&=8191,z=M,z+=T*i,z+=K*J,z+=_*Z,z+=p*H,z+=x*(5*re),M=z>>>13,z&=8191,z+=v*(5*ne),z+=m*(5*W),z+=g*(5*ae),z+=w*(5*fe),z+=D*(5*Q),M+=z>>>13,z&=8191,F=M,F+=T*Q,F+=K*i,F+=_*J,F+=p*Z,F+=x*H,M=F>>>13,F&=8191,F+=v*(5*re),F+=m*(5*ne),F+=g*(5*W),F+=w*(5*ae),F+=D*(5*fe),M+=F>>>13,F&=8191,k=M,k+=T*fe,k+=K*Q,k+=_*i,k+=p*J,k+=x*Z,M=k>>>13,k&=8191,k+=v*H,k+=m*(5*re),k+=g*(5*ne),k+=w*(5*W),k+=D*(5*ae),M+=k>>>13,k&=8191,V=M,V+=T*ae,V+=K*fe,V+=_*Q,V+=p*i,V+=x*J,M=V>>>13,V&=8191,V+=v*Z,V+=m*H,V+=g*(5*re),V+=w*(5*ne),V+=D*(5*W),M+=V>>>13,V&=8191,P=M,P+=T*W,P+=K*ae,P+=_*fe,P+=p*Q,P+=x*i,M=P>>>13,P&=8191,P+=v*J,P+=m*Z,P+=g*H,P+=w*(5*re),P+=D*(5*ne),M+=P>>>13,P&=8191,$=M,$+=T*ne,$+=K*W,$+=_*ae,$+=p*fe,$+=x*Q,M=$>>>13,$&=8191,$+=v*i,$+=m*J,$+=g*Z,$+=w*H,$+=D*(5*re),M+=$>>>13,$&=8191,L=M,L+=T*re,L+=K*ne,L+=_*W,L+=p*ae,L+=x*fe,M=L>>>13,L&=8191,L+=v*Q,L+=m*i,L+=g*J,L+=w*Z,L+=D*H,M+=L>>>13,L&=8191,M=(M<<2)+M|0,M=M+q|0,q=M&8191,M=M>>>13,Y+=M,T=q,K=Y,_=G,p=z,x=F,v=k,m=V,g=P,w=$,D=L,f+=16,o-=16;this.h[0]=T,this.h[1]=K,this.h[2]=_,this.h[3]=p,this.h[4]=x,this.h[5]=v,this.h[6]=m,this.h[7]=g,this.h[8]=w,this.h[9]=D},Ge.prototype.finish=function(t,f){var o=new Uint16Array(10),e,c,d,u;if(this.leftover){for(u=this.leftover,this.buffer[u++]=1;u<16;u++)this.buffer[u]=0;this.fin=1,this.blocks(this.buffer,0,16)}for(e=this.h[1]>>>13,this.h[1]&=8191,u=2;u<10;u++)this.h[u]+=e,e=this.h[u]>>>13,this.h[u]&=8191;for(this.h[0]+=e*5,e=this.h[0]>>>13,this.h[0]&=8191,this.h[1]+=e,e=this.h[1]>>>13,this.h[1]&=8191,this.h[2]+=e,o[0]=this.h[0]+5,e=o[0]>>>13,o[0]&=8191,u=1;u<10;u++)o[u]=this.h[u]+e,e=o[u]>>>13,o[u]&=8191;for(o[9]-=8192,c=(e^1)-1,u=0;u<10;u++)o[u]&=c;for(c=~c,u=0;u<10;u++)this.h[u]=this.h[u]&c|o[u];for(this.h[0]=(this.h[0]|this.h[1]<<13)&65535,this.h[1]=(this.h[1]>>>3|this.h[2]<<10)&65535,this.h[2]=(this.h[2]>>>6|this.h[3]<<7)&65535,this.h[3]=(this.h[3]>>>9|this.h[4]<<4)&65535,this.h[4]=(this.h[4]>>>12|this.h[5]<<1|this.h[6]<<14)&65535,this.h[5]=(this.h[6]>>>2|this.h[7]<<11)&65535,this.h[6]=(this.h[7]>>>5|this.h[8]<<8)&65535,this.h[7]=(this.h[8]>>>8|this.h[9]<<5)&65535,d=this.h[0]+this.pad[0],this.h[0]=d&65535,u=1;u<8;u++)d=(this.h[u]+this.pad[u]|0)+(d>>>16)|0,this.h[u]=d&65535;t[f+0]=this.h[0]>>>0&255,t[f+1]=this.h[0]>>>8&255,t[f+2]=this.h[1]>>>0&255,t[f+3]=this.h[1]>>>8&255,t[f+4]=this.h[2]>>>0&255,t[f+5]=this.h[2]>>>8&255,t[f+6]=this.h[3]>>>0&255,t[f+7]=this.h[3]>>>8&255,t[f+8]=this.h[4]>>>0&255,t[f+9]=this.h[4]>>>8&255,t[f+10]=this.h[5]>>>0&255,t[f+11]=this.h[5]>>>8&255,t[f+12]=this.h[6]>>>0&255,t[f+13]=this.h[6]>>>8&255,t[f+14]=this.h[7]>>>0&255,t[f+15]=this.h[7]>>>8&255},Ge.prototype.update=function(t,f,o){var e,c;if(this.leftover){for(c=16-this.leftover,c>o&&(c=o),e=0;e<c;e++)this.buffer[this.leftover+e]=t[f+e];if(o-=c,f+=c,this.leftover+=c,this.leftover<16)return;this.blocks(this.buffer,0,16),this.leftover=0}if(o>=16&&(c=o-o%16,this.blocks(t,f,c),f+=c,o-=c),o){for(e=0;e<o;e++)this.buffer[this.leftover+e]=t[f+e];this.leftover+=o}};function xt(t,f,o,e,c,d){var u=new Ge(d);return u.update(o,e,c),u.finish(t,f),0}function Yt(t,f,o,e,c,d){var u=new Uint8Array(16);return xt(u,0,o,e,c,d),X(t,f,u,0)}function yt(t,f,o,e,c){var d;if(o<32)return-1;for(pt(t,0,f,0,o,e,c),xt(t,16,t,32,o-32,t),d=0;d<16;d++)t[d]=0;return 0}function mt(t,f,o,e,c){var d,u=new Uint8Array(32);if(o<32||(qt(u,0,32,e,c),Yt(f,16,f,32,o-32,u)!==0))return-1;for(pt(t,0,f,0,o,e,c),d=0;d<32;d++)t[d]=0;return 0}function Be(t,f){var o;for(o=0;o<16;o++)t[o]=f[o]|0}function bt(t){var f,o,e=1;for(f=0;f<16;f++)o=t[f]+e+65535,e=Math.floor(o/65536),t[f]=o-e*65536;t[0]+=e-1+37*(e-1)}function Ke(t,f,o){for(var e,c=~(o-1),d=0;d<16;d++)e=c&(t[d]^f[d]),t[d]^=e,f[d]^=e}function Ue(t,f){var o,e,c,d=r(),u=r();for(o=0;o<16;o++)u[o]=f[o];for(bt(u),bt(u),bt(u),e=0;e<2;e++){for(d[0]=u[0]-65517,o=1;o<15;o++)d[o]=u[o]-65535-(d[o-1]>>16&1),d[o-1]&=65535;d[15]=u[15]-32767-(d[14]>>16&1),c=d[15]>>16&1,d[14]&=65535,Ke(u,d,1-c)}for(o=0;o<16;o++)t[2*o]=u[o]&255,t[2*o+1]=u[o]>>8}function Ft(t,f){var o=new Uint8Array(32),e=new Uint8Array(32);return Ue(o,t),Ue(e,f),pe(o,0,e,0)}function Vt(t){var f=new Uint8Array(32);return Ue(f,t),f[0]&1}function gt(t,f){var o;for(o=0;o<16;o++)t[o]=f[2*o]+(f[2*o+1]<<8);t[15]&=32767}function Ee(t,f,o){for(var e=0;e<16;e++)t[e]=f[e]+o[e]}function _e(t,f,o){for(var e=0;e<16;e++)t[e]=f[e]-o[e]}function te(t,f,o){var e,c,d=0,u=0,b=0,A=0,j=0,B=0,oe=0,M=0,q=0,Y=0,G=0,z=0,F=0,k=0,V=0,P=0,$=0,L=0,T=0,K=0,_=0,p=0,x=0,v=0,m=0,g=0,w=0,D=0,H=0,Z=0,J=0,i=o[0],Q=o[1],fe=o[2],ae=o[3],W=o[4],ne=o[5],re=o[6],ue=o[7],ce=o[8],ie=o[9],le=o[10],de=o[11],he=o[12],xe=o[13],ye=o[14],me=o[15];e=f[0],d+=e*i,u+=e*Q,b+=e*fe,A+=e*ae,j+=e*W,B+=e*ne,oe+=e*re,M+=e*ue,q+=e*ce,Y+=e*ie,G+=e*le,z+=e*de,F+=e*he,k+=e*xe,V+=e*ye,P+=e*me,e=f[1],u+=e*i,b+=e*Q,A+=e*fe,j+=e*ae,B+=e*W,oe+=e*ne,M+=e*re,q+=e*ue,Y+=e*ce,G+=e*ie,z+=e*le,F+=e*de,k+=e*he,V+=e*xe,P+=e*ye,$+=e*me,e=f[2],b+=e*i,A+=e*Q,j+=e*fe,B+=e*ae,oe+=e*W,M+=e*ne,q+=e*re,Y+=e*ue,G+=e*ce,z+=e*ie,F+=e*le,k+=e*de,V+=e*he,P+=e*xe,$+=e*ye,L+=e*me,e=f[3],A+=e*i,j+=e*Q,B+=e*fe,oe+=e*ae,M+=e*W,q+=e*ne,Y+=e*re,G+=e*ue,z+=e*ce,F+=e*ie,k+=e*le,V+=e*de,P+=e*he,$+=e*xe,L+=e*ye,T+=e*me,e=f[4],j+=e*i,B+=e*Q,oe+=e*fe,M+=e*ae,q+=e*W,Y+=e*ne,G+=e*re,z+=e*ue,F+=e*ce,k+=e*ie,V+=e*le,P+=e*de,$+=e*he,L+=e*xe,T+=e*ye,K+=e*me,e=f[5],B+=e*i,oe+=e*Q,M+=e*fe,q+=e*ae,Y+=e*W,G+=e*ne,z+=e*re,F+=e*ue,k+=e*ce,V+=e*ie,P+=e*le,$+=e*de,L+=e*he,T+=e*xe,K+=e*ye,_+=e*me,e=f[6],oe+=e*i,M+=e*Q,q+=e*fe,Y+=e*ae,G+=e*W,z+=e*ne,F+=e*re,k+=e*ue,V+=e*ce,P+=e*ie,$+=e*le,L+=e*de,T+=e*he,K+=e*xe,_+=e*ye,p+=e*me,e=f[7],M+=e*i,q+=e*Q,Y+=e*fe,G+=e*ae,z+=e*W,F+=e*ne,k+=e*re,V+=e*ue,P+=e*ce,$+=e*ie,L+=e*le,T+=e*de,K+=e*he,_+=e*xe,p+=e*ye,x+=e*me,e=f[8],q+=e*i,Y+=e*Q,G+=e*fe,z+=e*ae,F+=e*W,k+=e*ne,V+=e*re,P+=e*ue,$+=e*ce,L+=e*ie,T+=e*le,K+=e*de,_+=e*he,p+=e*xe,x+=e*ye,v+=e*me,e=f[9],Y+=e*i,G+=e*Q,z+=e*fe,F+=e*ae,k+=e*W,V+=e*ne,P+=e*re,$+=e*ue,L+=e*ce,T+=e*ie,K+=e*le,_+=e*de,p+=e*he,x+=e*xe,v+=e*ye,m+=e*me,e=f[10],G+=e*i,z+=e*Q,F+=e*fe,k+=e*ae,V+=e*W,P+=e*ne,$+=e*re,L+=e*ue,T+=e*ce,K+=e*ie,_+=e*le,p+=e*de,x+=e*he,v+=e*xe,m+=e*ye,g+=e*me,e=f[11],z+=e*i,F+=e*Q,k+=e*fe,V+=e*ae,P+=e*W,$+=e*ne,L+=e*re,T+=e*ue,K+=e*ce,_+=e*ie,p+=e*le,x+=e*de,v+=e*he,m+=e*xe,g+=e*ye,w+=e*me,e=f[12],F+=e*i,k+=e*Q,V+=e*fe,P+=e*ae,$+=e*W,L+=e*ne,T+=e*re,K+=e*ue,_+=e*ce,p+=e*ie,x+=e*le,v+=e*de,m+=e*he,g+=e*xe,w+=e*ye,D+=e*me,e=f[13],k+=e*i,V+=e*Q,P+=e*fe,$+=e*ae,L+=e*W,T+=e*ne,K+=e*re,_+=e*ue,p+=e*ce,x+=e*ie,v+=e*le,m+=e*de,g+=e*he,w+=e*xe,D+=e*ye,H+=e*me,e=f[14],V+=e*i,P+=e*Q,$+=e*fe,L+=e*ae,T+=e*W,K+=e*ne,_+=e*re,p+=e*ue,x+=e*ce,v+=e*ie,m+=e*le,g+=e*de,w+=e*he,D+=e*xe,H+=e*ye,Z+=e*me,e=f[15],P+=e*i,$+=e*Q,L+=e*fe,T+=e*ae,K+=e*W,_+=e*ne,p+=e*re,x+=e*ue,v+=e*ce,m+=e*ie,g+=e*le,w+=e*de,D+=e*he,H+=e*xe,Z+=e*ye,J+=e*me,d+=38*$,u+=38*L,b+=38*T,A+=38*K,j+=38*_,B+=38*p,oe+=38*x,M+=38*v,q+=38*m,Y+=38*g,G+=38*w,z+=38*D,F+=38*H,k+=38*Z,V+=38*J,c=1,e=d+c+65535,c=Math.floor(e/65536),d=e-c*65536,e=u+c+65535,c=Math.floor(e/65536),u=e-c*65536,e=b+c+65535,c=Math.floor(e/65536),b=e-c*65536,e=A+c+65535,c=Math.floor(e/65536),A=e-c*65536,e=j+c+65535,c=Math.floor(e/65536),j=e-c*65536,e=B+c+65535,c=Math.floor(e/65536),B=e-c*65536,e=oe+c+65535,c=Math.floor(e/65536),oe=e-c*65536,e=M+c+65535,c=Math.floor(e/65536),M=e-c*65536,e=q+c+65535,c=Math.floor(e/65536),q=e-c*65536,e=Y+c+65535,c=Math.floor(e/65536),Y=e-c*65536,e=G+c+65535,c=Math.floor(e/65536),G=e-c*65536,e=z+c+65535,c=Math.floor(e/65536),z=e-c*65536,e=F+c+65535,c=Math.floor(e/65536),F=e-c*65536,e=k+c+65535,c=Math.floor(e/65536),k=e-c*65536,e=V+c+65535,c=Math.floor(e/65536),V=e-c*65536,e=P+c+65535,c=Math.floor(e/65536),P=e-c*65536,d+=c-1+37*(c-1),c=1,e=d+c+65535,c=Math.floor(e/65536),d=e-c*65536,e=u+c+65535,c=Math.floor(e/65536),u=e-c*65536,e=b+c+65535,c=Math.floor(e/65536),b=e-c*65536,e=A+c+65535,c=Math.floor(e/65536),A=e-c*65536,e=j+c+65535,c=Math.floor(e/65536),j=e-c*65536,e=B+c+65535,c=Math.floor(e/65536),B=e-c*65536,e=oe+c+65535,c=Math.floor(e/65536),oe=e-c*65536,e=M+c+65535,c=Math.floor(e/65536),M=e-c*65536,e=q+c+65535,c=Math.floor(e/65536),q=e-c*65536,e=Y+c+65535,c=Math.floor(e/65536),Y=e-c*65536,e=G+c+65535,c=Math.floor(e/65536),G=e-c*65536,e=z+c+65535,c=Math.floor(e/65536),z=e-c*65536,e=F+c+65535,c=Math.floor(e/65536),F=e-c*65536,e=k+c+65535,c=Math.floor(e/65536),k=e-c*65536,e=V+c+65535,c=Math.floor(e/65536),V=e-c*65536,e=P+c+65535,c=Math.floor(e/65536),P=e-c*65536,d+=c-1+37*(c-1),t[0]=d,t[1]=u,t[2]=b,t[3]=A,t[4]=j,t[5]=B,t[6]=oe,t[7]=M,t[8]=q,t[9]=Y,t[10]=G,t[11]=z,t[12]=F,t[13]=k,t[14]=V,t[15]=P}function Ae(t,f){te(t,f,f)}function kt(t,f){var o=r(),e;for(e=0;e<16;e++)o[e]=f[e];for(e=253;e>=0;e--)Ae(o,o),e!==2&&e!==4&&te(o,o,f);for(e=0;e<16;e++)t[e]=o[e]}function zt(t,f){var o=r(),e;for(e=0;e<16;e++)o[e]=f[e];for(e=250;e>=0;e--)Ae(o,o),e!==1&&te(o,o,f);for(e=0;e<16;e++)t[e]=o[e]}function He(t,f,o){var e=new Uint8Array(32),c=new Float64Array(80),d,u,b=r(),A=r(),j=r(),B=r(),oe=r(),M=r();for(u=0;u<31;u++)e[u]=f[u];for(e[31]=f[31]&127|64,e[0]&=248,gt(c,o),u=0;u<16;u++)A[u]=c[u],B[u]=b[u]=j[u]=0;for(b[0]=B[0]=1,u=254;u>=0;--u)d=e[u>>>3]>>>(u&7)&1,Ke(b,A,d),Ke(j,B,d),Ee(oe,b,j),_e(b,b,j),Ee(j,A,B),_e(A,A,B),Ae(B,oe),Ae(M,b),te(b,j,b),te(j,A,oe),Ee(oe,b,j),_e(b,b,j),Ae(A,b),_e(j,B,M),te(b,j,C),Ee(b,b,B),te(j,j,b),te(b,B,M),te(B,A,c),Ae(A,oe),Ke(b,A,d),Ke(j,B,d);for(u=0;u<16;u++)c[u+16]=b[u],c[u+32]=j[u],c[u+48]=A[u],c[u+64]=B[u];var q=c.subarray(32),Y=c.subarray(16);return kt(q,q),te(Y,Y,q),Ue(t,Y),0}function Je(t,f){return He(t,f,h)}function Gt(t,f){return s(f,32),Je(t,f)}function Ze(t,f,o){var e=new Uint8Array(32);return He(e,o,f),ge(t,l,e,Ce)}var Ht=yt,An=mt;function En(t,f,o,e,c,d){var u=new Uint8Array(32);return Ze(u,c,d),Ht(t,f,o,e,u)}function _n(t,f,o,e,c,d){var u=new Uint8Array(32);return Ze(u,c,d),An(t,f,o,e,u)}var Jt=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591];function Zt(t,f,o,e){for(var c=new Int32Array(16),d=new Int32Array(16),u,b,A,j,B,oe,M,q,Y,G,z,F,k,V,P,$,L,T,K,_,p,x,v,m,g,w,D=t[0],H=t[1],Z=t[2],J=t[3],i=t[4],Q=t[5],fe=t[6],ae=t[7],W=f[0],ne=f[1],re=f[2],ue=f[3],ce=f[4],ie=f[5],le=f[6],de=f[7],he=0;e>=128;){for(K=0;K<16;K++)_=8*K+he,c[K]=o[_+0]<<24|o[_+1]<<16|o[_+2]<<8|o[_+3],d[K]=o[_+4]<<24|o[_+5]<<16|o[_+6]<<8|o[_+7];for(K=0;K<80;K++)if(u=D,b=H,A=Z,j=J,B=i,oe=Q,M=fe,q=ae,Y=W,G=ne,z=re,F=ue,k=ce,V=ie,P=le,$=de,p=ae,x=de,v=x&65535,m=x>>>16,g=p&65535,w=p>>>16,p=(i>>>14|ce<<18)^(i>>>18|ce<<14)^(ce>>>9|i<<23),x=(ce>>>14|i<<18)^(ce>>>18|i<<14)^(i>>>9|ce<<23),v+=x&65535,m+=x>>>16,g+=p&65535,w+=p>>>16,p=i&Q^~i&fe,x=ce&ie^~ce&le,v+=x&65535,m+=x>>>16,g+=p&65535,w+=p>>>16,p=Jt[K*2],x=Jt[K*2+1],v+=x&65535,m+=x>>>16,g+=p&65535,w+=p>>>16,p=c[K%16],x=d[K%16],v+=x&65535,m+=x>>>16,g+=p&65535,w+=p>>>16,m+=v>>>16,g+=m>>>16,w+=g>>>16,L=g&65535|w<<16,T=v&65535|m<<16,p=L,x=T,v=x&65535,m=x>>>16,g=p&65535,w=p>>>16,p=(D>>>28|W<<4)^(W>>>2|D<<30)^(W>>>7|D<<25),x=(W>>>28|D<<4)^(D>>>2|W<<30)^(D>>>7|W<<25),v+=x&65535,m+=x>>>16,g+=p&65535,w+=p>>>16,p=D&H^D&Z^H&Z,x=W&ne^W&re^ne&re,v+=x&65535,m+=x>>>16,g+=p&65535,w+=p>>>16,m+=v>>>16,g+=m>>>16,w+=g>>>16,q=g&65535|w<<16,$=v&65535|m<<16,p=j,x=F,v=x&65535,m=x>>>16,g=p&65535,w=p>>>16,p=L,x=T,v+=x&65535,m+=x>>>16,g+=p&65535,w+=p>>>16,m+=v>>>16,g+=m>>>16,w+=g>>>16,j=g&65535|w<<16,F=v&65535|m<<16,H=u,Z=b,J=A,i=j,Q=B,fe=oe,ae=M,D=q,ne=Y,re=G,ue=z,ce=F,ie=k,le=V,de=P,W=$,K%16===15)for(_=0;_<16;_++)p=c[_],x=d[_],v=x&65535,m=x>>>16,g=p&65535,w=p>>>16,p=c[(_+9)%16],x=d[(_+9)%16],v+=x&65535,m+=x>>>16,g+=p&65535,w+=p>>>16,L=c[(_+1)%16],T=d[(_+1)%16],p=(L>>>1|T<<31)^(L>>>8|T<<24)^L>>>7,x=(T>>>1|L<<31)^(T>>>8|L<<24)^(T>>>7|L<<25),v+=x&65535,m+=x>>>16,g+=p&65535,w+=p>>>16,L=c[(_+14)%16],T=d[(_+14)%16],p=(L>>>19|T<<13)^(T>>>29|L<<3)^L>>>6,x=(T>>>19|L<<13)^(L>>>29|T<<3)^(T>>>6|L<<26),v+=x&65535,m+=x>>>16,g+=p&65535,w+=p>>>16,m+=v>>>16,g+=m>>>16,w+=g>>>16,c[_]=g&65535|w<<16,d[_]=v&65535|m<<16;p=D,x=W,v=x&65535,m=x>>>16,g=p&65535,w=p>>>16,p=t[0],x=f[0],v+=x&65535,m+=x>>>16,g+=p&65535,w+=p>>>16,m+=v>>>16,g+=m>>>16,w+=g>>>16,t[0]=D=g&65535|w<<16,f[0]=W=v&65535|m<<16,p=H,x=ne,v=x&65535,m=x>>>16,g=p&65535,w=p>>>16,p=t[1],x=f[1],v+=x&65535,m+=x>>>16,g+=p&65535,w+=p>>>16,m+=v>>>16,g+=m>>>16,w+=g>>>16,t[1]=H=g&65535|w<<16,f[1]=ne=v&65535|m<<16,p=Z,x=re,v=x&65535,m=x>>>16,g=p&65535,w=p>>>16,p=t[2],x=f[2],v+=x&65535,m+=x>>>16,g+=p&65535,w+=p>>>16,m+=v>>>16,g+=m>>>16,w+=g>>>16,t[2]=Z=g&65535|w<<16,f[2]=re=v&65535|m<<16,p=J,x=ue,v=x&65535,m=x>>>16,g=p&65535,w=p>>>16,p=t[3],x=f[3],v+=x&65535,m+=x>>>16,g+=p&65535,w+=p>>>16,m+=v>>>16,g+=m>>>16,w+=g>>>16,t[3]=J=g&65535|w<<16,f[3]=ue=v&65535|m<<16,p=i,x=ce,v=x&65535,m=x>>>16,g=p&65535,w=p>>>16,p=t[4],x=f[4],v+=x&65535,m+=x>>>16,g+=p&65535,w+=p>>>16,m+=v>>>16,g+=m>>>16,w+=g>>>16,t[4]=i=g&65535|w<<16,f[4]=ce=v&65535|m<<16,p=Q,x=ie,v=x&65535,m=x>>>16,g=p&65535,w=p>>>16,p=t[5],x=f[5],v+=x&65535,m+=x>>>16,g+=p&65535,w+=p>>>16,m+=v>>>16,g+=m>>>16,w+=g>>>16,t[5]=Q=g&65535|w<<16,f[5]=ie=v&65535|m<<16,p=fe,x=le,v=x&65535,m=x>>>16,g=p&65535,w=p>>>16,p=t[6],x=f[6],v+=x&65535,m+=x>>>16,g+=p&65535,w+=p>>>16,m+=v>>>16,g+=m>>>16,w+=g>>>16,t[6]=fe=g&65535|w<<16,f[6]=le=v&65535|m<<16,p=ae,x=de,v=x&65535,m=x>>>16,g=p&65535,w=p>>>16,p=t[7],x=f[7],v+=x&65535,m+=x>>>16,g+=p&65535,w+=p>>>16,m+=v>>>16,g+=m>>>16,w+=g>>>16,t[7]=ae=g&65535|w<<16,f[7]=de=v&65535|m<<16,he+=128,e-=128}return e}function Le(t,f,o){var e=new Int32Array(8),c=new Int32Array(8),d=new Uint8Array(256),u,b=o;for(e[0]=1779033703,e[1]=3144134277,e[2]=1013904242,e[3]=2773480762,e[4]=1359893119,e[5]=2600822924,e[6]=528734635,e[7]=1541459225,c[0]=4089235720,c[1]=2227873595,c[2]=4271175723,c[3]=1595750129,c[4]=2917565137,c[5]=725511199,c[6]=4215389547,c[7]=327033209,Zt(e,c,f,o),o%=128,u=0;u<o;u++)d[u]=f[b-o+u];for(d[o]=128,o=256-128*(o<112?1:0),d[o-9]=0,ee(d,o-8,b/536870912|0,b<<3),Zt(e,c,d,o),u=0;u<8;u++)ee(t,8*u,e[u],c[u]);return 0}function We(t,f){var o=r(),e=r(),c=r(),d=r(),u=r(),b=r(),A=r(),j=r(),B=r();_e(o,t[1],t[0]),_e(B,f[1],f[0]),te(o,o,B),Ee(e,t[0],t[1]),Ee(B,f[0],f[1]),te(e,e,B),te(c,t[3],f[3]),te(c,c,E),te(d,t[2],f[2]),Ee(d,d,d),_e(u,e,o),_e(b,d,c),Ee(A,d,c),Ee(j,e,o),te(t[0],u,b),te(t[1],j,A),te(t[2],A,b),te(t[3],u,j)}function Wt(t,f,o){var e;for(e=0;e<4;e++)Ke(t[e],f[e],o)}function vt(t,f){var o=r(),e=r(),c=r();kt(c,f[2]),te(o,f[0],c),te(e,f[1],c),Ue(t,e),t[31]^=Vt(o)<<7}function wt(t,f,o){var e,c;for(Be(t[0],y),Be(t[1],S),Be(t[2],S),Be(t[3],y),c=255;c>=0;--c)e=o[c/8|0]>>(c&7)&1,Wt(t,f,e),We(f,t),We(t,t),Wt(t,f,e)}function Xe(t,f){var o=[r(),r(),r(),r()];Be(o[0],O),Be(o[1],I),Be(o[2],S),te(o[3],O,I),wt(t,o,f)}function St(t,f,o){var e=new Uint8Array(64),c=[r(),r(),r(),r()],d;for(o||s(f,32),Le(e,f,32),e[0]&=248,e[31]&=127,e[31]|=64,Xe(c,e),vt(t,c),d=0;d<32;d++)f[d+32]=t[d];return 0}var Qe=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function Ct(t,f){var o,e,c,d;for(e=63;e>=32;--e){for(o=0,c=e-32,d=e-12;c<d;++c)f[c]+=o-16*f[e]*Qe[c-(e-32)],o=Math.floor((f[c]+128)/256),f[c]-=o*256;f[c]+=o,f[e]=0}for(o=0,c=0;c<32;c++)f[c]+=o-(f[31]>>4)*Qe[c],o=f[c]>>8,f[c]&=255;for(c=0;c<32;c++)f[c]-=o*Qe[c];for(e=0;e<32;e++)f[e+1]+=f[e]>>8,t[e]=f[e]&255}function At(t){var f=new Float64Array(64),o;for(o=0;o<64;o++)f[o]=t[o];for(o=0;o<64;o++)t[o]=0;Ct(t,f)}function Xt(t,f,o,e){var c=new Uint8Array(64),d=new Uint8Array(64),u=new Uint8Array(64),b,A,j=new Float64Array(64),B=[r(),r(),r(),r()];Le(c,e,32),c[0]&=248,c[31]&=127,c[31]|=64;var oe=o+64;for(b=0;b<o;b++)t[64+b]=f[b];for(b=0;b<32;b++)t[32+b]=c[32+b];for(Le(u,t.subarray(32),o+32),At(u),Xe(B,u),vt(t,B),b=32;b<64;b++)t[b]=e[b];for(Le(d,t,o+64),At(d),b=0;b<64;b++)j[b]=0;for(b=0;b<32;b++)j[b]=u[b];for(b=0;b<32;b++)for(A=0;A<32;A++)j[b+A]+=d[b]*c[A];return Ct(t.subarray(32),j),oe}function In(t,f){var o=r(),e=r(),c=r(),d=r(),u=r(),b=r(),A=r();return Be(t[2],S),gt(t[1],f),Ae(c,t[1]),te(d,c,U),_e(c,c,t[2]),Ee(d,t[2],d),Ae(u,d),Ae(b,u),te(A,b,u),te(o,A,c),te(o,o,d),zt(o,o),te(o,o,c),te(o,o,d),te(o,o,d),te(t[0],o,d),Ae(e,t[0]),te(e,e,d),Ft(e,c)&&te(t[0],t[0],N),Ae(e,t[0]),te(e,e,d),Ft(e,c)?-1:(Vt(t[0])===f[31]>>7&&_e(t[0],y,t[0]),te(t[3],t[0],t[1]),0)}function Et(t,f,o,e){var c,d=new Uint8Array(32),u=new Uint8Array(64),b=[r(),r(),r(),r()],A=[r(),r(),r(),r()];if(o<64||In(A,e))return-1;for(c=0;c<o;c++)t[c]=f[c];for(c=0;c<32;c++)t[c+32]=e[c];if(Le(u,t,o),At(u),wt(b,A,u),Xe(A,f.subarray(32)),We(b,A),vt(d,b),o-=64,pe(f,0,d,0)){for(c=0;c<o;c++)t[c]=0;return-1}for(c=0;c<o;c++)t[c]=f[c+64];return o}var _t=32,et=24,De=32,Oe=16,Re=32,tt=32,qe=32,Ye=32,It=32,Qt=et,Bn=De,Nn=Oe,Ne=64,Me=32,je=64,Bt=32,Nt=64;n.lowlevel={crypto_core_hsalsa20:ge,crypto_stream_xor:pt,crypto_stream:qt,crypto_stream_salsa20_xor:Te,crypto_stream_salsa20:Rt,crypto_onetimeauth:xt,crypto_onetimeauth_verify:Yt,crypto_verify_16:X,crypto_verify_32:pe,crypto_secretbox:yt,crypto_secretbox_open:mt,crypto_scalarmult:He,crypto_scalarmult_base:Je,crypto_box_beforenm:Ze,crypto_box_afternm:Ht,crypto_box:En,crypto_box_open:_n,crypto_box_keypair:Gt,crypto_hash:Le,crypto_sign:Xt,crypto_sign_keypair:St,crypto_sign_open:Et,crypto_secretbox_KEYBYTES:_t,crypto_secretbox_NONCEBYTES:et,crypto_secretbox_ZEROBYTES:De,crypto_secretbox_BOXZEROBYTES:Oe,crypto_scalarmult_BYTES:Re,crypto_scalarmult_SCALARBYTES:tt,crypto_box_PUBLICKEYBYTES:qe,crypto_box_SECRETKEYBYTES:Ye,crypto_box_BEFORENMBYTES:It,crypto_box_NONCEBYTES:Qt,crypto_box_ZEROBYTES:Bn,crypto_box_BOXZEROBYTES:Nn,crypto_sign_BYTES:Ne,crypto_sign_PUBLICKEYBYTES:Me,crypto_sign_SECRETKEYBYTES:je,crypto_sign_SEEDBYTES:Bt,crypto_hash_BYTES:Nt,gf:r,D:U,L:Qe,pack25519:Ue,unpack25519:gt,M:te,A:Ee,S:Ae,Z:_e,pow2523:zt,add:We,set25519:Be,modL:Ct,scalarmult:wt,scalarbase:Xe};function en(t,f){if(t.length!==_t)throw new Error("bad key size");if(f.length!==et)throw new Error("bad nonce size")}function Ln(t,f){if(t.length!==qe)throw new Error("bad public key size");if(f.length!==Ye)throw new Error("bad secret key size")}function we(){for(var t=0;t<arguments.length;t++)if(!(arguments[t]instanceof Uint8Array))throw new TypeError("unexpected type, use Uint8Array")}function tn(t){for(var f=0;f<t.length;f++)t[f]=0}n.randomBytes=function(t){var f=new Uint8Array(t);return s(f,t),f},n.secretbox=function(t,f,o){we(t,f,o),en(o,f);for(var e=new Uint8Array(De+t.length),c=new Uint8Array(e.length),d=0;d<t.length;d++)e[d+De]=t[d];return yt(c,e,e.length,f,o),c.subarray(Oe)},n.secretbox.open=function(t,f,o){we(t,f,o),en(o,f);for(var e=new Uint8Array(Oe+t.length),c=new Uint8Array(e.length),d=0;d<t.length;d++)e[d+Oe]=t[d];return e.length<32||mt(c,e,e.length,f,o)!==0?null:c.subarray(De)},n.secretbox.keyLength=_t,n.secretbox.nonceLength=et,n.secretbox.overheadLength=Oe,n.scalarMult=function(t,f){if(we(t,f),t.length!==tt)throw new Error("bad n size");if(f.length!==Re)throw new Error("bad p size");var o=new Uint8Array(Re);return He(o,t,f),o},n.scalarMult.base=function(t){if(we(t),t.length!==tt)throw new Error("bad n size");var f=new Uint8Array(Re);return Je(f,t),f},n.scalarMult.scalarLength=tt,n.scalarMult.groupElementLength=Re,n.box=function(t,f,o,e){var c=n.box.before(o,e);return n.secretbox(t,f,c)},n.box.before=function(t,f){we(t,f),Ln(t,f);var o=new Uint8Array(It);return Ze(o,t,f),o},n.box.after=n.secretbox,n.box.open=function(t,f,o,e){var c=n.box.before(o,e);return n.secretbox.open(t,f,c)},n.box.open.after=n.secretbox.open,n.box.keyPair=function(){var t=new Uint8Array(qe),f=new Uint8Array(Ye);return Gt(t,f),{publicKey:t,secretKey:f}},n.box.keyPair.fromSecretKey=function(t){if(we(t),t.length!==Ye)throw new Error("bad secret key size");var f=new Uint8Array(qe);return Je(f,t),{publicKey:f,secretKey:new Uint8Array(t)}},n.box.publicKeyLength=qe,n.box.secretKeyLength=Ye,n.box.sharedKeyLength=It,n.box.nonceLength=Qt,n.box.overheadLength=n.secretbox.overheadLength,n.sign=function(t,f){if(we(t,f),f.length!==je)throw new Error("bad secret key size");var o=new Uint8Array(Ne+t.length);return Xt(o,t,t.length,f),o},n.sign.open=function(t,f){if(we(t,f),f.length!==Me)throw new Error("bad public key size");var o=new Uint8Array(t.length),e=Et(o,t,t.length,f);if(e<0)return null;for(var c=new Uint8Array(e),d=0;d<c.length;d++)c[d]=o[d];return c},n.sign.detached=function(t,f){for(var o=n.sign(t,f),e=new Uint8Array(Ne),c=0;c<e.length;c++)e[c]=o[c];return e},n.sign.detached.verify=function(t,f,o){if(we(t,f,o),f.length!==Ne)throw new Error("bad signature size");if(o.length!==Me)throw new Error("bad public key size");var e=new Uint8Array(Ne+t.length),c=new Uint8Array(Ne+t.length),d;for(d=0;d<Ne;d++)e[d]=f[d];for(d=0;d<t.length;d++)e[d+Ne]=t[d];return Et(c,e,e.length,o)>=0},n.sign.keyPair=function(){var t=new Uint8Array(Me),f=new Uint8Array(je);return St(t,f),{publicKey:t,secretKey:f}},n.sign.keyPair.fromSecretKey=function(t){if(we(t),t.length!==je)throw new Error("bad secret key size");for(var f=new Uint8Array(Me),o=0;o<f.length;o++)f[o]=t[32+o];return{publicKey:f,secretKey:new Uint8Array(t)}},n.sign.keyPair.fromSeed=function(t){if(we(t),t.length!==Bt)throw new Error("bad seed size");for(var f=new Uint8Array(Me),o=new Uint8Array(je),e=0;e<32;e++)o[e]=t[e];return St(f,o,!0),{publicKey:f,secretKey:o}},n.sign.publicKeyLength=Me,n.sign.secretKeyLength=je,n.sign.seedLength=Bt,n.sign.signatureLength=Ne,n.hash=function(t){we(t);var f=new Uint8Array(Nt);return Le(f,t,t.length),f},n.hash.hashLength=Nt,n.verify=function(t,f){return we(t,f),t.length===0||f.length===0||t.length!==f.length?!1:R(t,0,f,0,t.length)===0},n.setPRNG=function(t){s=t},function(){var t=typeof self<"u"?self.crypto||self.msCrypto:null;if(t&&t.getRandomValues){var f=65536;n.setPRNG(function(o,e){var c,d=new Uint8Array(e);for(c=0;c<e;c+=f)t.getRandomValues(d.subarray(c,c+Math.min(e-c,f)));for(c=0;c<e;c++)o[c]=d[c];tn(d)})}else typeof Kn<"u"&&(t=jn,t&&t.randomBytes&&n.setPRNG(function(o,e){var c,d=t.randomBytes(e);for(c=0;c<e;c++)o[c]=d[c];tn(d)}))}()})(a.exports?a.exports:self.nacl=self.nacl||{})})(xn);var $n=xn.exports;const yn=Pn($n);var mn={exports:{}};(function(a){(function(n,r){a.exports?a.exports=r():(n.nacl||(n.nacl={}),n.nacl.util=r())})(Mn,function(){var n={};function r(s){if(!/^(?:[A-Za-z0-9+\/]{2}[A-Za-z0-9+\/]{2})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+\/]{3}=)?$/.test(s))throw new TypeError("invalid encoding")}return n.decodeUTF8=function(s){if(typeof s!="string")throw new TypeError("expected string");var l,h=unescape(encodeURIComponent(s)),y=new Uint8Array(h.length);for(l=0;l<h.length;l++)y[l]=h.charCodeAt(l);return y},n.encodeUTF8=function(s){var l,h=[];for(l=0;l<s.length;l++)h.push(String.fromCharCode(s[l]));return decodeURIComponent(escape(h.join("")))},typeof atob>"u"?typeof Buffer.from<"u"?(n.encodeBase64=function(s){return Buffer.from(s).toString("base64")},n.decodeBase64=function(s){return r(s),new Uint8Array(Array.prototype.slice.call(Buffer.from(s,"base64"),0))}):(n.encodeBase64=function(s){return new Buffer(s).toString("base64")},n.decodeBase64=function(s){return r(s),new Uint8Array(Array.prototype.slice.call(new Buffer(s,"base64"),0))}):(n.encodeBase64=function(s){var l,h=[],y=s.length;for(l=0;l<y;l++)h.push(String.fromCharCode(s[l]));return btoa(h.join(""))},n.decodeBase64=function(s){r(s);var l,h=atob(s),y=new Uint8Array(h.length);for(l=0;l<h.length;l++)y[l]=h.charCodeAt(l);return y}),n})})(mn);var bn=mn.exports;const Mt="meshlang_actors",Fe="meshlang_active_actor",nn="meshlang_keys",nt="meshlang_active_key";function ke(){const a=localStorage.getItem(Mt);if(a)try{const r=JSON.parse(a);return{actors:r.actors||r.keys||[]}}catch{return{actors:[]}}const n=localStorage.getItem(nn);if(n)try{const s={actors:JSON.parse(n).keys||[]};localStorage.setItem(Mt,JSON.stringify(s)),localStorage.removeItem(nn);const l=localStorage.getItem(nt);return l&&(localStorage.setItem(Fe,l),localStorage.removeItem(nt)),s}catch{return{actors:[]}}return{actors:[]}}function Ot(a){localStorage.setItem(Mt,JSON.stringify(a))}function jt(){const a=localStorage.getItem(Fe);if(a)return a;const n=localStorage.getItem(nt);return n?(localStorage.setItem(Fe,n),localStorage.removeItem(nt),n):null}function ot(a){localStorage.setItem(Fe,a)}function gn(){return ke().actors}function $t(a){return ke().actors.find(r=>r.id===a)||null}function vn(a,n,r){const s=ke(),l=s.actors.findIndex(y=>y.id===a),h={id:a,name:n,publicKey:Array.from(r.publicKey),secretKey:Array.from(r.secretKey),createdAt:Date.now()};l>=0?s.actors[l]=h:s.actors.push(h),Ot(s)}function Dn(a){const n=ke();n.actors=n.actors.filter(r=>r.id!==a),Ot(n),jt()===a&&localStorage.removeItem(Fe)}function Rn(a,n){const r=ke(),s=r.actors.find(l=>l.id===a);s&&(s.name=n,Ot(r))}function Pt(a){return{publicKey:new Uint8Array(a.publicKey),secretKey:new Uint8Array(a.secretKey)}}function qn(){const{publicKey:a,secretKey:n}=yn.sign.keyPair();return{publicKey:a,secretKey:n}}function Dt(a){const n=yn.hash(a);return bn.encodeBase64(n.slice(0,16)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function Ve(a){return{keyPair:a,nodeId:Dt(a.publicKey),publicKeyBase64:bn.encodeBase64(a.publicKey)}}function wn(a){const n=qn(),r=Dt(n.publicKey),s=a||`Actor ${new Date().toLocaleString()}`;return vn(r,s,n),ot(r),Ve(n)}function Yn(a){const n=$t(a);return n?(ot(a),Ve(Pt(n))):null}function Fn(){const a=gn(),n=jt();if(n){const r=$t(n);if(r)return Ve(Pt(r))}return a.length>0?(ot(a[0].id),Ve(Pt(a[0]))):wn("Default Actor")}function Pe(){return gn()}function ft(){return jt()}function Vn(a){try{const n=JSON.parse(atob(a));if(!n.publicKey||!n.secretKey)return null;const r={publicKey:new Uint8Array(n.publicKey),secretKey:new Uint8Array(n.secretKey)},s=Dt(r.publicKey),l=n.name||`Imported ${new Date().toLocaleString()}`;return vn(s,l,r),ot(s),Ve(r)}catch{return null}}function kn(a){const n=$t(a);if(!n)return null;const r={name:n.name,publicKey:n.publicKey,secretKey:n.secretKey};return btoa(JSON.stringify(r))}class zn{facts=new Map;byScope=new Map;byKey=new Map;byValue=new Map;listeners=new Set;valueKey(n){return JSON.stringify(n)}factId(n,r){return`${r}:${n[0]}:${this.valueKey(n[1])}`}add(n,r,s){const l=s??r,h=this.factId(n,l);if(this.facts.has(h))return null;const y={id:h,fact:n,scope:l,timestamp:Date.now(),source:r};this.facts.set(h,y),this.byScope.has(l)||this.byScope.set(l,new Set),this.byScope.get(l).add(h),this.byKey.has(n[0])||this.byKey.set(n[0],new Set),this.byKey.get(n[0]).add(h);const S=this.valueKey(n[1]);this.byValue.has(S)||this.byValue.set(S,new Set),this.byValue.get(S).add(h);for(const C of this.listeners)C(y);return y}get(n){return this.facts.get(n)}has(n,r){return this.facts.has(this.factId(n,r))}retract(n,r){const s=this.factId(n,r);if(!this.facts.get(s))return!1;this.facts.delete(s);const h=this.byScope.get(r);h&&(h.delete(s),h.size===0&&this.byScope.delete(r));const y=this.byKey.get(n[0]);y&&(y.delete(s),y.size===0&&this.byKey.delete(n[0]));const S=this.valueKey(n[1]),C=this.byValue.get(S);return C&&(C.delete(s),C.size===0&&this.byValue.delete(S)),!0}all(){return Array.from(this.facts.values())}allIds(){return new Set(this.facts.keys())}findByScope(n){const r=this.byScope.get(n);return r?Array.from(r).map(s=>this.facts.get(s)):[]}findByKey(n){const r=this.byKey.get(n);return r?Array.from(r).map(s=>this.facts.get(s)):[]}findByValue(n){const r=this.byValue.get(this.valueKey(n));return r?Array.from(r).map(s=>this.facts.get(s)):[]}onAdd(n){return this.listeners.add(n),()=>this.listeners.delete(n)}addStored(n){if(this.facts.has(n.id))return!1;this.facts.set(n.id,n);const r=n.fact,s=n.scope;this.byScope.has(s)||this.byScope.set(s,new Set),this.byScope.get(s).add(n.id),this.byKey.has(r[0])||this.byKey.set(r[0],new Set),this.byKey.get(r[0]).add(n.id);const l=this.valueKey(r[1]);this.byValue.has(l)||this.byValue.set(l,new Set),this.byValue.get(l).add(n.id);for(const h of this.listeners)h(n);return!0}}function rn(a){return{id:a.id,k:a.fact[0],v:a.fact[1],sc:a.scope,t:a.timestamp,s:a.source}}function on(a){if("e"in a&&"a"in a){const r=a;return{id:r.id,fact:[r.a,r.v],scope:r.e,timestamp:r.t,source:r.s}}const n=a;return{id:n.id,fact:[n.k,n.v],scope:n.sc,timestamp:n.t,source:n.s}}function Gn(a){return JSON.stringify(a)}function Hn(a){return JSON.parse(a)}class fn{constructor(n,r={iceServers:[{urls:"stun:stun.l.google.com:19302"}]}){this.isInitiator=n,this.config=r,this.connection=new RTCPeerConnection(this.config),this.connection.oniceconnectionstatechange=()=>{console.log("[Peer] ICE connection state:",this.connection.iceConnectionState),(this.connection.iceConnectionState==="disconnected"||this.connection.iceConnectionState==="failed")&&this.setState("disconnected")},this.connection.onconnectionstatechange=()=>{console.log("[Peer] Connection state:",this.connection.connectionState)},this.connection.onsignalingstatechange=()=>{console.log("[Peer] Signaling state:",this.connection.signalingState)},n?(this.channel=this.connection.createDataChannel("meshlang"),this.setupChannel(this.channel)):this.connection.ondatachannel=s=>{this.channel=s.channel,this.setupChannel(this.channel)}}connection;channel=null;state="connecting";messageHandlers=new Set;stateHandlers=new Set;pendingCandidates=[];remoteDescriptionSet=!1;remoteInfo=null;setupChannel(n){console.log("[Peer] Setting up data channel:",n.label),n.onopen=()=>{console.log("[Peer] Data channel opened"),this.setState("connected")},n.onclose=()=>{console.log("[Peer] Data channel closed"),this.setState("disconnected")},n.onerror=r=>{console.error("[Peer] Data channel error:",r)},n.onmessage=r=>{try{const s=Hn(r.data);console.log("[Peer] Received message:",s.type),s.type==="hello"&&(this.remoteInfo={nodeId:s.nodeId,publicKey:s.publicKey});for(const l of this.messageHandlers)l(s)}catch(s){console.error("Failed to decode message:",s)}}}setState(n){this.state=n;for(const r of this.stateHandlers)r(n)}getState(){return this.state}async createOffer(){console.log("[Peer] Creating offer");const n=await this.connection.createOffer();return await this.connection.setLocalDescription(n),console.log("[Peer] Offer created and local description set"),n}async acceptOffer(n){console.log("[Peer] Accepting offer"),await this.connection.setRemoteDescription(n),this.remoteDescriptionSet=!0,await this.flushPendingCandidates();const r=await this.connection.createAnswer();return await this.connection.setLocalDescription(r),console.log("[Peer] Answer created and local description set"),r}async acceptAnswer(n){console.log("[Peer] Accepting answer"),await this.connection.setRemoteDescription(n),this.remoteDescriptionSet=!0,await this.flushPendingCandidates(),console.log("[Peer] Answer accepted, remote description set")}async flushPendingCandidates(){for(const n of this.pendingCandidates)await this.connection.addIceCandidate(n);this.pendingCandidates=[]}async addIceCandidate(n){this.remoteDescriptionSet?await this.connection.addIceCandidate(n):this.pendingCandidates.push(n)}onIceCandidate(n){const r=this.connection.onicecandidate;this.connection.onicecandidate=s=>{s.candidate&&(console.log("[Peer] ICE candidate:",s.candidate.candidate?.substring(0,50)),n(s.candidate)),r&&r.call(this.connection,s)}}onIceGatheringComplete(n){const r=this.connection.onicecandidate;this.connection.onicecandidate=s=>{r&&r.call(this.connection,s),s.candidate||(console.log("[Peer] ICE gathering complete"),n())}}send(n){this.channel&&this.channel.readyState==="open"&&this.channel.send(Gn(n))}onMessage(n){return this.messageHandlers.add(n),()=>this.messageHandlers.delete(n)}onStateChange(n){return this.stateHandlers.add(n),()=>this.stateHandlers.delete(n)}close(){this.channel?.close(),this.connection.close(),this.setState("disconnected")}}class Jn{constructor(n,r){this.identity=n,this.store=r,r.onAdd(s=>{const l={type:"fact-add",fact:rn(s)};this.broadcast(l)})}peers=new Map;listeners=new Set;broadcast(n,r){for(const[s,l]of this.peers)s!==r&&l.getState()==="connected"&&l.send(n)}notifyListeners(){for(const n of this.listeners)n()}setupPeer(n){n.onStateChange(r=>{if(console.log("[Mesh] Peer state changed:",r,"remoteInfo:",n.remoteInfo?.nodeId),r==="connected"){console.log("[Mesh] Sending hello to peer"),n.send({type:"hello",nodeId:this.identity.nodeId,publicKey:this.identity.publicKeyBase64});const s=Array.from(this.store.allIds());console.log("[Mesh] Sending sync request with",s.length,"known facts"),n.send({type:"sync-request",haveIds:s}),this.notifyListeners()}r==="disconnected"&&n.remoteInfo&&(console.log("[Mesh] Peer disconnected:",n.remoteInfo.nodeId),this.peers.delete(n.remoteInfo.nodeId),this.notifyListeners())}),n.onMessage(r=>{console.log("[Mesh] Received message:",r.type),this.handleMessage(n,r)})}handleMessage(n,r){switch(r.type){case"hello":n.remoteInfo={nodeId:r.nodeId,publicKey:r.publicKey},this.peers.set(r.nodeId,n),this.notifyListeners();break;case"sync-request":{const s=new Set(r.haveIds),l=this.store.all().filter(h=>!s.has(h.id)).map(rn);n.send({type:"sync-response",facts:l});break}case"sync-response":for(const s of r.facts){const l=on(s);this.store.addStored(l)}break;case"fact-add":{const s=on(r.fact);this.store.addStored(s)&&this.broadcast(r,n.remoteInfo?.nodeId);break}}}async createOffer(){console.log("[Mesh] Creating offer");const n=new fn(!0),r=[],s=new Promise(y=>{n.onIceCandidate(S=>{r.push(S)}),n.onIceGatheringComplete(()=>y())}),l=await n.createOffer();console.log("[Mesh] Waiting for ICE candidates..."),await s,console.log("[Mesh] Got",r.length,"ICE candidates");const h={type:"offer",nodeId:this.identity.nodeId,publicKey:this.identity.publicKeyBase64,sdp:l,candidates:r.map(y=>y.toJSON())};return this.peers.set("pending-offer",n),this.setupPeer(n),console.log("[Mesh] Offer created, waiting for answer"),btoa(JSON.stringify(h))}async acceptOffer(n){console.log("[Mesh] Accepting offer");const r=JSON.parse(atob(n));console.log("[Mesh] Offer from:",r.nodeId,"with",r.candidates.length,"candidates");const s=new fn(!1);s.remoteInfo={nodeId:r.nodeId,publicKey:r.publicKey};const l=[],h=new Promise(C=>{s.onIceCandidate(U=>{l.push(U)}),s.onIceGatheringComplete(()=>C())}),y=await s.acceptOffer(r.sdp);console.log("[Mesh] Adding",r.candidates.length,"remote ICE candidates");for(const C of r.candidates)await s.addIceCandidate(C);console.log("[Mesh] Waiting for local ICE candidates..."),await h,console.log("[Mesh] Got",l.length,"local ICE candidates"),this.peers.set(r.nodeId,s),this.setupPeer(s);const S={type:"answer",nodeId:this.identity.nodeId,publicKey:this.identity.publicKeyBase64,sdp:y,candidates:l.map(C=>C.toJSON())};return console.log("[Mesh] Answer created"),btoa(JSON.stringify(S))}async acceptAnswer(n){console.log("[Mesh] Accepting answer");const r=JSON.parse(atob(n));console.log("[Mesh] Answer from:",r.nodeId,"with",r.candidates.length,"candidates");const s=this.peers.get("pending-offer");if(!s)throw new Error("No pending offer to accept answer for");this.peers.delete("pending-offer"),s.remoteInfo={nodeId:r.nodeId,publicKey:r.publicKey},this.peers.set(r.nodeId,s),await s.acceptAnswer(r.sdp),console.log("[Mesh] Adding",r.candidates.length,"remote ICE candidates");for(const l of r.candidates)await s.addIceCandidate(l);console.log("[Mesh] Connection established")}getPeers(){const n=[];for(const r of this.peers.values())r.remoteInfo&&r.getState()==="connected"&&n.push(r.remoteInfo);return n}getPeerCount(){return this.getPeers().length}onChange(n){return this.listeners.add(n),()=>this.listeners.delete(n)}}class $e{constructor(n){this.name=n}static isVar(n){return n instanceof $e}}function Lt(a,n,r){if($e.isVar(a)){const s=r.get(a.name);if(s!==void 0)return s===n?r:null;const l=new Map(r);return l.set(a.name,n),l}return a===n?r:null}function Zn(a,n,r,s){let l=r;return s!==void 0&&(l=Lt(s,n.scope,l),!l)||(l=Lt(a[0],n.fact[0],l),!l)?null:(l=Lt(a[1],n.fact[1],l),l)}function Wn(a,n,r){if(n.length===0)return[new Map];let s=[new Map];for(const l of n){const h=[];for(const y of s){let S;const[C,U]=l;r?.scope?S=a.findByScope(r.scope):!$e.isVar(C)&&typeof C=="string"?S=a.findByKey(C):S=a.all(),r?.scope&&!$e.isVar(C)&&(S=S.filter(E=>E.fact[0]===C));for(const E of S){const O=Zn(l,E,y,r?.scopePattern);O&&h.push(O)}}s=h}return s}function an(a){return new $e(a)}function Xn(a){const n={};for(const[r,s]of a)n[`?${r}`]=s;return n}async function cn(a){await navigator.clipboard.writeText(a)}function Qn(a,n,r){a.innerHTML=`
    <div class="exchange">
      <h3>Connect to Peer</h3>
      <div class="exchange-tabs">
        <button class="tab active" data-tab="initiate">Create Invite</button>
        <button class="tab" data-tab="join">Join with Invite</button>
      </div>

      <div class="tab-content" id="initiate-tab">
        <p>1. Click "Generate" to create an invite code</p>
        <button id="generate-offer">Generate Invite</button>
        <textarea id="offer-output" readonly placeholder="Invite code will appear here..."></textarea>
        <button id="copy-offer" disabled>Copy to Clipboard</button>

        <p>2. Share the code with peer, then paste their response:</p>
        <textarea id="answer-input" placeholder="Paste peer's response here..."></textarea>
        <button id="accept-answer" disabled>Connect</button>
      </div>

      <div class="tab-content hidden" id="join-tab">
        <p>1. Paste the invite code from your peer:</p>
        <textarea id="offer-input" placeholder="Paste invite code here..."></textarea>
        <button id="accept-offer">Accept Invite</button>

        <p>2. Copy the response and send it back:</p>
        <textarea id="answer-output" readonly placeholder="Response will appear here..."></textarea>
        <button id="copy-answer" disabled>Copy to Clipboard</button>
      </div>
    </div>
  `;const s=a.querySelectorAll(".tab"),l=a.querySelector("#initiate-tab"),h=a.querySelector("#join-tab");s.forEach(R=>{R.addEventListener("click",()=>{s.forEach(pe=>pe.classList.remove("active")),R.classList.add("active");const X=R.dataset.tab;l.classList.toggle("hidden",X!=="initiate"),h.classList.toggle("hidden",X!=="join")})});const y=a.querySelector("#generate-offer"),S=a.querySelector("#offer-output"),C=a.querySelector("#copy-offer"),U=a.querySelector("#answer-input"),E=a.querySelector("#accept-answer");y.addEventListener("click",async()=>{y.disabled=!0,y.textContent="Generating...";try{const R=await n.createOffer();S.value=R,C.disabled=!1,E.disabled=!1}catch(R){S.value=`Error: ${R}`}y.disabled=!1,y.textContent="Generate Invite"}),C.addEventListener("click",async()=>{await cn(S.value),C.textContent="Copied!",setTimeout(()=>C.textContent="Copy to Clipboard",2e3)}),E.addEventListener("click",async()=>{const R=U.value.trim();if(R)try{await n.acceptAnswer(R)}catch(X){alert(`Failed to connect: ${X}`)}});const O=a.querySelector("#offer-input"),I=a.querySelector("#accept-offer"),N=a.querySelector("#answer-output"),ee=a.querySelector("#copy-answer");I.addEventListener("click",async()=>{const R=O.value.trim();if(R){I.disabled=!0,I.textContent="Processing...";try{const X=await n.acceptOffer(R);N.value=X,ee.disabled=!1}catch(X){N.value=`Error: ${X}`}I.disabled=!1,I.textContent="Accept Invite"}}),ee.addEventListener("click",async()=>{await cn(N.value),ee.textContent="Copied!",setTimeout(()=>ee.textContent="Copy to Clipboard",2e3)})}function sn(a,n){const s=a.findByScope(n).find(l=>l.fact[0]==="name");return s?String(s.fact[1]):n.slice(0,8)}function er(a,n){const s=a.findByScope(n).find(h=>h.fact[0]==="parents");if(!s)return[];const l=s.fact[1];return Array.isArray(l)?l:typeof l=="string"?[l]:[]}function tr(a,n){const r=a.findByScope(n),s=[],l=/^(\w+)\((.+)\)$/;for(const h of r){const y=h.fact[0];if(y.match(l)){const C=h.id;let U=y;const E=y.match(/symbol\("([^"]+)"\)/);E&&(U=E[1]),s.push({id:C,key:y,displayName:U})}}return s}function nr(a,n){return{currentScope:n,path:[...a.path,n]}}function rr(a){if(a.path.length<=1)return null;const n=a.path.slice(0,-1);return{currentScope:n[n.length-1],path:n}}function or(a,n){return n<0||n>=a.path.length?a:{currentScope:a.path[n],path:a.path.slice(0,n+1)}}function fr(a,n,r){if(n<=0||n>=a.path.length)return a;const s=[...a.path];return s[n-1]=r,{currentScope:a.currentScope,path:s}}function ar(a){return{currentScope:a,path:[a]}}function cr(a){return typeof a=="object"&&a!==null&&"type"in a&&a.type==="var"}function Sn(a){return typeof a=="object"&&a!==null&&"type"in a&&a.type==="constructor"}function sr(a){return typeof a=="object"&&a!==null&&"type"in a&&a.type==="scope"}function ir(a){return{type:"var",name:a}}function ln(a,...n){return{type:"constructor",name:a,args:n}}function lr(a){return{type:"scope",id:a}}function Cn(a){if(a===null)return"null";if(typeof a=="string")return`"${a}"`;if(typeof a=="number"||typeof a=="boolean")return String(a);if(cr(a))return`?${a.name}`;if(Sn(a)){if(a.args.length===0)return a.name;const n=a.args.map(Cn).join(", ");return`${a.name}(${n})`}return sr(a)?`@${a.id}`:String(a)}class Ie extends Error{constructor(n,r){super(n),this.position=r,this.name="ParseError"}}function dr(a){const n=[];let r=0;for(;r<a.length;){if(/\s/.test(a[r])){r++;continue}if(a[r]==="?"){r++;let s="";for(;r<a.length&&/[\w]/.test(a[r]);)s+=a[r++];if(s.length===0)throw new Ie("Expected variable name after ?",r);n.push({type:"variable",name:s});continue}if(a[r]==="@"){r++;let s="";for(;r<a.length&&/[\w\-]/.test(a[r]);)s+=a[r++];if(s.length===0)throw new Ie("Expected scope id after @",r);n.push({type:"scope",id:s});continue}if(a[r]==='"'||a[r]==="'"){const s=a[r++];let l="";for(;r<a.length&&a[r]!==s;){if(a[r]==="\\"&&r+1<a.length)switch(r++,a[r]){case"n":l+=`
`;break;case"t":l+="	";break;case"\\":l+="\\";break;default:l+=a[r]}else l+=a[r];r++}if(r>=a.length)throw new Ie("Unterminated string",r);r++,n.push({type:"string",value:l});continue}if(/[\d\-]/.test(a[r])){let s="";for(a[r]==="-"&&(s+=a[r++]);r<a.length&&/[\d\.]/.test(a[r]);)s+=a[r++];if(s==="-"||s===".")throw new Ie("Invalid number",r);n.push({type:"number",value:parseFloat(s)});continue}if(a[r]==="("){n.push({type:"lparen"}),r++;continue}if(a[r]===")"){n.push({type:"rparen"}),r++;continue}if(a[r]===","){n.push({type:"comma"}),r++;continue}if(/[a-zA-Z_]/.test(a[r])){let s="";for(;r<a.length&&/[\w]/.test(a[r]);)s+=a[r++];s==="true"?n.push({type:"boolean",value:!0}):s==="false"?n.push({type:"boolean",value:!1}):s==="null"?n.push({type:"null"}):n.push({type:"identifier",value:s});continue}throw new Ie(`Unexpected character: ${a[r]}`,r)}return n}function ur(a){const n=a.trim();if(n.length===0)return"";const r=dr(n);if(r.length===0)return"";let s=0;function l(){return r[s]}function h(){return r[s++]}function y(){const C=l();if(!C)throw new Ie("Unexpected end of input",s);switch(C.type){case"number":return h(),C.value;case"string":return h(),C.value;case"boolean":return h(),C.value;case"null":return h(),null;case"variable":return h(),ir(C.name);case"scope":return h(),lr(C.id);case"identifier":{h();const U=C.value;if(l()?.type==="lparen"){h();const E=[];for(;l()&&l().type!=="rparen";)if(E.push(y()),l()?.type==="comma")h();else if(l()?.type!=="rparen")throw new Ie("Expected , or )",s);if(l()?.type!=="rparen")throw new Ie("Expected )",s);return h(),ln(U,...E)}return ln(U)}default:throw new Ie(`Unexpected token: ${C.type}`,s)}}const S=y();if(s<r.length)throw new Ie("Unexpected tokens after expression",s);return S}function hr(a){try{return ur(a)}catch{return null}}function pr(a){const r=a.trim().match(/^([a-zA-Z_]\w*)\s*\((.*)$/);if(!r)return null;const s=r[1],l=r[2];let h=0,y=0,S=!1,C="";for(const I of l){if(S){I===C&&(S=!1);continue}if(I==='"'||I==="'"){S=!0,C=I;continue}I==="("?y++:I===")"?y--:I===","&&y===0&&h++}const U=l.lastIndexOf(","),O=(U===-1?l:l.slice(U+1)).trim().length>0||l.length===0;return{name:s,argCount:h,inArg:O}}function dn(a,n){const r=a.findByScope(n),s=[];for(const l of r)if(l.fact[0]==="constructor"){const h=l.fact[1];if(typeof h=="object"&&h!==null){const y=h;typeof y.name=="string"&&s.push({name:y.name,params:y.params||[],description:y.description})}else typeof h=="string"&&s.push({name:h,params:[]})}return s}function xr(a,n){const r=a.findByScope(n),s=new Set;for(const l of r)s.add(l.fact[0]);return Array.from(s)}function yr(a,n){const r=a.findByScope(n),s=new Set,l=[];for(const h of r){const y=h.fact[1];if(y!==null){const S=JSON.stringify(y);s.has(S)||(s.add(S),(typeof y=="string"||typeof y=="number"||typeof y=="boolean")&&l.push(y))}}return l}function mr(a,n){const s=a.findByScope(n).find(h=>h.fact[0]==="children");if(!s)return[];const l=s.fact[1];return Array.isArray(l)?l.map(h=>{const S=a.findByScope(h).find(U=>U.fact[0]==="name"),C=S?String(S.fact[1]):h.slice(0,8);return{id:h,name:C}}):[]}function br(a){return rt.find(n=>n.name===a)}function gr(a){const n=a.match(/^(\w+)\(/);if(n)return n[1];if(rt.find(s=>s.name===a&&s.params.length===0))return a}function vr(a,n,r,s){const l=[],h=r.toLowerCase();let y;if(s){const E=br(s);E&&(y=E.allowedChildren)}const S=y!==void 0&&y.length===0,C=xr(a,n);for(const E of C)E.toLowerCase().includes(h)&&l.push({text:E,display:E,type:"key"});if(!S){const E=dn(a,n),O=[...rt,...E],I=new Set;for(const N of O)if(!I.has(N.name)&&(I.add(N.name),!(y!==void 0&&!y.includes(N.name))&&N.name.toLowerCase().includes(h)))if(N.params.length===0)l.push({text:N.name,display:N.name,description:N.description,type:"constructor"});else{const ee=N.params.map(R=>R.name).join(", ");l.push({text:`${N.name}(`,display:`${N.name}(${ee})`,description:N.description,type:"constructor",completion:`${N.name}()`})}}const U=pr(r);if(U){const O=[...rt,...dn(a,n)].find(I=>I.name===U.name);if(O&&U.argCount<O.params.length){const I=O.params[U.argCount];l.push({text:"",display:`${I.name}: ${I.type}`,description:`Argument ${U.argCount+1} of ${O.name}`,type:"constructor"})}}return l}function wr(a,n,r,s){const l=[],h=r.toLowerCase();if(s){const S=a.findByScope(n),C=new Set;for(const U of S)if(U.fact[0]===s){const E=U.fact[1],O=E===null?"null":typeof E=="string"?E:JSON.stringify(E);!C.has(O)&&O.toLowerCase().includes(h)&&(C.add(O),l.push({text:O,display:O,type:"value"}))}}const y=yr(a,n);for(const S of y){const C=typeof S=="string"?S:String(S);C.toLowerCase().includes(h)&&(l.some(E=>E.display===C)||l.push({text:C,display:C,type:"value"}))}if(r.startsWith("@")||r===""){const S=mr(a,n);for(const C of S){const U=`@${C.id}`;U.toLowerCase().includes(h)&&l.push({text:U,display:`@${C.name}`,description:`Scope: ${C.id.slice(0,8)}`,type:"scope"})}}return"true".includes(h)&&l.push({text:"true",display:"true",type:"value"}),"false".includes(h)&&l.push({text:"false",display:"false",type:"value"}),"null".includes(h)&&l.push({text:"null",display:"null",type:"value"}),l}const rt=[{name:"name",params:[],description:"Name attribute",allowedChildren:["string"]},{name:"type",params:[],description:"Type attribute",allowedChildren:["symbol"]},{name:"value",params:[],description:"Value attribute"},{name:"symbol",params:[{name:"name",type:"string"}],description:"Create a symbol",allowedChildren:[]},{name:"eq",params:[{name:"expr",type:"any"}],description:"Equality/binding scope"},{name:"lt",params:[{name:"num",type:"number"}],description:"Less than",allowedChildren:[]},{name:"gt",params:[{name:"num",type:"number"}],description:"Greater than",allowedChildren:[]},{name:"ref",params:[{name:"target",type:"any"}],description:"Reference to scope",allowedChildren:[]},{name:"list",params:[{name:"items",type:"any"}],description:"List of items",allowedChildren:["item","next"]},{name:"peer",params:[{name:"id",type:"string"}],description:"Peer connection",allowedChildren:[]},{name:"group",params:[{name:"name",type:"string"}],description:"Group with synced scope",allowedChildren:["peer","consensus","root"]},{name:"consensus",params:[],description:"Consensus rule (default: unanimous)",allowedChildren:["unanimous","majority","threshold"]},{name:"unanimous",params:[],description:"Require all peers to agree",allowedChildren:[]},{name:"majority",params:[],description:"Require majority to agree",allowedChildren:[]},{name:"threshold",params:[{name:"n",type:"number"}],description:"Require n peers to agree",allowedChildren:[]},{name:"root",params:[],description:"Group root scope (synced data)",allowedChildren:void 0},{name:"string",params:[],description:"String value",allowedChildren:["data","next"],requiredChildren:["data"]},{name:"data",params:[{name:"char",type:"number"}],description:"Character code",allowedChildren:[]},{name:"next",params:[{name:"rest",type:"scope"}],description:"Rest of string/list",allowedChildren:[]},{name:"item",params:[{name:"value",type:"any"}],description:"List item",allowedChildren:[]}];function Tt(a){const n=document.createElement("div");n.className="autocomplete-container";const r=document.createElement("input");r.type="text",r.className="autocomplete-input",r.placeholder=a.placeholder,r.autocomplete="off";const s=document.createElement("div");s.className="autocomplete-dropdown hidden",n.appendChild(r),n.appendChild(s);let l=-1,h=[];function y(){const E=r.getBoundingClientRect();s.style.top=`${E.bottom+2}px`,s.style.left=`${E.left}px`,s.style.width=`${E.width}px`}function S(){const E=r.value;if(a.type==="key"?h=vr(a.store,a.scope,E,a.parentConstructor):h=wr(a.store,a.scope,E,a.forKey),h=h.slice(0,10),h.length===0||h.length===1&&h[0].text===E){s.classList.add("hidden");return}s.innerHTML="",l=-1,y(),h.forEach((O,I)=>{const N=document.createElement("div");N.className="autocomplete-item",N.dataset.index=String(I);const ee=document.createElement("span");if(ee.className="autocomplete-item-text",ee.textContent=O.display,N.appendChild(ee),O.description){const X=document.createElement("span");X.className="autocomplete-item-desc",X.textContent=O.description,N.appendChild(X)}const R=document.createElement("span");R.className=`autocomplete-item-type type-${O.type}`,R.textContent=O.type,N.appendChild(R),N.onclick=()=>U(I),N.onmouseenter=()=>{l=I,C()},s.appendChild(N)}),s.classList.remove("hidden")}function C(){s.querySelectorAll(".autocomplete-item").forEach((O,I)=>{O.classList.toggle("selected",I===l)})}function U(E){if(E<0||E>=h.length)return;const O=h[E],I=O.completion||O.text;r.value=I,s.classList.add("hidden"),I.endsWith("(")&&(r.value=I+")",r.setSelectionRange(I.length,I.length)),a.onSelect?.(r.value),a.onChange?.(r.value)}return r.oninput=()=>{S(),a.onChange?.(r.value)},r.onfocus=()=>{S()},r.onblur=()=>{setTimeout(()=>{s.classList.add("hidden")},200)},r.onkeydown=E=>{if(s.classList.contains("hidden")){E.key==="ArrowDown"&&(S(),E.preventDefault());return}switch(E.key){case"ArrowDown":E.preventDefault(),l=Math.min(l+1,h.length-1),C();break;case"ArrowUp":E.preventDefault(),l=Math.max(l-1,-1),C();break;case"Enter":l>=0&&(E.preventDefault(),U(l));break;case"Escape":s.classList.add("hidden");break;case"Tab":l>=0?U(l):h.length>0&&U(0);break}},n.getValue=()=>r.value,n.setValue=E=>{r.value=E,a.onChange?.(E)},n.clear=()=>{r.value="",a.onChange?.("")},n.focus=()=>r.focus(),n.getInput=()=>r,n}function un(a){return a.getValue?.()||""}function hn(a){a.clear?.()}function Kt(a){a.focus?.()}function pn(a){return a.getInput?.()||null}function Sr(a,n){if(n.path.length<2)return;const r=n.path[n.path.length-2],s=n.currentScope,l=a.findByScope(r);for(const h of l)if(h.id===s)return gr(h.fact[0])}function Cr(a,n){if(n.path.length<2)return{isPeer:!1};const r=n.path[n.path.length-2],s=n.currentScope,l=a.findByScope(r);for(const h of l)if(h.id===s){const S=h.fact[0].match(/^peer\("([^"]+)"\)$/);if(S)return{isPeer:!0,peerId:S[1]}}return{isPeer:!1}}function Ar(a){return typeof a=="string"?`"${a}"`:a===null?"null":String(a)}function Er(a,n,r){const s=document.createElement("div");s.className="scope-navigator";const l=document.createElement("div");l.className="breadcrumbs",n.path.forEach((y,S)=>{const C=document.createElement("div");C.className="breadcrumb";const U=sn(a,y),E=er(a,y),O=S===n.path.length-1;if(S>0&&E.length>1){const N=document.createElement("select");N.className="breadcrumb-dropdown";const ee=n.path[S-1];E.forEach(R=>{const X=document.createElement("option");X.value=R,X.textContent=sn(a,R),X.selected=R===ee,N.appendChild(X)}),N.onchange=()=>{const R=fr(n,S,N.value);r(R)},C.appendChild(N),C.appendChild(document.createTextNode(" / "))}else S>0&&C.appendChild(document.createTextNode(" / "));const I=document.createElement("span");I.className=`breadcrumb-name ${O?"current":"clickable"}`,I.textContent=U,O||(I.onclick=()=>{const N=or(n,S);r(N)}),C.appendChild(I),l.appendChild(C)}),s.appendChild(l);const h=tr(a,n.currentScope);if(h.length>0){const y=document.createElement("div");y.className="navigable-facts";const S=document.createElement("span");S.className="navigable-facts-label",S.textContent="Enter: ",y.appendChild(S),h.forEach(C=>{const U=document.createElement("button");U.className="navigable-fact-btn",U.textContent=C.displayName,U.title=C.key,U.onclick=()=>{const E=nr(n,C.id);r(E)},y.appendChild(U)}),s.appendChild(y)}if(n.path.length>1){const y=document.createElement("button");y.className="scope-up-btn",y.textContent=" Up",y.onclick=()=>{const S=rr(n);S&&r(S)},s.appendChild(y)}return s}function Ut(a){const n=a.trim();return n==="true"?!0:n==="false"?!1:n==="null"?null:/^-?\d+(\.\d+)?$/.test(n)?parseFloat(n):n.startsWith('"')&&n.endsWith('"')||n.startsWith("'")&&n.endsWith("'")?n.slice(1,-1):n}function _r(a,n,r){const s=document.createElement("div"),l=a.findByScope(n);if(l.length===0)return s.innerHTML='<p class="empty-state">No facts in this scope. Add some below.</p>',s;const h=document.createElement("ul");h.className="fact-list";for(const y of l){const S=document.createElement("li");S.className="fact-item";const C=document.createElement("span");C.className="key",C.textContent=y.fact[0];const U=document.createTextNode(": "),E=document.createElement("span");E.className="value editable",E.textContent=Ar(y.fact[1]),E.title="Click to edit",E.onclick=()=>{const O=document.createElement("input");O.type="text",O.className="fact-edit-input",O.value=typeof y.fact[1]=="string"?y.fact[1]:String(y.fact[1]);const I=()=>{const N=Ut(O.value),ee=y.fact;a.retract(ee,n),a.add([ee[0],N],r,n)};O.onblur=I,O.onkeydown=N=>{N.key==="Enter"?I():N.key==="Escape"&&a.add(y.fact,r,y.scope)},E.replaceWith(O),O.focus(),O.select()},S.appendChild(C),S.appendChild(U),S.appendChild(E),h.appendChild(S)}return s.appendChild(h),s}function Ir(a,n,r,s){const l=document.createElement("div");l.className="add-fact-form";let h="";const y=Tt({store:a,scope:n,type:"key",placeholder:"key (e.g., name, eq(x))",parentConstructor:s,onChange:I=>{h=I}}),S=Tt({store:a,scope:n,type:"value",placeholder:"value",forKey:h}),C=document.createElement("button");C.id="add-fact-btn",C.textContent="Add";const U=()=>{const I=un(y).trim(),N=un(S).trim();if(!I)return;const ee=hr(I),R=ee!==null&&Sn(ee)?Cn(ee):I;let X=N;N==="true"?X=!0:N==="false"?X=!1:N==="null"?X=null:/^-?\d+(\.\d+)?$/.test(N)&&(X=parseFloat(N)),a.add([R,X],r,n),hn(y),hn(S),Kt(y)};C.onclick=U;const E=pn(S);if(E){const I=E.onkeydown;E.onkeydown=N=>{N.key==="Enter"&&!N.defaultPrevented&&S.querySelector(".autocomplete-dropdown")?.classList.contains("hidden")&&(U(),N.preventDefault()),I?.call(E,N)}}const O=pn(y);if(O){const I=O.onkeydown;O.onkeydown=N=>{N.key==="Tab"&&!N.shiftKey&&y.querySelector(".autocomplete-dropdown")?.classList.contains("hidden")&&(N.preventDefault(),Kt(S)),I?.call(O,N)}}return l.appendChild(y),l.appendChild(S),l.appendChild(C),l}function Br(a,n){const r=document.createElement("div");r.className="query-builder";const s=document.createElement("h4");s.textContent="Query",r.appendChild(s);const l=document.createElement("div");l.className="query-pattern";const h={key:{type:"any",value:""},value:{type:"any",value:""}},y=document.createElement("div");y.className="query-results empty",y.textContent="Enter a pattern to query";const S=document.createElement("div");S.className="query-preview";const C=document.createElement("code");C.className="pattern-text",S.appendChild(C);function U(){const I=h.key.type==="any"?"?key":h.key.value||"?key",N=h.value.type==="any"?"?val":h.value.value||"?val";C.textContent=`[${I}, ${N}]`}function E(){try{const I=h.key.type==="any"?an("key"):Ut(h.key.value),N=h.value.type==="any"?an("val"):Ut(h.value.value),R=Wn(a,[[I,N]],{scope:n});R.length===0?(y.className="query-results empty",y.textContent="No matches"):(y.className="query-results",y.innerHTML=R.map(X=>`<div class="result-row">${JSON.stringify(Xn(X))}</div>`).join(""))}catch(I){y.className="query-results empty",y.textContent=`Error: ${I}`}}function O(I,N,ee){const R=document.createElement("div");R.className="pattern-slot";const X=document.createElement("label");X.textContent=N,R.appendChild(X);const pe=document.createElement("div");pe.className="slot-options";const se=document.createElement("button");se.className="slot-btn active",se.textContent=`Any (?${I[0]})`,se.dataset.type="any";const be=document.createElement("button");be.className="slot-btn",be.textContent="Specific",be.dataset.type="specific",pe.appendChild(se),pe.appendChild(be),R.appendChild(pe);const ve=Tt({store:a,scope:n,type:ee,placeholder:I,onChange:ge=>{h[I].value=ge,U(),E()}});return ve.classList.add("hidden"),R.appendChild(ve),[se,be].forEach(ge=>{ge.onclick=()=>{se.classList.toggle("active",ge===se),be.classList.toggle("active",ge===be),h[I].type=ge.dataset.type,ge.dataset.type==="specific"?(ve.classList.remove("hidden"),Kt(ve)):ve.classList.add("hidden"),U(),E()}}),R}return l.appendChild(O("key","Key","key")),l.appendChild(O("value","Value","value")),r.appendChild(l),r.appendChild(S),r.appendChild(y),U(),E(),r}function Nr(a,n,r){const s=n.findByScope(a).find(l=>l.fact[0]==="name");return s?String(s.fact[1]):r}function Lr(a,n,r){const s=document.createElement("div");s.className="actor-switcher";const l=n.getActors();s.innerHTML=`
    <div class="actor-switcher-row">
      <select class="actor-select">
        ${l.map(se=>`<option value="${se.id}" ${se.id===a?"selected":""}>${Nr(se.id,r,se.name)}</option>`).join("")}
      </select>
      <button class="actor-btn" title="New Actor">+</button>
      <button class="actor-btn" title="Import Actor">Import</button>
      <button class="actor-btn" title="Export Actor">Export</button>
      <button class="actor-btn actor-btn-danger" title="Delete Actor">Delete</button>
    </div>
    <div class="actor-import-row hidden">
      <input type="text" class="actor-import-input" placeholder="Paste actor data..." />
      <button class="actor-import-btn">Import</button>
      <button class="actor-import-cancel">Cancel</button>
    </div>
    <div class="actor-export-row hidden">
      <textarea class="actor-export-output" readonly></textarea>
      <button class="actor-export-copy">Copy</button>
      <button class="actor-export-close">Close</button>
    </div>
  `;const h=s.querySelector(".actor-select"),y=s.querySelectorAll(".actor-btn")[0],S=s.querySelectorAll(".actor-btn")[1],C=s.querySelectorAll(".actor-btn")[2],U=s.querySelectorAll(".actor-btn")[3],E=s.querySelector(".actor-import-row"),O=s.querySelector(".actor-import-input"),I=s.querySelector(".actor-import-btn"),N=s.querySelector(".actor-import-cancel"),ee=s.querySelector(".actor-export-row"),R=s.querySelector(".actor-export-output"),X=s.querySelector(".actor-export-copy"),pe=s.querySelector(".actor-export-close");return h.onchange=()=>{n.onSwitchActor(h.value)},y.onclick=()=>{const se=prompt("Enter a name for the new actor:",`Actor ${new Date().toLocaleString()}`);se!==null&&n.onCreateActor(se||void 0)},S.onclick=()=>{E.classList.remove("hidden"),O.focus()},N.onclick=()=>{E.classList.add("hidden"),O.value=""},I.onclick=()=>{const se=O.value.trim();if(!se)return;n.onImportActor(se)?(E.classList.add("hidden"),O.value=""):alert("Invalid actor data")},C.onclick=()=>{const se=n.onExportActor(a);se&&(R.value=se,ee.classList.remove("hidden"))},X.onclick=async()=>{await navigator.clipboard.writeText(R.value),X.textContent="Copied!",setTimeout(()=>X.textContent="Copy",2e3)},pe.onclick=()=>{ee.classList.add("hidden"),R.value=""},U.onclick=()=>{if(l.length<=1){alert("Cannot delete the last actor");return}confirm("Are you sure you want to delete this actor?")&&n.onDeleteActor(a)},s}function at(a,n,r){const{identity:s,store:l,mesh:h}=n;let y=n.navigation||ar(s.nodeId);function S(U){y=U,C()}function C(){const U=h.getPeerCount(),E=y.currentScope,O=l.findByScope(E);a.innerHTML="";const I=document.createElement("div");I.className="header";const N=document.createElement("div");N.className="header-info",N.innerHTML=`
      <div class="node-id">Node: ${s.nodeId}</div>
      <div class="peer-count ${U>0?"connected":""}">
        ${U} peer${U!==1?"s":""} connected
      </div>
    `,I.appendChild(N),I.appendChild(Lr(s.nodeId,r,l)),a.appendChild(I);const ee=document.createElement("div");ee.className="section",ee.innerHTML=`
      <div class="section-header">
        <h2>Scope</h2>
      </div>
    `;const R=document.createElement("div");R.className="section-content",R.appendChild(Er(l,y,S)),ee.appendChild(R),a.appendChild(ee);const X=Sr(l,y),pe=document.createElement("div");pe.className="section",pe.innerHTML=`
      <div class="section-header">
        <h2>Facts</h2>
        <span>${O.length} in scope${X?` (${X} context)`:""}</span>
      </div>
    `;const se=document.createElement("div");se.className="section-content",se.appendChild(_r(l,E,s.nodeId)),se.appendChild(Ir(l,E,s.nodeId,X)),pe.appendChild(se),a.appendChild(pe);const be=document.createElement("div");be.className="section",be.innerHTML=`
      <div class="section-header">
        <h2>Query</h2>
      </div>
    `;const ve=document.createElement("div");ve.className="section-content",ve.appendChild(Br(l,E)),be.appendChild(ve),a.appendChild(be);const ge=Cr(l,y);if(ge.isPeer){const Ce=document.createElement("div");Ce.className="section",Ce.innerHTML=`
        <div class="section-header">
          <h2>Peer Connection</h2>
          <span>peer(${ge.peerId?.slice(0,8)}...)</span>
        </div>
      `;const Te=document.createElement("div");Te.className="section-content",Qn(Te,h),Ce.appendChild(Te),a.appendChild(Ce)}}C(),l.onAdd(()=>C()),h.onChange(()=>C())}let Se=null;function ct(a){const n=new zn,r=new Jn(a,n);return{identity:a,store:n,mesh:r}}function ze(a){const n=Yn(a);if(!n)return!1;Se=ct(n),ht(n,Se.store),console.log("Switched to Node ID:",n.nodeId);const r=document.getElementById("app");return r&&at(r,Se,{onSwitchActor:ze,onCreateActor:st,onImportActor:it,onExportActor:lt,onDeleteActor:dt,onRenameActor:ut,getActors:Pe,getCurrentActorId:ft}),!0}function st(a){const n=wn(a);Se=ct(n),ht(n,Se.store);const r=document.getElementById("app");return r&&at(r,Se,{onSwitchActor:ze,onCreateActor:st,onImportActor:it,onExportActor:lt,onDeleteActor:dt,onRenameActor:ut,getActors:Pe,getCurrentActorId:ft}),n}function it(a){const n=Vn(a);if(!n)return null;Se=ct(n),ht(n,Se.store);const r=document.getElementById("app");return r&&at(r,Se,{onSwitchActor:ze,onCreateActor:st,onImportActor:it,onExportActor:lt,onDeleteActor:dt,onRenameActor:ut,getActors:Pe,getCurrentActorId:ft}),n}function lt(a){return kn(a)}function dt(a){if(Pe().length<=1)return alert("Cannot delete the last actor"),!1;if(Dn(a),Se?.identity.nodeId===a){const r=Pe();r.length>0&&ze(r[0].id)}return!0}function ut(a,n){Rn(a,n)}function ht(a,n){if(!n.findByScope(a.nodeId).find(s=>s.fact[0]==="name")){const l=Pe().find(h=>h.id===a.nodeId)?.name||a.nodeId;n.add(["name",l],a.nodeId,a.nodeId)}}function Mr(){const a=Fn();console.log("Node ID:",a.nodeId),Se=ct(a),ht(a,Se.store),at(document.getElementById("app"),Se,{onSwitchActor:ze,onCreateActor:st,onImportActor:it,onExportActor:lt,onDeleteActor:dt,onRenameActor:ut,getActors:Pe,getCurrentActorId:ft})}Mr();
